<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‚õ≤ Fuente y Portal√≥n</title>
  <link rel="stylesheet" href="styles/style.css"/>
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg"/>
  <style>
    /* Estilos generales */
    body {
      font-family: Arial, sans-serif;
      background: url('images/fondo.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container {
      max-width: 960px;
      margin: auto;
      background: rgba(255,248,228,0.95);
      border: 3px double #5e3b1b;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
    }
    header h1 { text-align: center; }
    .action-btn {
      display: inline-block;
      margin: 5px auto;
      padding: 10px 20px;
      font-size: 16px;
      background: #dec79b;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .music-control { text-align: center; margin-bottom: 10px; }
    #content { margin-top: 10px; }
    /* Ubicaci√≥n */
    #location-check {
      text-align: center;
      margin-bottom: 30px;
    }
    #location-check input {
      padding: 8px;
      font-size: 16px;
      width: 200px;
      margin: 10px;
      border: 1px solid #5e3b1b;
      border-radius: 4px;
    }
    #location-status { margin-top: 10px; font-size: 1.1em; color: red; }
    #direction-arrow { width: 50px; margin-top: 10px; }
    /* Carrusel */
    .carousel {
      position: relative;
      overflow: hidden;
      margin-bottom: 20px;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
    }
    .carousel-slides { display: flex; transition: transform 0.5s ease; }
    .slide { min-width: 100%; box-sizing: border-box; text-align: center; }
    .slide img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #6e3b1b;
    }
    .carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.7);
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
    }
    .prev-slide { left: 10px; }
    .next-slide { right: 10px; }
    /* Secciones Visuales y Quiz */
    .visual-challenge, .quiz { margin: 20px 0; }
    /* Minijuego 1: Puzzle de Tuber√≠as */
    #puzzle-tuberias {
      display: none;
      margin: 20px auto;
      padding: 15px;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      background: #f9f1e6;
    }
    #puzzle-tuberias h2 { text-align: center; }
    #puzzle-tuberias p.hint {
      text-align: center;
      font-style: italic;
      color: #555;
    }
    /* Usamos una cuadr√≠cula de 3 filas x 4 columnas.
       En las filas 0 y 1, la celda de la columna 3 se deja vac√≠a. */
    #puzzle-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px;
    }
    .puzzle-row { display: flex; }
    .pipe-piece {
      width: 80px;
      height: 80px;
      margin: 3px;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      transition: transform 0.3s;
      border: 2px solid #5e3b1b;
      border-radius: 5px;
    }
    /* Clase para indicar que la pieza est√° en la orientaci√≥n correcta */
    .pipe-piece.correct {
      border-color: green;
      box-shadow: 0 0 8px green;
    }
    /* Minijuego 2: Puzzle de C√°ntaros - Visual y Medieval */
    #puzzle-cantaros {
      display: none;
      margin: 20px auto;
      padding: 15px;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      background: #f9f1e6;
    }
    #puzzle-cantaros h2 { text-align: center; }
    #cantaros-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
    }
    .jug {
      text-align: center;
    }
    .jug-label { font-weight: bold; margin-bottom: 5px; }
    .jug-container {
      width: 100px;
      height: 150px;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      background-color: #faf0e6;
      position: relative;
      overflow: hidden;
      margin: 0 auto;
    }
    .jug-water {
      position: absolute;
      bottom: 0;
      width: 100%;
      background-color: #4d90fe;
      transition: height 0.5s ease;
    }
    /* Fragmento Final */
    .fragmento-final {
      margin: 20px auto;
      display: none;
      text-align: center;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      padding: 40px 20px;
      font-style: italic;
      font-size: 1.2em;
      font-weight: bold;
      border-radius: 10px;
    }
    #continue-button { text-align: center; margin-top: 15px; display: none; }
    footer p { text-align: center; font-size: 0.9em; margin-top: 20px; }
    @media screen and (max-width: 768px) {
      .container { max-width: 90%; }
      .pipe-piece { width: 60px; height: 60px; }
      .jug-container { width: 80px; height: 120px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>‚õ≤ Fuente y Portal√≥n</h1>
      <div class="music-control">
        <button class="action-btn music-btn">
          <span class="music-icon">üéµ</span> Pausar M√∫sica
        </button>
      </div>
    </header>

    <section id="content">
      <div class="stop-icon">‚õ≤</div>

      <!-- Verificaci√≥n de Ubicaci√≥n -->
      <div id="location-check">
        <h2>Verifica tu ubicaci√≥n</h2>
        <p>Ac√©rcate a la fuente y al portal√≥n para continuar.</p>
        <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
        <p>O escribe el nombre:</p>
        <input type="text" id="location-input" placeholder="Ej: Fuente y Portal√≥n"/>
        <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
        <p id="location-status"></p>
        <img id="direction-arrow" src="images/flecha.png" class="arrow-icon" style="display:none;" alt="Flecha de direcci√≥n"/>
      </div>

      <!-- Contenido principal (se muestra tras validaci√≥n) -->
      <div id="game-content" style="display:none;">
        <!-- Carrusel -->
        <div class="carousel">
          <div class="carousel-slides">
            <div class="slide active">
              <img src="images/portalon.jpg" alt="Portal√≥n" />
              <p>
                <strong>Portal√≥n:</strong> Lugar renacentista de reuni√≥n y comercio. 
                A√∫n conserva inscripciones originales.
                <a href="https://sanmartindelcasta√±ar.es/plaza-mayor-y-portalon/" target="_blank">M√°s info</a>
              </p>
            </div>
            <div class="slide">
              <img src="images/fuente-detalle.jpg" alt="Fuente" />
              <p><strong>Fuente:</strong> De dos ca√±os con decoraci√≥n geom√©trica, construida en el siglo XVI.</p>
            </div>
          </div>
          <button class="carousel-btn prev-slide">‚Üê</button>
          <button class="carousel-btn next-slide">‚Üí</button>
        </div>

        <!-- Retos Visuales y Quiz -->
        <div class="visual-challenge">
          <h2>Retos Visuales</h2>
          <p>1. ¬øCu√°ntos ca√±os tiene la fuente?</p>
          <div id="visual-opciones-1">
            <button class="action-btn" onclick="checkVisualAnswer('Un ca√±o','Dos ca√±os',1)">Un ca√±o</button>
            <button class="action-btn" onclick="checkVisualAnswer('Dos ca√±os','Dos ca√±os',1)">Dos ca√±os</button>
            <button class="action-btn" onclick="checkVisualAnswer('Tres ca√±os','Dos ca√±os',1)">Tres ca√±os</button>
          </div>
          <p id="visual-resultado-1"></p>
          <p>2. ¬øQu√© decora los ca√±os?</p>
          <div id="visual-opciones-2">
            <button class="action-btn" onclick="checkVisualAnswer('Flores','Geom√©tricos',2)">Flores</button>
            <button class="action-btn" onclick="checkVisualAnswer('Geom√©tricos','Geom√©tricos',2)">Geom√©tricos</button>
            <button class="action-btn" onclick="checkVisualAnswer('Animales','Geom√©tricos',2)">Animales</button>
          </div>
          <p id="visual-resultado-2"></p>
        </div>

        <div class="quiz">
          <h2>Quiz Hist√≥rico</h2>
          <p>1. ¬øEn qu√© siglo se construy√≥ esta fuente?</p>
          <div id="quiz-opciones-1">
            <button class="action-btn" onclick="checkAnswer('XV','XVI',1)">XV</button>
            <button class="action-btn" onclick="checkAnswer('XVI','XVI',1)">XVI</button>
            <button class="action-btn" onclick="checkAnswer('XVII','XVI',1)">XVII</button>
          </div>
          <p id="quiz-resultado-1"></p>
          <p>2. ¬øQu√© estilo es la fuente?</p>
          <div id="quiz-opciones-2">
            <button class="action-btn" onclick="checkAnswer('Renacentista','Renacentista',2)">Renacentista</button>
            <button class="action-btn" onclick="checkAnswer('G√≥tico','Renacentista',2)">G√≥tico</button>
            <button class="action-btn" onclick="checkAnswer('Barroco','Renacentista',2)">Barroco</button>
          </div>
          <p id="quiz-resultado-2"></p>
          <p>3. ¬øQu√© r√≠o pasa cerca?</p>
          <div id="quiz-opciones-3">
            <button class="action-btn" onclick="checkAnswer('Canderuelo','Canderuelo',3)">Canderuelo</button>
            <button class="action-btn" onclick="checkAnswer('Francia','Canderuelo',3)">Francia</button>
            <button class="action-btn" onclick="checkAnswer('Tormes','Canderuelo',3)">Tormes</button>
          </div>
          <p id="quiz-resultado-3"></p>
        </div>

        <!-- Minijuego 1: Puzzle de Tuber√≠as (m√°s jugable y ambientado) -->
        <div id="puzzle-tuberias">
          <h2>Puzzle de Tuber√≠as</h2>
          <p>
            Haz girar cada pieza para alinear el flujo del agua en la fila inferior.<br>
            <span class="hint">Pista: El agua entra en el extremo izquierdo y debe llegar al extremo derecho de la fila inferior.</span>
          </p>
          <div id="puzzle-container"></div>
          <div style="text-align:center;">
            <button class="action-btn" onclick="checkTuberias()">Comprobar Tuber√≠as</button>
          </div>
          <p id="puzzle-tuberias-resultado" style="text-align:center; color:green; font-weight:bold;"></p>
        </div>

        <!-- Minijuego 2: Puzzle de C√°ntaros (m√°s visual y ambientado) -->
        <div id="puzzle-cantaros">
          <h2>Puzzle de C√°ntaros</h2>
          <p>
            Con la astucia de un alquimista medieval, mide exactamente 4 litros usando un c√°ntaro de 5L y otro de 3L.
          </p>
          <div id="cantaros-container">
            <div class="jug">
              <div class="jug-label">C√°ntaro A (5L)</div>
              <div class="jug-container" id="jug-a-container">
                <div class="jug-water" id="jug-a-water" style="height: 0%;"></div>
              </div>
              <div>Cantidad: <span id="a-actual">0</span> L</div>
            </div>
            <div class="jug">
              <div class="jug-label">C√°ntaro B (3L)</div>
              <div class="jug-container" id="jug-b-container">
                <div class="jug-water" id="jug-b-water" style="height: 0%;"></div>
              </div>
              <div>Cantidad: <span id="b-actual">0</span> L</div>
            </div>
          </div>
          <div style="text-align: center; margin-top: 10px;">
            <button class="action-btn" onclick="fillA()">Llenar A</button>
            <button class="action-btn" onclick="fillB()">Llenar B</button>
            <button class="action-btn" onclick="emptyA()">Vaciar A</button>
            <button class="action-btn" onclick="emptyB()">Vaciar B</button>
            <br>
            <button class="action-btn" onclick="pourAtoB()">Verter A ‚Üí B</button>
            <button class="action-btn" onclick="pourBtoA()">Verter B ‚Üí A</button>
          </div>
          <p id="puzzle-cantaros-resultado" style="text-align:center; color:green; font-weight:bold;"></p>
        </div>

        <!-- Fragmento Final -->
        <div class="fragmento-final" id="fragmento-final">
          <p><strong>Fragmento del Mensaje:</strong> <span id="message-piece" style="font-size:1.4em">bodega</span></p>
          <p><strong>QR en el pueblo:</strong> FUENTE-1600</p>
          <p><strong>Dato Curioso:</strong> Durante siglos, los vecinos se reun√≠an aqu√≠ a debatir decisiones del consejo.</p>
        </div>

        <div id="continue-button">
          <button class="action-btn" onclick="location.href='felicitaciones.html?stop=fuente'">Continuar b√∫squeda</button>
        </div>
      </div>
    </section>

    <!-- Audios -->
    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
    <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
    <audio id="coins-sound" src="sounds/coins.mp3" preload="auto"></audio>
    <audio id="cheers-sound" src="sounds/cheers.mp3" preload="auto"></audio>
    <audio id="background-music" src="sounds/musica-medieval.mp3" preload="auto" loop></audio>

    <footer>
      <p>¬© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a></p>
    </footer>

    <script>
      /*----------------------------------------*/
      /* 1. VERIFICACI√ìN DE UBICACI√ìN           */
      /*----------------------------------------*/
      const targetLat = 40.123456;
      const targetLon = -3.123456;
      const thresholdDistance = 50;
      function checkLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(geoSuccess, locationError);
        } else {
          document.getElementById("location-status").textContent = "Tu navegador no soporta geolocalizaci√≥n.";
        }
      }
      function geoSuccess(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const distance = calculateDistance(lat, lon, targetLat, targetLon);
        if (distance <= thresholdDistance) {
          unlockStop();
        } else {
          document.getElementById("location-status").textContent = "No est√°s lo suficientemente cerca de la Fuente y Portal√≥n.";
        }
      }
      function locationError(err) {
        document.getElementById("location-status").textContent = "Error al obtener tu ubicaci√≥n: " + err.message;
      }
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const toRad = (x) => x * Math.PI / 180;
        const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
        const ŒîœÜ = toRad(lat2 - lat1), ŒîŒª = toRad(lon2 - lon1);
        const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }
      function checkLocationManual() {
        const input = document.getElementById("location-input").value.trim().toLowerCase();
        if (input === "fuente" || input === "fuente y portal√≥n" || input === "fuente y portalon") {
          unlockStop();
        } else {
          document.getElementById("location-status").textContent = "Nombre incorrecto. Int√©ntalo nuevamente.";
        }
      }
      function unlockStop() {
        document.getElementById("location-check").style.display = "none";
        document.getElementById("game-content").style.display = "block";
        initCarousel();
        initTuberiasPuzzle();
        playSound("background-music");
      }

      /*----------------------------------------*/
      /* 2. CARRUSEL                            */
      /*----------------------------------------*/
      let currentSlide = 0, slides;
      function initCarousel() {
        slides = document.querySelectorAll('.slide');
        document.querySelector('.prev-slide').addEventListener('click', () => {
          currentSlide = (currentSlide > 0) ? currentSlide - 1 : slides.length - 1;
          updateCarousel();
        });
        document.querySelector('.next-slide').addEventListener('click', () => {
          currentSlide = (currentSlide < slides.length - 1) ? currentSlide + 1 : 0;
          updateCarousel();
        });
      }
      function updateCarousel() {
        const carouselSlides = document.querySelector('.carousel-slides');
        carouselSlides.style.transform = 'translateX(' + (-currentSlide * 100) + '%)';
      }

      /*----------------------------------------*/
      /* 3. RETOS VISUALES Y QUIZ              */
      /*----------------------------------------*/
      function checkVisualAnswer(selected, correct, n) {
        const result = document.getElementById('visual-resultado-' + n);
        if (selected === correct) {
          result.textContent = "¬°Correcto!";
          playSound("success-sound");
        } else {
          result.textContent = "Respuesta incorrecta...";
          playSound("error-sound");
        }
      }
      function checkAnswer(selected, correct, n) {
        const result = document.getElementById('quiz-resultado-' + n);
        if (selected === correct) {
          result.textContent = "¬°Correcto!";
          playSound("success-sound");
        } else {
          result.textContent = "Incorrecto. Vuelve a intentarlo.";
          playSound("error-sound");
        }
      }

      /*----------------------------------------*/
      /* 4. MINIJUEGO 1: PUZZLE DE TUBER√çAS     */
      /*----------------------------------------*/
      // Cuadr√≠cula de 3 filas x 4 columnas. En filas 0 y 1, la columna 3 se deja vac√≠a.
      const puzzleRows = 3, puzzleCols = 4;
      const pipeTypes = ["pipe-straight", "pipe-curve", "pipe-t", "pipe-cross"];
      let puzzlePieces = [];
      const pipeImages = {
        "pipe-straight": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3QgeD0iMTAiIHk9IjM1IiB3aWR0aD0iNjAiIGhlaWdodD0iMTAiIHJ4PSI1IiByeT0iNSIgZmlsbD0iI2NjYyIgc3Ryb2tlPSIjNWUzYjFiIiBzdHJva2Utd2lkdGg9IjIiIC8+Cjwvc3ZnPg==",
        "pipe-curve": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHBhdGggZD0iTTExMCw0MCBBMzAsMzAgMCAwLDAsNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzVlM2IxYiIgc3Ryb2tlLXdpZHRoPSI4IiBzdHJva2UtbGluZWNhcD0icm91bmQiIC8+Cjwvc3ZnPg==",
        "pipe-t": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3QgeD0iMzUiIHk9IjEwIiB3aWR0aD0iMTAiIGhlaWdodD0iNjAiIHJ4PSIyIiByeT0iMiIgZmlsbD0iI2NjYyIgc3Ryb2tlPSIjNWUzYjFiIiBzdHJva2Utd2lkdGg9IjIiIC8+CiAgPHJlY3QgeD0iMTUiIHk9IjMwIiB3aWR0aD0iNTAiIGhlaWdodD0iMTAiIHJ4PSIyIiByeT0iMiIgZmlsbD0iI2NjYyIgc3Ryb2tlPSIjNWUzYjFiIiBzdHJva2Utd2lkdGg9IjIiIC8+Cjwvc3ZnPg==",
        "pipe-cross": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3QgeD0iMzUiIHk9IjEwIiB3aWR0aD0iMTAiIGhlaWdodD0iNjAiIHJ4PSIyIiByeT0iMiIgZmlsbD0iI2NjYyIgc3Ryb2tlPSIjNWUzYjFiIiBzdHJva2Utd2lkdGg9IjIiIC8+CiAgPHJlY3QgeD0iMTUiIHk9IjM1IiB3aWR0aD0iNTAiIGhlaWdodD0iMTAiIHJ4PSIyIiByeT0iMiIgZmlsbD0iI2NjYyIgc3Ryb2tlPSIjNWUzYjFiIiBzdHJva2Utd2lkdGg9IjIiIC8+Cjwvc3ZnPg=="
      };

      function initTuberiasPuzzle() {
        document.getElementById("puzzle-tuberias").style.display = "block";
        const puzzleCont = document.getElementById("puzzle-container");
        puzzleCont.innerHTML = "";
        puzzlePieces = [];
        // Recorremos filas (0 a 2) y columnas (0 a 3)
        for (let r = 0; r < puzzleRows; r++) {
          const rowDiv = document.createElement("div");
          rowDiv.classList.add("puzzle-row");
          for (let c = 0; c < puzzleCols; c++) {
            // En filas 0 y 1, dejamos vac√≠a la √∫ltima columna (col 3)
            if (r < 2 && c === puzzleCols - 1) {
              const emptyCell = document.createElement("div");
              emptyCell.style.width = "80px";
              emptyCell.style.height = "80px";
              emptyCell.style.margin = "3px";
              rowDiv.appendChild(emptyCell);
              continue;
            }
            const piece = document.createElement("div");
            piece.classList.add("pipe-piece");
            // Asigna un tipo aleatorio
            const randomType = pipeTypes[Math.floor(Math.random() * pipeTypes.length)];
            piece.dataset.type = randomType;
            piece.style.backgroundImage = `url('${pipeImages[randomType]}')`;
            // Define un √°ngulo de soluci√≥n aleatorio para esta pieza
            const possibleRotations = [0, 90, 180, 270];
            const solutionRot = possibleRotations[Math.floor(Math.random() * possibleRotations.length)];
            piece.dataset.solution = solutionRot;
            // Para hacer el reto m√°s interesante, iniciamos con un √°ngulo distinto a la soluci√≥n.
            let initialRot = solutionRot;
            while(initialRot === solutionRot) {
              initialRot = possibleRotations[Math.floor(Math.random() * possibleRotations.length)];
            }
            piece.dataset.rotation = initialRot;
            piece.style.transform = `rotate(${initialRot}deg)`;
            // Al hacer clic, gira 90¬∞ y comprueba si alcanza la soluci√≥n.
            piece.addEventListener("click", () => {
              const currentRot = parseInt(piece.dataset.rotation);
              const newRot = (currentRot + 90) % 360;
              piece.dataset.rotation = newRot;
              piece.style.transform = `rotate(${newRot}deg)`;
              // Si alcanza la soluci√≥n, a√±ade una clase visual
              if(newRot === parseInt(piece.dataset.solution)) {
                piece.classList.add("correct");
              } else {
                piece.classList.remove("correct");
              }
            });
            rowDiv.appendChild(piece);
            puzzlePieces.push({ row: r, col: c, element: piece });
          }
          puzzleCont.appendChild(rowDiv);
        }
      }

      // Funci√≥n que verifica la fila inferior (fila 2)
      function checkTuberias() {
        const puzzleResult = document.getElementById("puzzle-tuberias-resultado");
        // Filtrar las piezas correspondientes a la fila 2
        const row2Pieces = puzzlePieces.filter(p => p.row === 2);
        row2Pieces.sort((a, b) => a.col - b.col);
        let valid = true;
        // Verificar que cada pieza en la fila 2 est√© en su rotaci√≥n soluci√≥n
        for (let i = 0; i < row2Pieces.length; i++) {
          const currRot = parseInt(row2Pieces[i].element.dataset.rotation);
          const solRot = parseInt(row2Pieces[i].element.dataset.solution);
          if (currRot !== solRot) {
            valid = false;
            break;
          }
          // Adem√°s, comprobamos conexiones entre celdas:
          // Para la primera celda, se exige conexi√≥n a la derecha; para la √∫ltima, a la izquierda; y en intermedias, ambas.
          const conns = getConnections(row2Pieces[i].element);
          if(i === 0 && !conns.right) { valid = false; break; }
          if(i === row2Pieces.length - 1 && !conns.left) { valid = false; break; }
          if(i > 0 && i < row2Pieces.length - 1 && (!conns.left || !conns.right)) { valid = false; break; }
          if(i < row2Pieces.length - 1) {
            const nextConns = getConnections(row2Pieces[i+1].element);
            if(!conns.right || !nextConns.left) {
              valid = false;
              break;
            }
          }
        }
        if(valid) {
          puzzleResult.textContent = "¬°Tuber√≠as conectadas correctamente!";
          playSound("coins-sound");
          document.getElementById("puzzle-tuberias").style.display = "none";
          initCantarosPuzzle();
        } else {
          puzzleResult.textContent = "La conexi√≥n en la fila inferior no es correcta. Revisa las piezas.";
          playSound("error-sound");
        }
      }

      // Funci√≥n que, seg√∫n el tipo y la rotaci√≥n actual, devuelve las conexiones (simplificado)
      function getConnections(piece) {
        const type = piece.dataset.type;
        const rot = parseInt(piece.dataset.rotation) % 360;
        let conns = { top: false, right: false, bottom: false, left: false };
        if (type === "pipe-straight") {
          // Horizontal en 0 y 180; vertical en 90 y 270.
          if (rot === 0 || rot === 180) {
            conns.left = true;
            conns.right = true;
          } else {
            conns.top = true;
            conns.bottom = true;
          }
        } else if (type === "pipe-curve") {
          if(rot === 0) { conns.top = true; conns.right = true; }
          else if(rot === 90) { conns.right = true; conns.bottom = true; }
          else if(rot === 180) { conns.bottom = true; conns.left = true; }
          else if(rot === 270) { conns.left = true; conns.top = true; }
        } else if (type === "pipe-t") {
          if(rot === 0) { conns.top = true; conns.left = true; conns.right = true; }
          else if(rot === 90) { conns.top = true; conns.right = true; conns.bottom = true; }
          else if(rot === 180) { conns.right = true; conns.bottom = true; conns.left = true; }
          else if(rot === 270) { conns.bottom = true; conns.left = true; conns.top = true; }
        } else if (type === "pipe-cross") {
          conns.top = conns.right = conns.bottom = conns.left = true;
        }
        return conns;
      }

      /*----------------------------------------*/
      /* 5. MINIJUEGO 2: PUZZLE DE C√ÅNTAROS     */
      /*----------------------------------------*/
      let aCap = 5, bCap = 3;
      let aCur = 0, bCur = 0;
      let puzzleCantarosCompleted = false;
      function initCantarosPuzzle() {
        document.getElementById("puzzle-cantaros").style.display = "block";
        updateJugsDisplay();
      }
      function updateJugsDisplay() {
        document.getElementById("a-actual").textContent = aCur;
        document.getElementById("b-actual").textContent = bCur;
        document.getElementById("jug-a-water").style.height = (aCur / aCap * 100) + "%";
        document.getElementById("jug-b-water").style.height = (bCur / bCap * 100) + "%";
      }
      function fillA() { aCur = aCap; checkCantaros(); }
      function fillB() { bCur = bCap; checkCantaros(); }
      function emptyA() { aCur = 0; checkCantaros(); }
      function emptyB() { bCur = 0; checkCantaros(); }
      function pourAtoB() {
        const spaceInB = bCap - bCur;
        if (aCur <= spaceInB) { bCur += aCur; aCur = 0; }
        else { aCur -= spaceInB; bCur = bCap; }
        checkCantaros();
      }
      function pourBtoA() {
        const spaceInA = aCap - aCur;
        if (bCur <= spaceInA) { aCur += bCur; bCur = 0; }
        else { bCur -= spaceInA; aCur = aCap; }
        checkCantaros();
      }
      function checkCantaros() {
        updateJugsDisplay();
        const puzzleCantarosResultado = document.getElementById("puzzle-cantaros-resultado");
        if (aCur === 4 || bCur === 4) {
          puzzleCantarosResultado.textContent = "¬°Has logrado los 4 litros, excelente!";
          playSound("coins-sound");
          unlockFinalFragment();
        } else {
          puzzleCantarosResultado.textContent = "";
        }
      }

      /*----------------------------------------*/
      /* 6. FRAGMENTO FINAL / CONTINUAR         */
      /*----------------------------------------*/
      function unlockFinalFragment() {
        if (!puzzleCantarosCompleted) {
          puzzleCantarosCompleted = true;
          document.getElementById("fragmento-final").style.display = "block";
          document.getElementById("continue-button").style.display = "block";
          playSound("cheers-sound");
        }
      }

      /*----------------------------------------*/
      /* 7. SONIDOS                             */
      /*----------------------------------------*/
      function playSound(id) {
        const sound = document.getElementById(id);
        if (sound) sound.play();
      }

      /*----------------------------------------*/
      /* 8. LOCALSTORAGE                        */
      /*----------------------------------------*/
      localStorage.setItem("fuente-completed", "true");
    </script>
  </div>
</body>
</html>
