<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚õ≤ Fuente y Portal√≥n</title>
  <!-- Fuente medieval de Google para un toque especial -->
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/style.css">
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg">
  <style>
    /* ============================
         ESTILOS GENERALES (copiados de ermita.css)
       ============================ */
    body {
      font-family: "Georgia", serif;
      background: #f8f0e3;
      color: #3b2f2f;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    
    .container {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    
    header h1 {
      font-size: 32px;
      margin-bottom: 10px;
      color: #4a2c2a;
    }
    
    .music-control {
      margin: 10px 0;
    }
    
    .music-btn {
      font-size: 16px;
      padding: 8px 16px;
      border: none;
      background: #8b4513;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .music-btn:hover {
      background: #a0522d;
    }
    
    /* ============================
         UBICACI√ìN
       ============================ */
    #location-check {
      text-align: center;
      margin-bottom: 30px;
    }
    
    #location-check h2 {
      margin-bottom: 10px;
    }
    
    #location-check p {
      margin: 10px 0;
    }
    
    #location-input {
      padding: 8px;
      font-size: 16px;
      width: 200px;
      margin-bottom: 10px;
      border: 1px solid #5e3b1b;
      border-radius: 4px;
    }
    
    #location-status {
      margin-top: 10px;
      font-size: 1.1em;
      color: red;
    }
    
    #direction-arrow {
      width: 60px;
      height: 60px;
      margin: 15px auto;
      display: none;
      transition: transform 0.3s ease;
    }
    
    /* ============================
         CARRUSEL
       ============================ */
    .carousel-container {
      position: relative;
      max-width: 100%;
      margin: 20px auto;
      overflow: hidden;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
    }
    
    .carousel-slides {
      display: flex;
      transition: transform 0.5s ease-in-out;
    }
    
    .slide {
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      flex: 0 0 100%;
      box-sizing: border-box;
      padding: 10px;
      text-align: center;
    }
    
    .slide.active {
      display: block;
      opacity: 1;
    }
    
    /* Importante: forzamos que todas las im√°genes se muestren completas,
       igual que en la parada del Castillo */
    .slide img {
      width: 100% !important;
      height: 300px !important;
      object-fit: contain !important;
      background-color: #fff !important;
      border-radius: 10px !important;
      border: 2px solid #6b3e2e !important;
      display: block;
    }
    
    /* Bloque de Caption */
    .carousel-info {
      margin-top: 10px;
      line-height: 1.4;
      background: rgba(255, 255, 255, 0.8);
      padding: 8px;
      border-radius: 8px;
      text-align: left;
    }
    
    .carousel-info a {
      color: #5e3b1b;
      text-decoration: underline;
    }
    
    .carousel-info a:hover {
      color: #a65c3a;
    }
    
    .carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      font-size: 28px;
      cursor: pointer;
      padding: 10px;
      z-index: 2;
    }
    
    .prev-slide {
      left: 10px;
    }
    
    .next-slide {
      right: 10px;
    }
    
    /* ============================
         OTROS ESTILOS (RESTANTE)
       ============================ */
    ol {
      text-align: left;
      margin: 0 auto;
      max-width: 700px;
      padding-left: 20px;
    }
    
    .button-group {
      margin-top: 30px;
    }
    
    .action-btn {
      background: #6b3e2e;
      color: #fff;
      padding: 14px 24px;
      margin: 10px;
      border: none;
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .action-btn:hover {
      background: #8b4513;
    }
    
    .map-container img {
      max-width: 100%;
      height: auto;
      margin-bottom: 10px;
    }
    
    .buttons-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    
    .map-btn {
      font-size: 16px;
      padding: 12px 18px;
      background: #4a2c2a;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .map-btn:hover {
      background: #7b4b39;
    }
    
    .progress-container {
      margin: 20px auto;
      max-width: 600px;
      text-align: center;
    }
    
    .progress-bar {
      width: 100%;
      background: #ddd;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #6b3e2e;
      width: 0%;
      transition: width 0.5s ease;
    }
    
    .qr-section input {
      padding: 10px;
      font-size: 16px;
      width: 60%;
      max-width: 300px;
      margin-bottom: 10px;
    }
    
    .qr-section button {
      margin-top: 5px;
    }
    
    #direction-arrow {
      width: 60px;
      height: 60px;
      margin: 15px auto;
      display: none;
      transition: transform 0.3s ease;
    }
    
    .visual-challenge,
    .quiz,
    .fragmento-final {
      margin-top: 30px;
      text-align: left;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    
    footer {
      margin-top: 40px;
      font-size: 14px;
      color: #555;
    }
    
    footer a {
      color: #8b4513;
      text-decoration: none;
    }
    
    footer a:hover {
      text-decoration: underline;
    }
    
    @media screen and (max-width: 768px) {
      ol {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Cabecera -->
    <header>
      <h1>‚õ≤ Fuente y Portal√≥n</h1>
      <div class="music-control">
        <button class="action-btn music-btn">
          <span class="music-icon">üéµ</span> Pausar M√∫sica
        </button>
      </div>
    </header>
    
    <!-- Verificaci√≥n de Ubicaci√≥n -->
    <section id="location-check">
      <h2>Verifica tu ubicaci√≥n</h2>
      <p>Ac√©rcate a la fuente y al portal√≥n para continuar.</p>
      <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
      <p>O escribe el nombre:</p>
      <input type="text" id="location-input" placeholder="Ej: Fuente y Portal√≥n">
      <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
      <p id="location-status"></p>
      <img id="direction-arrow" src="images/flecha.png" alt="Flecha de direcci√≥n">
    </section>
    
    <!-- Contenido del Juego -->
    <section id="game-content" style="display: none;">
      <!-- Carrusel -->
      <div class="carousel-container">
        <div class="carousel-slides">
          <div class="slide active">
            <img src="images/portalon.jpg" alt="Portal√≥n">
            <div class="carousel-info">
              <strong>Portal√≥n:</strong> Lugar renacentista de reuni√≥n y comercio. A√∫n conserva inscripciones originales.
              <a href="https://sanmartindelcasta√±ar.es/plaza-mayor-y-portalon/" target="_blank">M√°s info</a>
            </div>
          </div>
          <div class="slide">
            <img src="images/fuente-detalle.jpg" alt="Fuente">
            <div class="carousel-info">
              <strong>Fuente:</strong> De dos ca√±os con decoraci√≥n geom√©trica, construida en el siglo XVI.
              <a href="https://turismosierradefrancia.es/nuestros-pueblos/san-martin-del-castanar/" target="_blank">M√°s info</a>
            </div>
          </div>
          <div class="slide">
            <img src="images/portalon-interior.jpg" alt="Portal√≥n interior">
            <div class="carousel-info">
              <strong>Interior:</strong> Perspectiva del portal√≥n y sus detalles, evocando tiempos pasados.
              <a href="https://es.wikipedia.org/wiki/San_Mart%C3%ADn_del_Casta%C3%B1ar" target="_blank">M√°s info</a>
            </div>
          </div>
        </div>
        <button class="carousel-btn prev-slide" onclick="prevSlide()">&#10094;</button>
        <button class="carousel-btn next-slide" onclick="nextSlide()">&#10095;</button>
      </div>
      
      <!-- Resto de contenido (Retos Visuales, Quiz, etc.) -->
      <div class="visual-challenge">
        <h2>Retos Visuales</h2>
        <p>1. ¬øCu√°ntos ca√±os tiene la fuente?</p>
        <div id="visual-opciones-1">
          <button class="action-btn" onclick="checkVisualAnswer('Un ca√±o','Dos ca√±os',1)">Un ca√±o</button>
          <button class="action-btn" onclick="checkVisualAnswer('Dos ca√±os','Dos ca√±os',1)">Dos ca√±os</button>
          <button class="action-btn" onclick="checkVisualAnswer('Tres ca√±os','Dos ca√±os',1)">Tres ca√±os</button>
        </div>
        <p id="visual-resultado-1"></p>
        <p>2. ¬øQu√© decora los ca√±os?</p>
        <div id="visual-opciones-2">
          <button class="action-btn" onclick="checkVisualAnswer('Flores','Geom√©tricos',2)">Flores</button>
          <button class="action-btn" onclick="checkVisualAnswer('Geom√©tricos','Geom√©tricos',2)">Geom√©tricos</button>
          <button class="action-btn" onclick="checkVisualAnswer('Animales','Geom√©tricos',2)">Animales</button>
        </div>
        <p id="visual-resultado-2"></p>
      </div>
      
      <div class="quiz">
        <h2>Quiz Hist√≥rico</h2>
        <p>1. ¬øEn qu√© siglo se construy√≥ esta fuente?</p>
        <div id="quiz-opciones-1">
          <button class="action-btn" onclick="checkAnswer('XV','XVI',1)">XV</button>
          <button class="action-btn" onclick="checkAnswer('XVI','XVI',1)">XVI</button>
          <button class="action-btn" onclick="checkAnswer('XVII','XVI',1)">XVII</button>
        </div>
        <p id="quiz-resultado-1"></p>
        <p>2. ¬øQu√© estilo es la fuente?</p>
        <div id="quiz-opciones-2">
          <button class="action-btn" onclick="checkAnswer('Renacentista','Renacentista',2)">Renacentista</button>
          <button class="action-btn" onclick="checkAnswer('G√≥tico','Renacentista',2)">G√≥tico</button>
          <button class="action-btn" onclick="checkAnswer('Barroco','Renacentista',2)">Barroco</button>
        </div>
        <p id="quiz-resultado-2"></p>
        <p>3. ¬øQu√© r√≠o pasa cerca?</p>
        <div id="quiz-opciones-3">
          <button class="action-btn" onclick="checkAnswer('Canderuelo','Canderuelo',3)">Canderuelo</button>
          <button class="action-btn" onclick="checkAnswer('Francia','Canderuelo',3)">Francia</button>
          <button class="action-btn" onclick="checkAnswer('Tormes','Canderuelo',3)">Tormes</button>
        </div>
        <p id="quiz-resultado-3"></p>
      </div>
      
      <!-- Puzzle de C√°ntaros -->
      <div id="puzzle-cantaros" style="display:none;">
        <div class="content-box">
          <h2>Puzzle de C√°ntaros</h2>
          <p>Con la astucia de un alquimista medieval, mide exactamente 4 litros usando un c√°ntaro de 5L y otro de 3L.</p>
        </div>
        <div id="cantaros-container">
          <div class="jug">
            <div class="jug-label"><strong>C√°ntaro A (5L)</strong></div>
            <div class="jug-container" id="jug-a-container">
              <div class="jug-water" id="jug-a-water" style="height: 0%;"></div>
            </div>
            <div><strong>Cantidad: <span id="a-actual">0</span> L</strong></div>
          </div>
          <div class="jug">
            <div class="jug-label"><strong>C√°ntaro B (3L)</strong></div>
            <div class="jug-container" id="jug-b-container">
              <div class="jug-water" id="jug-b-water" style="height: 0%;"></div>
            </div>
            <div><strong>Cantidad: <span id="b-actual">0</span> L</strong></div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 10px; position: relative; z-index: 1;">
          <button class="action-btn" onclick="fillA()">Llenar A</button>
          <button class="action-btn" onclick="fillB()">Llenar B</button>
          <button class="action-btn" onclick="emptyA()">Vaciar A</button>
          <button class="action-btn" onclick="emptyB()">Vaciar B</button>
          <br>
          <button class="action-btn" onclick="pourAtoB()">Verter A ‚Üí B</button>
          <button class="action-btn" onclick="pourBtoA()">Verter B ‚Üí A</button>
        </div>
        <p id="puzzle-cantaros-resultado" style="text-align: center; color: green; font-weight: bold; position: relative; z-index: 1;"></p>
      </div>
      
      <!-- Fragmento Final -->
      <div class="fragmento-final" id="fragmento-final">
        <p>
          <strong>Fragmento del Mensaje:</strong>
          <span id="message-piece" style="font-size:1.4em">bodega</span>
        </p>
        <p><strong>QR en el pueblo:</strong> FUENTE-1600</p>
        <p><strong>Dato Curioso:</strong> Durante siglos, los vecinos se reun√≠an aqu√≠ a debatir decisiones del consejo.</p>
      </div>
      
      <div id="continue-button">
        <button class="action-btn" onclick="location.href='felicitaciones.html?stop=fuente'">
          Continuar b√∫squeda
        </button>
      </div>
    </section>
    
    <footer>
      <p>
        ¬© 2025 La Bodega Medieval | 
        <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a>
      </p>
    </footer>
    
    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
    <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
    <audio id="coins-sound" src="sounds/coins.mp3" preload="auto"></audio>
    <audio id="cheers-sound" src="sounds/cheers.mp3" preload="auto"></audio>
    <audio id="background-music" src="sounds/musica-medieval.mp3" preload="auto" loop></audio>
    
    <script>
      /* ============================
           1. VERIFICACI√ìN DE UBICACI√ìN
       ============================ */
      const targetLat = 40.123456, targetLon = -3.123456, thresholdDistance = 50;
      function checkLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(geoSuccess, locationError);
        } else {
          document.getElementById("location-status").textContent = "Tu navegador no soporta geolocalizaci√≥n.";
        }
      }
      function geoSuccess(position) {
        const lat = position.coords.latitude, lon = position.coords.longitude;
        const distance = calculateDistance(lat, lon, targetLat, targetLon);
        if (distance <= thresholdDistance) { unlockStop(); }
        else { document.getElementById("location-status").textContent = "No est√°s lo suficientemente cerca de la Fuente y Portal√≥n."; }
      }
      function locationError(err) {
        document.getElementById("location-status").textContent = "Error al obtener tu ubicaci√≥n: " + err.message;
      }
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const toRad = x => x * Math.PI / 180;
        const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
        const ŒîœÜ = toRad(lat2 - lat1), ŒîŒª = toRad(lon2 - lon1);
        const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }
      function checkLocationManual() {
        const input = document.getElementById("location-input").value.trim().toLowerCase();
        if (input === "fuente" || input === "fuente y portal√≥n" || input === "fuente y portalon") { unlockStop(); }
        else { document.getElementById("location-status").textContent = "Nombre incorrecto. Int√©ntalo nuevamente."; }
      }
      function unlockStop() {
        document.getElementById("location-check").style.display = "none";
        document.getElementById("game-content").style.display = "block";
        initCarousel();
        playSound("background-music");
      }
      
      /* ============================
           2. CARRUSEL
       ============================ */
      let currentSlide = 0, slides;
      function initCarousel() {
        slides = document.querySelectorAll('.slide');
        document.querySelector('.prev-slide').addEventListener('click', prevSlide);
        document.querySelector('.next-slide').addEventListener('click', nextSlide);
      }
      function updateCarousel() {
        const carouselSlides = document.querySelector('.carousel-slides');
        carouselSlides.style.transform = 'translateX(' + (-currentSlide * 100) + '%)';
      }
      function nextSlide() {
        currentSlide = (currentSlide < slides.length - 1) ? currentSlide + 1 : 0;
        updateCarousel();
      }
      function prevSlide() {
        currentSlide = (currentSlide > 0) ? currentSlide - 1 : slides.length - 1;
        updateCarousel();
      }
      
      /* ============================
           3. RETOS VISUALES Y QUIZ
       ============================ */
      let quiz1Correct = false, quiz2Correct = false, quiz3Correct = false;
      function checkVisualAnswer(selected, correct, n) {
        const result = document.getElementById('visual-resultado-' + n);
        if (selected === correct) {
          result.textContent = "¬°Correcto!";
          playSound("success-sound");
        } else {
          result.textContent = "Respuesta incorrecta...";
          playSound("error-sound");
        }
      }
      function checkAnswer(selected, correct, n) {
        const result = document.getElementById('quiz-resultado-' + n);
        if (selected === correct) {
          result.textContent = "¬°Correcto!";
          playSound("success-sound");
          if(n === 1) quiz1Correct = true;
          if(n === 2) quiz2Correct = true;
          if(n === 3) quiz3Correct = true;
        } else {
          result.textContent = "Incorrecto. Vuelve a intentarlo.";
          playSound("error-sound");
          if(n === 1) quiz1Correct = false;
          if(n === 2) quiz2Correct = false;
          if(n === 3) quiz3Correct = false;
        }
        if (quiz1Correct && quiz2Correct && quiz3Correct) {
          document.querySelector('.quiz').style.display = "none";
          initCantarosPuzzle();
        }
      }
      
      /* ============================
           4. PUZZLE DE C√ÅNTAROS
       ============================ */
      let aCap = 5, bCap = 3;
      let aCur = 0, bCur = 0;
      let puzzleCantarosCompleted = false;
      function initCantarosPuzzle() {
        document.getElementById("puzzle-cantaros").style.display = "block";
        updateJugsDisplay();
      }
      function updateJugsDisplay() {
        document.getElementById("a-actual").textContent = aCur;
        document.getElementById("b-actual").textContent = bCur;
        document.getElementById("jug-a-water").style.height = (aCur / aCap * 100) + "%";
        document.getElementById("jug-b-water").style.height = (bCur / bCap * 100) + "%";
      }
      function fillA() { aCur = aCap; checkCantaros(); }
      function fillB() { bCur = bCap; checkCantaros(); }
      function emptyA() { aCur = 0; checkCantaros(); }
      function emptyB() { bCur = 0; checkCantaros(); }
      function pourAtoB() {
        const spaceInB = bCap - bCur;
        if(aCur <= spaceInB) { bCur += aCur; aCur = 0; }
        else { aCur -= spaceInB; bCur = bCap; }
        checkCantaros();
      }
      function pourBtoA() {
        const spaceInA = aCap - aCur;
        if(bCur <= spaceInA) { aCur += bCur; bCur = 0; }
        else { bCur -= spaceInA; aCur = aCap; }
        checkCantaros();
      }
      function checkCantaros() {
        updateJugsDisplay();
        const puzzleCantarosResultado = document.getElementById("puzzle-cantaros-resultado");
        if(aCur === 4 || bCur === 4) {
          puzzleCantarosResultado.textContent = "¬°Has logrado los 4 litros, excelente!";
          playSound("coins-sound");
          unlockFinalFragment();
        } else {
          puzzleCantarosResultado.textContent = "";
        }
      }
      
      /* ============================
           5. FRAGMENTO FINAL
       ============================ */
      function unlockFinalFragment() {
        if (!puzzleCantarosCompleted) {
          puzzleCantarosCompleted = true;
          document.getElementById("fragmento-final").style.display = "block";
          document.getElementById("continue-button").style.display = "block";
          updateChronicle();
          updateRanking();
          playSound("cheers-sound");
        }
      }
      function updateChronicle() {
        localStorage.setItem("cronica_fuente", document.getElementById("message-piece").textContent);
      }
      function updateRanking() {
        let ranking = JSON.parse(localStorage.getItem("ranking")) || [];
        ranking.push({ stop: "fuente", score: 100 });
        localStorage.setItem("ranking", JSON.stringify(ranking));
      }
      
      /* ============================
           6. AUDIOS Y M√öSICA
       ============================ */
      function playSound(id) {
        const sound = document.getElementById(id);
        if (sound) sound.play();
      }
      document.addEventListener('DOMContentLoaded', () => {
        const musicBtn = document.querySelector('.music-btn');
        const backgroundMusic = document.getElementById('background-music');
        musicBtn.addEventListener('click', () => {
          if (backgroundMusic.paused) {
            backgroundMusic.play();
            musicBtn.innerHTML = '<span class="music-icon">üéµ</span> Pausar M√∫sica';
          } else {
            backgroundMusic.pause();
            musicBtn.innerHTML = '<span class="music-icon">üîá</span> Reproducir M√∫sica';
          }
        });
      });
      
      /* ============================
           7. LOCALSTORAGE
       ============================ */
      localStorage.setItem("fuente-completed", "true");
    </script>
  </div>
</body>
</html>
