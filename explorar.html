<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ—ºï¸ğŸ§­ Explora San MartÃ­n del CastaÃ±ar</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      background: url('images/pergamino.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Georgia', serif;
      color: #3b241b;
      padding: 0;
      margin: 0;
    }

    .container {
      max-width: 850px;
      margin: auto;
      background: rgba(255, 248, 228, 0.95);
      border: 3px solid #5a3b2b;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      position: relative;
    }

    header, .progress-container, .map-description, .qr-section, .button-group, footer {
      transition: opacity 0.3s ease;
    }

    #map {
      height: 400px;
      width: 100%;
      border: 3px solid #8b5e3c;
      border-radius: 10px;
      position: relative;
    }

    .compass-container {
      display: flex;
      justify-content: flex-end;
      padding-top: 10px;
    }

    #compass {
      width: 48px;
      height: 48px;
      transform: rotate(0deg);
      transition: transform 0.5s linear;
      border: 2px solid black;
      border-radius: 50%;
      padding: 4px;
      background: white;
    }

    .marker-emoji {
      font-size: 36px;
      transition: transform 0.2s ease;
      filter: drop-shadow(0 0 2px #000);
      user-select: none;
    }

    .marker-emoji.clicked {
      transform: scale(1.4);
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin: 20px 0;
    }

    .button-row a {
      background: rgba(255, 248, 228, 0.85);
      border: 2px solid #8b5e3c;
      border-radius: 12px;
      padding: 10px 16px;
      text-decoration: none;
      font-size: 18px;
      font-weight: bold;
      color: #3b241b;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      backdrop-filter: blur(2px);
    }

    footer {
      text-align: center;
      font-style: italic;
      font-size: 14px;
      margin-top: 40px;
    }
  </style>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-GE0YB9PL8Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-GE0YB9PL8Q');
  </script>
</head>
<body>
  <!-- CÃ³digo original creado por Alex RomÃ¡n | Abril 2025 -->
  <!-- Marca registrada digitalmente por @alexroman.leis -->

  <div class="container" id="main-container">
    <header>
      <h1 data-i18n="pageTitle">ğŸ§™â€â™‚ï¸ğŸ” Busca el Mensaje Oculto de Gonzalo</h1>
    </header>

    <div class="progress-container">
      <div class="progress-bar" style="background: #ddd; border-radius: 10px; height: 20px; width: 80%; margin: auto;">
        <div class="progress-fill" id="progress-fill" style="background: #c19a6b; height: 100%; width: 0%;"></div>
      </div>
      <p id="progress-text" data-i18n="progressText">Paradas completadas: 0/7</p>

      <div class="button-row">
        <a href="index.html" data-i18n="btnHome">ğŸ  Inicio</a>
        <a href="guia.html" data-i18n="btnGuide">ğŸ“– GuÃ­a</a>
        <a href="ranking.html" data-i18n="btnRanking">ğŸ“Š Ranking</a>
        <a href="cronica.html" data-i18n="btnChronicle">ğŸ“œ CrÃ³nica</a>
      </div>
    </div>

    <!-- ExplicaciÃ³n del juego -->
    <div class="game-explanation">
      <h2 data-i18n="explicacion_titulo">â„¹ï¸ Â¿CÃ³mo funciona este juego?</h2>
      <p data-i18n="explicacion_1">Este mapa muestra las distintas paradas del recorrido por San MartÃ­n del CastaÃ±ar. En cada parada te espera una prueba o enigma que deberÃ¡s resolver para desbloquear fragmentos del mensaje oculto de Gonzalo.</p>
      <p data-i18n="explicacion_2">Pulsa sobre los iconos del mapa para acceder a cada prueba. Algunas paradas se desbloquean al avanzar en el juego. Usa la brÃºjula para orientarte y sigue tu progreso con la barra de arriba.</p>
    </div>

    <div class="map-container">
      <div id="map"></div>
      <p id="map-description">Mapa interactivo de <a href="https://www.openstreetmap.org/#map=17/40.5222/-6.0645" target="_blank">San MartÃ­n del CastaÃ±ar</a></p>
    </div>
    <div class="compass-container">
      <img src="images/flecha.png" id="compass" alt="BrÃºjula" />
    </div>
  </div>

  <footer>
    <p id="footer-text">Â© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a></p>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Traducciones
    const translations = {
      es: {
        pageTitle: "ğŸ§™â€â™‚ï¸ğŸ” Busca el Mensaje Oculto de Gonzalo",
        progressText: (done, total) => `Paradas completadas: ${done}/${total}`,
        btnHome: "ğŸ  Inicio",
        btnGuide: "ğŸ“– GuÃ­a",
        btnRanking: "ğŸ“Š Ranking",
        btnChronicle: "ğŸ“œ CrÃ³nica",
        mapDescriptionHTML: 'Mapa interactivo de <a href="https://www.openstreetmap.org/#map=17/40.5222/-6.0645" target="_blank">San MartÃ­n del CastaÃ±ar</a>',
        altCompass: "BrÃºjula",
        footerHTML: 'Â© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a>',
        userHere: "ğŸ“Œ EstÃ¡s aquÃ­",
        btnGo: "Ir a la parada",
        explicacion_titulo: "â„¹ï¸ Â¿CÃ³mo funciona este juego?",
        explicacion_1: "Este mapa muestra las distintas paradas del recorrido por San MartÃ­n del CastaÃ±ar. En cada parada te espera una prueba o enigma que deberÃ¡s resolver para desbloquear fragmentos del mensaje oculto de Gonzalo.",
        explicacion_2: "Pulsa sobre los iconos del mapa para acceder a cada prueba. Algunas paradas se desbloquean al avanzar en el juego. Usa la brÃºjula para orientarte y sigue tu progreso con la barra de arriba.",
        stops: {
          castillo: "Castillo",
          plaza: "Plaza de toros",
          iglesia: "Iglesia",
          fuente: "Fuente y PortalÃ³n",
          ermita: "Ermita",
          puente: "Puente",
          bodega: "Bodega"
        }
      },
      en: {
        pageTitle: "ğŸ§™â€â™‚ï¸ğŸ” Find Gonzaloâ€™s Hidden Message",
        progressText: (done, total) => `Stops completed: ${done}/${total}`,
        btnHome: "ğŸ  Home",
        btnGuide: "ğŸ“– Guide",
        btnRanking: "ğŸ“Š Ranking",
        btnChronicle: "ğŸ“œ Chronicle",
        mapDescriptionHTML: 'Interactive map of <a href="https://www.openstreetmap.org/#map=17/40.5222/-6.0645" target="_blank">San MartÃ­n del CastaÃ±ar</a>',
        altCompass: "Compass",
        footerHTML: 'Â© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserve your visit</a>',
        userHere: "ğŸ“Œ You are here",
        btnGo: "Go to stop",
        explicacion_titulo: "â„¹ï¸ How does this game work?",
        explicacion_1: "This map shows the different stops on the tour of San MartÃ­n del CastaÃ±ar. At each stop you will face a challenge or puzzle that you must solve to unlock fragments of Gonzalo's hidden message.",
        explicacion_2: "Click on the map icons to access each challenge. Some stops unlock as you progress in the game. Use the compass to orient yourself and track your progress with the bar above.",
        stops: {
          castillo: "Castle",
          plaza: "Bullring",
          iglesia: "Church",
          fuente: "Fountain and PortalÃ³n",
          ermita: "Hermitage",
          puente: "Bridge",
          bodega: "Winery"
        }
      },
      fr: {
        pageTitle: "ğŸ§™â€â™‚ï¸ğŸ” Trouvez le message cachÃ© de Gonzalo",
        progressText: (done, total) => `Ã‰tapes complÃ©tÃ©esÂ : ${done}/${total}`,
        btnHome: "ğŸ  Accueil",
        btnGuide: "ğŸ“– Guide",
        btnRanking: "ğŸ“Š Classement",
        btnChronicle: "ğŸ“œ Chronique",
        mapDescriptionHTML: 'Carte interactive de <a href="https://www.openstreetmap.org/#map=17/40.5222/-6.0645" target="_blank">San MartÃ­n del CastaÃ±ar</a>',
        altCompass: "Boussole",
        footerHTML: 'Â© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">RÃ©servez votre visite</a>',
        userHere: "ğŸ“Œ Vous Ãªtes ici",
        btnGo: "Aller Ã  la station",
        explicacion_titulo: "â„¹ï¸ Comment fonctionne ce jeuâ€¯?",
        explicacion_1: "Cette carte montre les diffÃ©rentes Ã©tapes du parcours Ã  San MartÃ­n del CastaÃ±ar. Ã€ chaque Ã©tape, vous trouverez une Ã©preuve ou une Ã©nigme que vous devrez rÃ©soudre pour dÃ©bloquer des fragments du message cachÃ© de Gonzalo.",
        explicacion_2: "Cliquez sur les icÃ´nes de la carte pour accÃ©der Ã  chaque Ã©preuve. Certaines Ã©tapes se dÃ©bloquent au fur et Ã  mesure que vous avancez dans le jeu. Utilisez la boussole pour vous orienter et suivez votre progression avec la barre en haut.",
        stops: {
          castillo: "ChÃ¢teau",
          plaza: "ArÃ¨ne",
          iglesia: "Ã‰glise",
          fuente: "Fontaine et PortalÃ³n",
          ermita: "Ermitage",
          puente: "Pont",
          bodega: "Cave"
        }
      },
      de: {
        pageTitle: "ğŸ§™â€â™‚ï¸ğŸ” Finde Gonzalos versteckte Nachricht",
        progressText: (done, total) => `Stationen abgeschlossen: ${done}/${total}`,
        btnHome: "ğŸ  Startseite",
        btnGuide: "ğŸ“– Anleitung",
        btnRanking: "ğŸ“Š Rangliste",
        btnChronicle: "ğŸ“œ Chronik",
        mapDescriptionHTML: 'Interaktive Karte von <a href="https://www.openstreetmap.org/#map=17/40.5222/-6.0645" target="_blank">San MartÃ­n del CastaÃ±ar</a>',
        altCompass: "Kompass",
        footerHTML: 'Â© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reservieren Sie Ihren Besuch</a>',
        userHere: "ğŸ“Œ Du bist hier",
        btnGo: "Zur Station gehen",
        explicacion_titulo: "â„¹ï¸ Wie funktioniert dieses Spiel?",
        explicacion_1: "Diese Karte zeigt die verschiedenen Stationen des Rundgangs durch San MartÃ­n del CastaÃ±ar. An jeder Station erwartet dich eine Aufgabe oder ein RÃ¤tsel, das du lÃ¶sen musst, um Fragmente von Gonzalos versteckter Nachricht freizuschalten.",
        explicacion_2: "Klicke auf die Symbole in der Karte, um jede Aufgabe zu Ã¶ffnen. Einige Stationen werden freigeschaltet, wenn du im Spiel vorankommst. Verwende den Kompass zur Orientierung und verfolge deinen Fortschritt mit der Leiste oben.",
        stops: {
          castillo: "Burg",
          plaza: "Stierkampfarena",
          iglesia: "Kirche",
          fuente: "Brunnen und PortalÃ³n",
          ermita: "Einsiedelei",
          puente: "BrÃ¼cke",
          bodega: "Weinkeller"
        }
      }
    };

    const lang = localStorage.getItem('idioma') || 'es';

    // CÃ¡lculo de progreso:
    const mainStops = ["castillo", "plaza", "iglesia", "fuente", "ermita", "puente"];
    const allStops = [...mainStops, "bodega"];
    let completadas = 0;

    allStops.forEach(stop => {
      if (localStorage.getItem(`${stop}-completed`) === "true") completadas++;
    });
    const bodegaDesbloqueada = mainStops.every(stop => localStorage.getItem(`${stop}-completed`) === "true");

    document.getElementById("progress-fill").style.width = `${(completadas / allStops.length) * 100}%`;

    // Map y marcadores:
    const map = L.map("map").setView([40.522236, -6.064579], 17);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
    }).addTo(map);

    const stopNamesDict = translations[lang].stops;
    const popupGo = translations[lang].btnGo;
    const userHere = translations[lang].userHere;

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const coords = [position.coords.latitude, position.coords.longitude];
        L.marker(coords).addTo(map).bindPopup(userHere).openPopup();
        L.circle(coords, {
          radius: 15,
          color: "black",
          fillColor: "#30f",
          fillOpacity: 0.3
        }).addTo(map);
      });
    }

    const paradas = [
      { id: "castillo", nombre: "Castillo", coords: [40.520537, -6.063549], icono: "ğŸ°", archivo: "castillo.html" },
      { id: "plaza", nombre: "Plaza de toros", coords: [40.520685, -6.063465], icono: "ğŸŸï¸", archivo: "plaza.html" },
      { id: "iglesia", nombre: "Iglesia", coords: [40.521341, -6.063827], icono: "â›ª", archivo: "iglesia.html" },
      { id: "fuente", nombre: "Fuente y PortalÃ³n", coords: [40.522182, -6.064559], icono: "â›²", archivo: "fuente.html" },
      { id: "ermita", nombre: "Ermita", coords: [40.522765, -6.066472], icono: "ğŸ™", archivo: "ermita.html" },
      { id: "puente", nombre: "Puente", coords: [40.522526, -6.065782], icono: "ğŸŒ‰", archivo: "puente.html" },
      { id: "bodega", nombre: "Bodega", coords: [40.521674, -6.064408], icono: "ğŸ·", archivo: "bodega.html" }
    ];

    paradas.forEach(parada => {
      const completed = localStorage.getItem(`${parada.id}-completed`) === "true";
      if (parada.id === "bodega" && !bodegaDesbloqueada) return;
      const iconoFinal = completed ? `âœ…${parada.icono}` : parada.icono;
      const markerEl = document.createElement("div");
      markerEl.className = "marker-emoji";
      markerEl.textContent = iconoFinal;
      markerEl.addEventListener("click", () => {
        markerEl.classList.add("clicked");
        setTimeout(() => markerEl.classList.remove("clicked"), 300);
      });
      const customIcon = L.divIcon({ className: "", html: markerEl.outerHTML, iconSize: [40, 40], iconAnchor: [20, 20] });
      const nameTranslated = stopNamesDict[parada.id];
      const marker = L.marker(parada.coords, { icon: customIcon }).addTo(map);
      marker.bindPopup(`<strong>${iconoFinal} ${nameTranslated}</strong><br><button onclick="location.href='${parada.archivo}'">${popupGo}</button>`);
      marker.on("click", () => map.setView(parada.coords, 18));
    });

    // BrÃºjula:
    const compass = document.getElementById("compass");
    function handleOrientation(event) {
      const alpha = event.alpha;
      if (typeof alpha === "number") {
        compass.style.transform = `rotate(${alpha}deg)`;
      }
    }
    function initOrientation() {
      if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
        DeviceOrientationEvent.requestPermission()
          .then(state => { if (state === "granted") window.addEventListener("deviceorientation", handleOrientation, true); })
          .catch(console.error);
      } else {
        window.addEventListener("deviceorientation", handleOrientation, true);
      }
    }
    window.addEventListener("click", initOrientation, { once: true });

    // Aplicar traducciones:
    function translatePage() {
      document.documentElement.lang = lang;
      document.querySelector('[data-i18n="pageTitle"]').textContent = translations[lang].pageTitle;
      document.querySelector('[data-i18n="btnHome"]').textContent = translations[lang].btnHome;
      document.querySelector('[data-i18n="btnGuide"]').textContent = translations[lang].btnGuide;
      document.querySelector('[data-i18n="btnRanking"]').textContent = translations[lang].btnRanking;
      document.querySelector('[data-i18n="btnChronicle"]').textContent = translations[lang].btnChronicle;
      document.getElementById('progress-text').textContent = translations[lang].progressText(completadas, allStops.length);
      document.getElementById('map-description').innerHTML = translations[lang].mapDescriptionHTML;
      document.getElementById('compass').alt = translations[lang].altCompass;
      document.getElementById('footer-text').innerHTML = translations[lang].footerHTML;
      document.querySelector('[data-i18n="explicacion_titulo"]').textContent = translations[lang].explicacion_titulo;
      document.querySelector('[data-i18n="explicacion_1"]').textContent = translations[lang].explicacion_1;
      document.querySelector('[data-i18n="explicacion_2"]').textContent = translations[lang].explicacion_2;
    }
    translatePage();
  </script>
</body>
</html>
