<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üó∫Ô∏è Explora San Mart√≠n del Casta√±ar</title>
  <link rel="stylesheet" href="styles/style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg" />
  <style>
    body {
      background: url('images/pergamino.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Georgia', serif;
      color: #3b241b;
      padding: 20px;
    }

    .container {
      max-width: 850px;
      margin: auto;
      background: rgba(255, 248, 228, 0.95);
      border: 3px solid #5a3b2b;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }

    header h1 {
      font-size: 2em;
      text-align: center;
      margin-bottom: 10px;
    }

    .music-control {
      text-align: center;
      margin-top: 10px;
    }

    .progress-container {
      margin-bottom: 20px;
      text-align: center;
    }

    .progress-bar {
      background: #ddd;
      border-radius: 10px;
      overflow: hidden;
      height: 20px;
      margin: 10px auto;
      width: 80%;
    }

    .progress-fill {
      background: #c19a6b;
      height: 100%;
      width: 0%;
    }

    .map-container {
      text-align: center;
      margin: 20px 0;
    }

    #map {
      height: 400px;
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      border: 3px solid #8b5e3c;
      border-radius: 10px;
    }

    .map-description {
      font-style: italic;
      margin-top: 10px;
    }

    .buttons-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .map-btn {
      padding: 10px 16px;
      background-color: #e8d6b8;
      border: 2px solid #6d4c41;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s;
      text-decoration: none;
      color: #3b241b;
      font-family: 'Georgia', serif;
    }

    .map-btn.completed {
      text-decoration: line-through;
      background-color: #dcd2bd;
      opacity: 0.6;
    }

    .qr-section {
      text-align: center;
      margin-top: 30px;
    }

    .qr-section input {
      padding: 8px;
      width: 60%;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #999;
    }

    .action-btn {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #d6c1a1;
      border: 2px solid #6d4c41;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Georgia', serif;
    }

    .button-group {
      text-align: center;
      margin-top: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      font-style: italic;
    }

    a {
      color: #3b241b;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üó∫Ô∏è Explora el Mensaje Oculto de Gonzalo</h1>
      <div class="music-control">
        <button class="music-btn" onclick="toggleMusic()">üéµ Pausar M√∫sica</button>
      </div>
    </header>

    <section>
      <div class="progress-container">
        <h3>Progreso de la Aventura</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <p id="progress-text">Paradas completadas: 0/7</p>
      </div>

      <div class="map-container">
        <div id="map"></div>
        <p class="map-description">
          Mapa callejero interactivo de <a href="https://www.openstreetmap.org/#map=17/40.5245/-6.0179" target="_blank">San Mart√≠n del Casta√±ar</a>
        </p>

        <div class="buttons-container">
          <button class="map-btn" data-stop="castillo" onclick="location.href='castillo.html'">üè∞ Castillo</button>
          <button class="map-btn" data-stop="plaza" onclick="location.href='plaza.html'">üèüÔ∏è Plaza de toros</button>
          <button class="map-btn" data-stop="iglesia" onclick="location.href='iglesia.html'">‚õ™ Iglesia</button>
          <button class="map-btn" data-stop="fuente" onclick="location.href='fuente.html'">‚õ≤ Fuente y Portal√≥n</button>
          <button class="map-btn" data-stop="ermita" onclick="location.href='ermita.html'">üôè Ermita</button>
          <button class="map-btn" data-stop="puente" onclick="location.href='puente.html'">üåâ Puente</button>
          <button class="map-btn" data-stop="bodega" onclick="location.href='bodega.html'">üç∑ Bodega</button>
        </div>
      </div>

      <div class="qr-section">
        <h2>Escanea un C√≥digo QR</h2>
        <input type="text" id="qr-input" placeholder="Ej: FUENTE-1600" />
        <br />
        <button class="action-btn" onclick="checkQR()">Verificar QR</button>
        <p id="qr-status"></p>
      </div>

      <div class="button-group">
        <button class="action-btn" onclick="location.href='index.html'">üè† Inicio</button>
        <button class="action-btn" onclick="location.href='guia.html'">üìñ Gu√≠a Hist√≥rica</button>
        <button class="action-btn" onclick="location.href='cronica.html'">üìú Cr√≥nica</button>
      </div>
    </section>

    <audio id="background-music" src="sounds/musica-medieval.mp3" preload="auto" loop autoplay></audio>

    <footer>
      <p>¬© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a></p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const mainStops = ["castillo", "plaza", "iglesia", "fuente", "ermita", "puente"];
      const allStops = [...mainStops, "bodega"];
      let completadas = 0;

      // Botones
      allStops.forEach(stop => {
        const completada = localStorage.getItem(`${stop}-completed`) === "true";
        if (completada) completadas++;
        const btn = document.querySelector(`.map-btn[data-stop="${stop}"]`);
        if (btn && completada) {
          btn.classList.add("completed");
        }
      });

      const bodegaDesbloqueada = mainStops.every(stop => localStorage.getItem(`${stop}-completed`) === "true");
      const bodegaBtn = document.querySelector(`.map-btn[data-stop="bodega"]`);
      if (bodegaBtn && !bodegaDesbloqueada) {
        bodegaBtn.style.display = "none";
      }

      document.getElementById("progress-fill").style.width = `${(completadas / allStops.length) * 100}%`;
      document.getElementById("progress-text").textContent = `Paradas completadas: ${completadas}/${allStops.length}`;

      function checkQR() {
        const qrInput = document.getElementById("qr-input").value.trim().toUpperCase();
        const codes = {
          "CASTILLO-1834": "castillo",
          "PLAZA-1523": "plaza",
          "IGLESIA-1300": "iglesia",
          "FUENTE-1600": "fuente",
          "ERMITA-1500": "ermita",
          "PUENTE-1400": "puente",
          "BODEGA-1600": "bodega"
        };

        const destino = codes[qrInput];
        const status = document.getElementById("qr-status");

        if (destino) {
          status.textContent = "‚úÖ C√≥digo correcto. Abriendo...";
          localStorage.setItem(`${destino}-completed`, "true");
          setTimeout(() => {
            window.location.href = destino + ".html";
          }, 1500);
        } else {
          status.textContent = "‚ùå C√≥digo incorrecto. Intenta de nuevo.";
        }
      }

      function toggleMusic() {
        const music = document.getElementById("background-music");
        const btn = document.querySelector(".music-btn");
        if (music.paused) {
          music.play();
          btn.innerHTML = "üéµ Pausar M√∫sica";
        } else {
          music.pause();
          btn.innerHTML = "üéµ Reanudar M√∫sica";
        }
      }

      // Mapa
      const sanMartinCoords = [40.5245, -6.0179];
      const map = L.map('map').setView(sanMartinCoords, 17);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
      }).addTo(map);

      // Ubicaci√≥n del usuario
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const userCoords = [position.coords.latitude, position.coords.longitude];
            L.marker(userCoords)
              .addTo(map)
              .bindPopup('üìå Est√°s aqu√≠')
              .openPopup();

            L.circle(userCoords, {
              radius: 15,
              color: 'blue',
              fillColor: '#30f',
              fillOpacity: 0.3,
            }).addTo(map);
          },
          () => console.log('No se pudo obtener tu ubicaci√≥n')
        );
      }

      // Marcadores personalizados con check si est√°n completados
      const paradas = [
        { id: "castillo", nombre: "Castillo", coords: [40.5247, -6.0175], icono: "üè∞", archivo: "castillo.html" },
        { id: "plaza", nombre: "Plaza de toros", coords: [40.5246, -6.0180], icono: "üèüÔ∏è", archivo: "plaza.html" },
        { id: "iglesia", nombre: "Iglesia", coords: [40.5244, -6.0173], icono: "‚õ™", archivo: "iglesia.html" },
        { id: "fuente", nombre: "Fuente y Portal√≥n", coords: [40.5242, -6.0178], icono: "‚õ≤", archivo: "fuente.html" },
        { id: "ermita", nombre: "Ermita", coords: [40.5241, -6.0183], icono: "üôè", archivo: "ermita.html" },
        { id: "puente", nombre: "Puente", coords: [40.5239, -6.0188], icono: "üåâ", archivo: "puente.html" },
        { id: "bodega", nombre: "Bodega", coords: [40.5243, -6.0176], icono: "üç∑", archivo: "bodega.html" }
      ];

      paradas.forEach(parada => {
        const completada = localStorage.getItem(`${parada.id}-completed`) === "true";

        // Solo mostramos Bodega si est√° desbloqueada
        if (parada.id === "bodega" && !bodegaDesbloqueada) return;

        const iconoFinal = completada ? `‚úÖ${parada.icono}` : parada.icono;

        const customIcon = L.divIcon({
          className: "custom-icon",
          html: `<div style="font-size: 24px;">${iconoFinal}</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        });

        L.marker(parada.coords, { icon: customIcon })
          .addTo(map)
          .bindPopup(`
            <strong>${iconoFinal} ${parada.nombre}</strong><br>
            <button onclick="location.href='${parada.archivo}'" style="margin-top: 5px; padding: 6px 10px; font-size: 14px;">Ir a la parada</button>
          `);
      });
    </script>
  </div>
</body>
</html>
