<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="titulo">🗺️🧭 Explora San Martín del Castañar</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      background: url('images/pergamino.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Georgia', serif;
      color: #3b241b;
      padding: 0;
      margin: 0;
    }
    .container {
      max-width: 850px;
      margin: auto;
      background: rgba(255, 248, 228, 0.95);
      border: 3px solid #5a3b2b;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      position: relative;
    }
    #map {
      height: 400px;
      width: 100%;
      border: 3px solid #8b5e3c;
      border-radius: 10px;
      position: relative;
    }
    .compass-container {
      display: flex;
      justify-content: flex-end;
      padding-top: 10px;
    }
    #compass {
      width: 48px;
      height: 48px;
      transform: rotate(0deg);
      transition: transform 0.5s linear;
      border: 2px solid black;
      border-radius: 50%;
      padding: 4px;
      background: white;
    }
    .marker-emoji {
      font-size: 36px;
      transition: transform 0.2s ease;
      filter: drop-shadow(0 0 2px #000);
      user-select: none;
    }
    .marker-emoji.clicked {
      transform: scale(1.4);
    }
    .button-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin: 20px 0;
    }
    .button-row a {
      background: rgba(255, 248, 228, 0.85);
      border: 2px solid #8b5e3c;
      border-radius: 12px;
      padding: 10px 16px;
      text-decoration: none;
      font-size: 18px;
      font-weight: bold;
      color: #3b241b;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      backdrop-filter: blur(2px);
    }
    footer {
      text-align: center;
      font-style: italic;
      font-size: 14px;
      margin-top: 40px;
    }
  </style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-GE0YB9PL8Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-GE0YB9PL8Q');
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1 data-i18n="titulo">🧙‍♂️🔍 Busca el Mensaje Oculto de Gonzalo</h1>
    </header>
    <div class="progress-container">
      <div class="progress-bar" style="background: #ddd; border-radius: 10px; height: 20px; width: 80%; margin: auto;">
        <div class="progress-fill" id="progress-fill" style="background: #c19a6b; height: 100%; width: 0%;"></div>
      </div>
      <p id="progress-text" style="text-align:center;" data-i18n="progreso">Paradas completadas: 0/7</p>
      <div class="button-row">
        <a href="/index.html" data-i18n="inicio">🏠 Inicio</a>
        <a href="guia.html" data-i18n="guia">📖 Guía</a>
        <a href="ranking.html" data-i18n="ranking">📊 Ranking</a>
        <a href="cronica.html" data-i18n="cronica">📜 Crónica</a>
      </div>
    </div>
    <div class="map-explanation">
      <h2 data-i18n="explicacion_titulo">ℹ️ ¿Cómo funciona este juego?</h2>
      <p data-i18n="explicacion_1">Este mapa muestra las distintas paradas del recorrido por San Martín del Castañar. En cada parada te espera una prueba o enigma que deberás resolver para desbloquear fragmentos del mensaje oculto de Gonzalo.</p>
      <p data-i18n="explicacion_2">Pulsa sobre los iconos del mapa para acceder a cada prueba. Algunas paradas se desbloquean al avanzar en el juego. Usa la brújula para orientarte y sigue tu progreso con la barra de arriba.</p>
    </div>
    <div class="map-container">
      <div id="map"></div>
      <p class="map-description" data-i18n="descripcion_mapa">
        Mapa interactivo de <a href="https://www.openstreetmap.org/#map=17/40.5222/-6.0645" target="_blank">San Martín del Castañar</a>
      </p>
    </div>
    <div class="compass-container">
      <img src="images/flecha.png" id="compass" alt="Brújula" />
    </div>
  </div>
  <footer>
    <p>© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank" data-i18n="reserva">Reserva tu visita</a></p>
  </footer>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const translations = {
      es: {
        titulo: "🧙‍♂️🔍 Busca el Mensaje Oculto de Gonzalo",
        progreso: "Paradas completadas: ",
        inicio: "🏠 Inicio",
        guia: "📖 Guía",
        ranking: "📊 Ranking",
        cronica: "📜 Crónica",
        explicacion_titulo: "ℹ️ ¿Cómo funciona este juego?",
        explicacion_1: "Este mapa muestra las distintas paradas del recorrido por San Martín del Castañar. En cada parada te espera una prueba o enigma que deberás resolver para desbloquear fragmentos del mensaje oculto de Gonzalo.",
        explicacion_2: "Pulsa sobre los iconos del mapa para acceder a cada prueba. Algunas paradas se desbloquean al avanzar en el juego. Usa la brújula para orientarte y sigue tu progreso con la barra de arriba.",
        descripcion_mapa: "Mapa interactivo de San Martín del Castañar",
        reserva: "Reserva tu visita"
      },
      en: {
        titulo: "🧙‍♂️🔍 Discover Gonzalo’s Hidden Message",
        progreso: "Stops completed: ",
        inicio: "🏠 Home",
        guia: "📖 Guide",
        ranking: "📊 Ranking",
        cronica: "📜 Chronicle",
        explicacion_titulo: "ℹ️ How does this game work?",
        explicacion_1: "This map shows the different stops on the route through San Martín del Castañar. At each stop, a challenge or puzzle awaits you to unlock fragments of Gonzalo’s hidden message.",
        explicacion_2: "Tap the icons on the map to access each challenge. Some stops unlock as you progress. Use the compass to orient yourself and track your progress with the bar above.",
        descripcion_mapa: "Interactive map of San Martín del Castañar",
        reserva: "Book your visit"
      },
      fr: {
        titulo: "🧙‍♂️🔍 Découvrez le Message Caché de Gonzalo",
        progreso: "Étapes complétées : ",
        inicio: "🏠 Accueil",
        guia: "📖 Guide",
        ranking: "📊 Classement",
        cronica: "📜 Chronique",
        explicacion_titulo: "ℹ️ Comment fonctionne ce jeu ?",
        explicacion_1: "Cette carte montre les différentes étapes du parcours à San Martín del Castañar. À chaque étape, une énigme vous attend pour débloquer des fragments du message caché de Gonzalo.",
        explicacion_2: "Appuyez sur les icônes de la carte pour accéder à chaque épreuve. Certaines étapes se débloquent au fur et à mesure. Utilisez la boussole pour vous orienter et suivez votre progression avec la barre ci-dessus.",
        descripcion_mapa: "Carte interactive de San Martín del Castañar",
        reserva: "Réservez votre visite"
      },
      de: {
        titulo: "🧙‍♂️🔍 Finde Gonzalos Versteckte Botschaft",
        progreso: "Abgeschlossene Stationen: ",
        inicio: "🏠 Startseite",
        guia: "📖 Anleitung",
        ranking: "📊 Rangliste",
        cronica: "📜 Chronik",
        explicacion_titulo: "ℹ️ Wie funktioniert dieses Spiel?",
        explicacion_1: "Diese Karte zeigt die verschiedenen Stationen der Route durch San Martín del Castañar. An jeder Station erwartet dich ein Rätsel, das gelöst werden muss, um Fragmente von Gonzalos geheimer Botschaft freizuschalten.",
        explicacion_2: "Tippe auf die Symbole auf der Karte, um zu den Herausforderungen zu gelangen. Einige Stationen werden im Verlauf freigeschaltet. Nutze den Kompass zur Orientierung und verfolge deinen Fortschritt mit der Leiste oben.",
        descripcion_mapa: "Interaktive Karte von San Martín del Castañar",
        reserva: "Besuch reservieren"
      }
    };

    const lang = localStorage.getItem("language") || "es";
    const t = translations[lang] || translations.es;

    const stops = {
      castillo: { coords: [40.5219, -6.0651], icon: "🏰", label: {es: "Castillo", en: "Castle", fr: "Château", de: "Burg"} },
      plaza:    { coords: [40.5220, -6.0648], icon: "🎯", label: {es: "Plaza", en: "Square", fr: "Place", de: "Platz"} },
      iglesia:  { coords: [40.5224, -6.0643], icon: "⛪", label: {es: "Iglesia", en: "Church", fr: "Église", de: "Kirche"} },
      fuente:   { coords: [40.5222, -6.0647], icon: "💧", label: {es: "Fuente", en: "Fountain", fr: "Fontaine", de: "Brunnen"} },
      ermita:   { coords: [40.5216, -6.0649], icon: "🕍", label: {es: "Ermita", en: "Hermitage", fr: "Chapelle", de: "Kapelle"} },
      puente:   { coords: [40.5215, -6.0654], icon: "🌉", label: {es: "Puente", en: "Bridge", fr: "Pont", de: "Brücke"} },
      bodega:   { coords: [40.5218, -6.0642], icon: "🍷", label: {es: "Bodega", en: "Cellar", fr: "Cave", de: "Keller"} }
    };

    const map = L.map('map').setView([40.5222, -6.0645], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    for (const key in stops) {
      const stop = stops[key];
      const marker = L.marker(stop.coords, {
        icon: L.divIcon({ className: 'marker-emoji', html: stop.icon })
      }).addTo(map);
      marker.bindPopup(`<b>${stop.label[lang]}</b>`);
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.documentElement.lang = lang;
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (t[key]) el.innerHTML = t[key];
      });

      const allStops = ["castillo", "plaza", "iglesia", "fuente", "ermita", "puente", "bodega"];
      let completadas = 0;
      allStops.forEach(stop => {
        if (localStorage.getItem(`${stop}-completed`) === "true") completadas++;
      });
      document.getElementById("progress-text").textContent = `${t.progreso}${completadas}/${allStops.length}`;
    });
  </script>
</body>
</html>
