<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üè∞ Castillo de Gonzalo</title>
  <link rel="stylesheet" href="styles/style.css" />
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg" />
  <style>
    /* --- Estilos Globales --- */
    body {
      font-family: Arial, sans-serif;
      background: url('images/fondo-castillo.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      color: #333;
      min-height: 100vh;
    }
    .container {
      max-width: 960px;
      margin: 20px auto;
      background: rgba(255,248,228,0.95);
      border: 3px double #5e3b1b;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      position: relative;
    }
    header h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #5e3b1b;
    }
    .action-btn {
      display: inline-block;
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      background: #dec79b;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    .action-btn:hover {
      background: #d4b886;
      transform: translateY(-2px);
    }
    .music-control {
      text-align: center;
      margin-bottom: 20px;
    }
    /* --- Verificaci√≥n de Ubicaci√≥n --- */
    #location-check {
      text-align: center;
      margin-bottom: 30px;
    }
    #location-check input {
      padding: 8px;
      font-size: 16px;
      width: 200px;
      margin: 10px;
      border: 1px solid #5e3b1b;
      border-radius: 4px;
    }
    #location-status {
      margin-top: 10px;
      font-size: 1.1em;
      color: #d9534f;
      font-weight: bold;
    }
    #sonar-radar {
      margin-top: 15px;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      background: #000;
    }
    /* --- Carrusel --- */
    .carousel-container {
      position: relative;
      overflow: hidden;
      width: 100%;
      margin-bottom: 20px;
      border-radius: 10px;
      border: 2px solid #5e3b1b;
    }
    .carousel-slides {
      display: flex;
      transition: transform 0.5s ease;
    }
    .carousel-slide {
      min-width: 100%;
      box-sizing: border-box;
      text-align: center;
    }
    .carousel-slide img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      display: block;
      border-radius: 10px;
    }
    .carousel-slide p {
      font-family: "Georgia", serif;
      font-size: 16px;
      color: #2e2e2e;
      line-height: 1.5;
      margin: 15px auto;
      max-width: 800px;
      padding: 0 20px;
    }
    .carousel-slide a {
      color: #5e3b1b;
      text-decoration: underline;
    }
    .carousel-slide a:hover {
      color: #a65c3a;
    }
    .carousel-prev, .carousel-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.8);
      border: 2px solid #5e3b1b;
      font-size: 24px;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .carousel-prev:hover, .carousel-next:hover {
      background: rgba(255,255,255,1);
      transform: translateY(-50%) scale(1.1);
    }
    .carousel-prev { left: 10px; }
    .carousel-next { right: 10px; }
    /* --- Retos Visuales y Quiz --- */
    .visual-challenge, .quiz {
      margin: 30px 0;
      padding: 20px;
      background: rgba(255,255,255,0.8);
      border: 2px solid #5e3b1b;
      border-radius: 10px;
    }
    .visual-challenge h2, .quiz h2 {
      color: #5e3b1b;
      text-align: center;
      margin-bottom: 20px;
    }
    .visual-challenge p, .quiz p {
      margin: 15px 0;
      font-weight: bold;
    }
    .hint-btn {
      margin: 5px;
      padding: 5px 10px;
      font-size: 14px;
      background: #f0e68c;
      border: 1px solid #5e3b1b;
      border-radius: 5px;
      cursor: pointer;
    }
    /* --- Minijuego: Candado del Cofre --- */
    #combination-lock {
      display: none;
      text-align: center;
      margin-top: 20px;
      padding: 20px;
      background: rgba(255,255,255,0.9);
      border: 2px solid #5e3b1b;
      border-radius: 10px;
    }
    #combination-lock h2 {
      margin-bottom: 20px;
      color: #5e3b1b;
    }
    .cofre-container {
      position: relative;
      display: inline-block;
      margin: 20px auto;
      max-width: 600px;
      width: 100%;
    }
    .cofre-img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
    }
    #dials {
      position: absolute;
      top: 35%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
    }
    .dial {
      width: 45px;
      height: 45px;
      margin: 0;
      border: 2px solid #5e3b1b;
      border-radius: 50%;
      background: #dec79b;
      font-size: 24px;
      line-height: 45px;
      cursor: pointer;
      user-select: none;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      text-align: center;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .dial:hover {
      background: #d4b886;
      transform: scale(1.1);
    }
    #check-combination {
      margin-top: 20px;
    }
    #combination-status {
      margin-top: 15px;
      font-size: 1.2em;
      font-weight: bold;
      color: #5e3b1b;
    }
    /* --- Pista para el Candado --- */
    #pista-lock {
      display: none;
      margin-top: 20px;
      padding: 20px;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      text-align: center;
      background-color: #f5f5dc;
    }
    #pista-lock p {
      font-size: 16px;
      color: #000;
      margin: 10px 0;
    }
    /* --- Fragmento Final --- */
    .fragmento-final {
      margin: 20px auto;
      display: none;
      text-align: center;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      background-color: #f5f5dc;
      padding: 40px 20px;
      font-style: italic;
      font-size: 1.2em;
      font-weight: bold;
      border-radius: 10px;
      border: 2px solid #5e3b1b;
    }
    .fragmento-final p {
      margin: 15px 0;
      color: #2e2e2e;
    }
    #continue-button {
      text-align: center;
      margin-top: 30px;
      display: none;
    }
    footer {
      text-align: center;
      margin-top: 30px;
      padding: 20px;
      background: rgba(255,255,255,0.8);
      border-radius: 10px;
    }
    footer p {
      margin: 0;
      font-size: 0.9em;
      color: #5e3b1b;
    }
    footer a {
      color: #5e3b1b;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
    /* --- Responsive Design --- */
    @media screen and (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 15px;
      }
      .dial {
        width: 40px;
        height: 40px;
        line-height: 40px;
        font-size: 20px;
      }
      .carousel-slide img {
        height: 200px;
      }
      .carousel-prev, .carousel-next {
        font-size: 20px;
        padding: 8px;
        width: 40px;
        height: 40px;
      }
      #dials {
        top: 30%;
        gap: 5px;
      }
      .carousel-slide p {
        font-size: 14px;
        padding: 0 10px;
      }
    }
    /* --- Adornos Medievales --- */
    .container:before {
      content: "‚öîÔ∏è";
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 32px;
      color: #5e3b1b;
    }
    .container:after {
      content: "üõ°Ô∏è";
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 32px;
      color: #5e3b1b;
    }
    /* --- Efectos adicionales --- */
    .success {
      color: #28a745 !important;
      background-color: #d4edda;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .error {
      color: #dc3545 !important;
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
  </style>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-GE0YB9PL8Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-GE0YB9PL8Q');
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè∞ Castillo de Gonzalo</h1>
      <div class="music-control">
        <button class="action-btn music-btn" onclick="toggleMusic()">
          <span class="music-icon">üéµ</span> Pausar M√∫sica
        </button>
      </div>
    </header>

    <section id="content">
      <!-- Verificaci√≥n de Ubicaci√≥n -->
      <div id="location-check">
        <h2>Verifica tu ubicaci√≥n</h2>
        <p>Ac√©rcate a la puerta principal del Castillo de San Mart√≠n para iniciar la b√∫squeda del mensaje.</p>
        <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
        <p>O ingresa el nombre:</p>
        <input type="text" id="location-input" placeholder="Ej: Castillo" />
        <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
        <p id="location-status"></p>
        <canvas id="sonar-radar" width="200" height="200"></canvas>
      </div>

      <!-- Contenido del Juego (tras verificaci√≥n) -->
      <div id="game-content" style="display: none;">
        <!-- Carrusel con tres im√°genes, texto descriptivo y contexto hist√≥rico -->
        <div class="carousel-container">
          <div class="carousel-slides">
            <!-- Slide 1 -->
            <div class="carousel-slide">
              <img src="images/castillo-entrada.jpg" alt="Entrada del Castillo" />
              <p>
                <strong>Entrada Fortificada:</strong> Construida en el siglo XIII, sirvi√≥ de defensa en la Reconquista y fue remodelada en el siglo XV. <br>
                <em>1834:</em> Se traslad√≥ el cementerio local dentro de los muros del castillo. <br>
                <a href="https://sanmartindelcasta√±ar.es/castillo-de-la-biosfera/" target="_blank">M√°s informaci√≥n</a>
              </p>
            </div>
            <!-- Slide 2 -->
            <div class="carousel-slide">
              <img src="images/castillo-torre.jpg" alt="Torre del Homenaje" style="object-fit: contain; height: 300px;" />
              <p>
                <strong>Torre del Homenaje:</strong> Da√±ada por un rayo a principios del siglo XX, fue restaurada y ofrece vistas espectaculares. <br>
                <em>1949:</em> Declarada Bien de Inter√©s Cultural. <br>
                <a href="https://www.turismocastillayleon.com/es/patrimonio-cultura/castillo-san-martin-castanar" target="_blank">M√°s informaci√≥n</a>
              </p>
            </div>
            <!-- Slide 3 -->
            <div class="carousel-slide">
              <img src="images/castillo-vista.jpg" alt="Vista Panor√°mica" />
              <p>
                <strong>Vista Panor√°mica:</strong> Desde aqu√≠ se observan las sierras de B√©jar y Francia, impregnadas de historia. <br>
                <em>2010:</em> Reformada para albergar el Centro de Interpretaci√≥n de la Biosfera de las Sierras de Francia y B√©jar. <br>
                <a href="https://www.castillosdeespa√±a.es/es/content/san-martin-del-castanar/" target="_blank">M√°s informaci√≥n</a>
              </p>
            </div>
          </div>
          <button class="carousel-prev" aria-label="Anterior">&#10094;</button>
          <button class="carousel-next" aria-label="Siguiente">&#10095;</button>
        </div>

        <!-- Retos Visuales -->
        <div class="visual-challenge">
          <h2>Retos Visuales: Afina tus sentidos</h2>
          <p>1. ¬øQu√© destaca en la fachada principal del castillo?</p>
          <div id="visual-opciones-1">
            <button class="action-btn" onclick="checkVisualAnswer('Escudos','Muralla',1)">Escudos</button>
            <button class="action-btn" onclick="checkVisualAnswer('Muralla','Muralla',1)">Muralla</button>
            <button class="action-btn" onclick="checkVisualAnswer('Columnas','Muralla',1)">Columnas</button>
          </div>
          <p id="visual-resultado-1"></p>

          <p>2. ¬øCu√°ntas torres ten√≠a originalmente el castillo?</p>
          <div id="visual-opciones-2">
            <button class="action-btn" onclick="checkVisualAnswer('1','2',2)">1</button>
            <button class="action-btn" onclick="checkVisualAnswer('2','2',2)">2</button>
            <button class="action-btn" onclick="checkVisualAnswer('3','2',2)">3</button>
          </div>
          <p id="visual-resultado-2"></p>
        </div>

        <!-- Quiz Hist√≥rico -->
        <div class="quiz">
          <h2>Quiz: Descubre el mensaje</h2>
          <p>1. ¬øEn qu√© siglo se funda esta fortificaci√≥n?</p>
          <div id="quiz-opciones-1">
            <button class="action-btn" onclick="checkAnswer('XII','XIII',1)">XII</button>
            <button class="action-btn" onclick="checkAnswer('XIII','XIII',1)">XIII</button>
            <button class="action-btn" onclick="checkAnswer('XIV','XIII',1)">XIV</button>
          </div>
          <p id="quiz-resultado-1"></p>

          <p>2. ¬øQu√© alberga el castillo desde el siglo XIX?</p>
          <div id="quiz-opciones-2">
            <button class="action-btn" onclick="checkAnswer('Discoteca','Cementerio municipal',2)">Discoteca</button>
            <button class="action-btn" onclick="checkAnswer('Cementerio municipal','Cementerio municipal',2)">Cementerio municipal</button>
            <button class="action-btn" onclick="checkAnswer('Museo','Cementerio municipal',2)">Museo</button>
          </div>
          <p id="quiz-resultado-2"></p>

          <p>3. ¬øQu√© funci√≥n tiene actualmente el castillo?</p>
          <div id="quiz-opciones-3">
            <button class="action-btn" onclick="checkAnswer('Museo','Centro de Interpretacion de la Biosfera',3)">Museo</button>
            <button class="action-btn" onclick="checkAnswer('Centro de Interpretacion de la Biosfera','Centro de Interpretacion de la Biosfera',3)">Centro de Interpretacion de la Biosfera</button>
            <button class="action-btn" onclick="checkAnswer('Biblioteca','Centro de Interpretacion de la Biosfera',3)">Biblioteca</button>
          </div>
          <p id="quiz-resultado-3"></p>
        </div>

        <!-- Minijuego: Candado del Cofre -->
        <div id="combination-lock">
          <h2>Candado del Cofre</h2>
          <div class="cofre-container">
            <img src="images/baul.png" alt="Cofre Antiguo" class="cofre-img" />
            <div id="dials">
              <div class="dial" data-digit="0">0</div>
              <div class="dial" data-digit="0">0</div>
              <div class="dial" data-digit="0">0</div>
              <div class="dial" data-digit="0">0</div>
            </div>
          </div>
          <button class="action-btn" id="check-combination" onclick="checkCombination()">Comprobar Combinaci√≥n</button>
          <p id="combination-status"></p>
          <button class="hint-btn" onclick="togglePistaLock()">Pista para el Candado</button>
          <div id="pista-lock">
            <p>La clave corresponde a una fecha que marc√≥ un hito en la historia del castillo. ¬°B√∫scala en las im√°genes!</p>
            <button class="action-btn" onclick="togglePistaLock()">Cerrar Pista</button>
          </div>
        </div>

        <!-- Fragmento Final -->
        <div class="fragmento-final" id="fragmento-final">
          <p>
            <strong>Fragmento del Mensaje: Oculto </strong>
            <span id="message-piece" style="display: none;">"El secreto del castillo"</span>
          </p>
          <p><strong>QR en el pueblo:</strong> CASTILLO (busca en la entrada principal).</p>
          <p><strong>Dato Curioso:</strong> Cer√°micas y monedas del siglo XIII halladas aqu√≠ inspiraron a Gonzalo.</p>
        </div>

        <div id="continue-button">
          <button class="action-btn" onclick="window.location.href='felicitaciones.html?stop=castillo'">
            Continuar b√∫squeda
          </button>
        </div>
      </div>
    </section>

    <!-- Audios -->
    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
    <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
    <audio id="coins-sound" src="sounds/coins.mp3" preload="auto"></audio>
    <audio id="ambient-sound" src="sounds/musica-medieval.mp3" preload="auto" loop></audio>
    <audio id="sonar-ping" src="sounds/sonar-ping.mp3" preload="auto"></audio>

    <footer>
      <p>¬© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a></p>
    </footer>
  </div>

  <script>
    /* --- VARIABLES GLOBALES --- */
    let quiz1Correct = false;
    let quiz2Correct = false;
    let quiz3Correct = false;
    let secretCombination = "";
    let currentSlide = 0;
    let totalSlides = 0;

    /* --- VERIFICACI√ìN DE UBICACI√ìN --- */
    const targetLat = 40.520512;
    const targetLon = -6.063541;
    const thresholdDistance = 100; // Aumentado para pruebas

    function checkLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(geoSuccess, locationError);
      } else {
        document.getElementById("location-status").textContent =
          "Tu navegador no soporta geolocalizaci√≥n.";
      }
    }

    function geoSuccess(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const distance = calculateDistance(lat, lon, targetLat, targetLon);
      
      if (distance <= thresholdDistance) {
        unlockStop();
      } else {
        document.getElementById("location-status").textContent =
          `Est√°s a ${Math.round(distance)} metros de la parada. Ac√©rcate un poco m√°s.`;
      }
    }

    function locationError(err) {
      document.getElementById("location-status").textContent =
        "Error al obtener tu ubicaci√≥n: " + err.message;
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Radio de la Tierra en metros
      const toRad = (x) => x * Math.PI / 180;
      const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
      const ŒîœÜ = toRad(lat2 - lat1), ŒîŒª = toRad(lon2 - lon1);
      const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function checkLocationManual() {
      const input = document.getElementById("location-input").value.trim().toLowerCase();
      const validInputs = ["castillo", "san martin", "san mart√≠n", "castle"];
      
      if (validInputs.includes(input)) {
        unlockStop();
      } else {
        document.getElementById("location-status").textContent =
          "Nombre incorrecto. Int√©ntalo nuevamente.";
      }
    }

    function unlockStop() {
      document.getElementById("location-check").style.display = "none";
      document.getElementById("game-content").style.display = "block";
      initCarousel();
      playSound("ambient-sound");
    }

    /* --- CARRUSEL --- */
    function initCarousel() {
      const carouselContainer = document.querySelector('.carousel-slides');
      const slides = document.querySelectorAll('.carousel-slide');
      totalSlides = slides.length;
      currentSlide = 0;
      
      const prevBtn = document.querySelector('.carousel-prev');
      const nextBtn = document.querySelector('.carousel-next');

      function updateCarousel() {
        carouselContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
      }

      if (prevBtn && nextBtn) {
        prevBtn.addEventListener('click', () => {
          currentSlide = (currentSlide === 0) ? totalSlides - 1 : currentSlide - 1;
          updateCarousel();
        });

        nextBtn.addEventListener('click', () => {
          currentSlide = (currentSlide === totalSlides - 1) ? 0 : currentSlide + 1;
          updateCarousel();
        });
      }

      updateCarousel();
    }

    /* --- RETOS VISUALES --- */
    function checkVisualAnswer(selected, correct, n) {
      const result = document.getElementById('visual-resultado-' + n);
      if (selected === correct) {
        result.textContent = "¬°Correcto!";
        result.className = "success";
        playSound("success-sound");
      } else {
        result.textContent = "Respuesta incorrecta. Int√©ntalo de nuevo.";
        result.className = "error";
        playSound("error-sound");
      }
    }

    /* --- QUIZ --- */
    function checkAnswer(selected, correct, n) {
      const result = document.getElementById('quiz-resultado-' + n);
      if (selected === correct) {
        result.textContent = "¬°Correcto!";
        result.className = "success";
        playSound("success-sound");
        
        // Marcar como correcto
        if (n === 1) quiz1Correct = true;
        if (n === 2) quiz2Correct = true;
        if (n === 3) quiz3Correct = true;
        
        // Deshabilitar botones despu√©s de respuesta correcta
        const buttons = document.querySelectorAll(`#quiz-opciones-${n} button`);
        buttons.forEach(btn => btn.disabled = true);
        
      } else {
        result.textContent = "Incorrecto. Vuelve a intentarlo.";
        result.className = "error";
        playSound("error-sound");
      }
      
      // Verificar si todas las preguntas est√°n correctas
      if (quiz1Correct && quiz2Correct && quiz3Correct) {
        setTimeout(() => {
          document.querySelector('.quiz').style.display = "none";
          initCombinationLock();
        }, 1000);
      }
    }

    /* --- MINIJUEGO: CANDADO DEL COFRE --- */
    function initCombinationLock() {
      document.getElementById("combination-lock").style.display = "block";
      
      const dials = document.querySelectorAll(".dial");
      dials.forEach(dial => {
        dial.setAttribute("data-digit", "0");
        dial.textContent = "0";
        dial.addEventListener("click", () => {
          let current = parseInt(dial.getAttribute("data-digit"));
          current = (current + 1) % 10;
          dial.setAttribute("data-digit", current);
          dial.textContent = current;
        });
      });
      
      generateSecretCombination();
    }

    function generateSecretCombination() {
      const keys = ["1834", "1949", "2010"];
      secretCombination = keys[Math.floor(Math.random() * keys.length)];
      console.log("Combinaci√≥n secreta:", secretCombination);
    }

    function togglePistaLock() {
      const pistaDiv = document.getElementById("pista-lock");
      pistaDiv.style.display = pistaDiv.style.display === "block" ? "none" : "block";
    }

    function checkCombination() {
      const dials = document.querySelectorAll(".dial");
      let userCombination = "";
      
      dials.forEach(dial => {
        userCombination += dial.getAttribute("data-digit");
      });
      
      if (userCombination === secretCombination) {
        document.getElementById("combination-status").textContent = "¬°Candado desbloqueado!";
        document.getElementById("combination-status").className = "success";
        playSound("coins-sound");
        unlockFinalFragment();
      } else {
        document.getElementById("combination-status").textContent = "Combinaci√≥n incorrecta. Int√©ntalo de nuevo.";
        document.getElementById("combination-status").className = "error";
        playSound("error-sound");
      }
    }

    /* --- FRAGMENTO FINAL --- */
    function unlockFinalFragment() {
      document.getElementById("combination-lock").style.display = "none";
      document.getElementById("fragmento-final").style.display = "block";
      document.getElementById("continue-button").style.display = "block";
      document.getElementById("message-piece").style.display = "inline";
      
      // Guardar progreso
      try {
        updateChronicle();
        updateRanking();
      } catch (error) {
        console.log("Error guardando progreso:", error
