<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üè∞ Castillo</title>
  <link rel="stylesheet" href="styles/style.css"/>
  <link rel="icon" type="image/jpg" href="images/escudo-borrado.jpg"/>
  <style>
    /* Estilos generales */
    body {
      font-family: Arial, sans-serif;
      background: url('images/fondo-castillo.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container {
      max-width: 960px;
      margin: auto;
      background: rgba(255,248,228,0.95);
      border: 3px double #5e3b1b;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      position: relative;
    }
    header h1 {
      text-align: center;
    }
    .action-btn {
      display: inline-block;
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      background: #dec79b;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .music-control {
      text-align: center;
      margin-bottom: 10px;
    }
    #content {
      margin-top: 10px;
    }
    /* Ubicaci√≥n */
    #location-check {
      text-align: center;
      margin-bottom: 30px;
    }
    #location-check input {
      padding: 8px;
      font-size: 16px;
      width: 200px;
      margin: 10px;
      border: 1px solid #5e3b1b;
      border-radius: 4px;
    }
    #location-status {
      margin-top: 10px;
      font-size: 1.1em;
      color: red;
    }
    #direction-arrow {
      width: 50px;
      margin-top: 10px;
    }
    /* Carrusel (de la primera parte) */
    .carousel {
      position: relative;
      overflow: hidden;
      margin-bottom: 20px;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
    }
    .carousel-slides {
      display: flex;
      transition: transform 0.5s ease;
      width: 300%;
    }
    .slide {
      flex: 0 0 100%;
      box-sizing: border-box;
      text-align: center;
      padding: 10px;
    }
    .slide img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #6e3b1b;
    }
    .carousel-info {
      margin-top: 10px;
      line-height: 1.4;
    }
    .carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.7);
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
    }
    .prev-slide { left: 10px; }
    .next-slide { right: 10px; }
    /* Resto de secciones (retos visuales, quiz) se mantienen */
    .visual-challenge, .quiz {
      margin: 20px 0;
    }
    /* --- Reto del Castillo --- */
    #castle-challenge {
      display: none;
      margin: 20px auto;
      padding: 15px;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      background: url('images/fondo.jpg') no-repeat center center;
      background-size: cover;
      position: relative;
    }
    /* Estilo para el laberinto (grid 5x5) */
    #labyrinth-container {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      grid-template-rows: repeat(5, 60px);
      gap: 4px;
      justify-content: center;
      margin-bottom: 15px;
    }
    .lab-cell {
      width: 60px;
      height: 60px;
      border: 1px solid #999;
      position: relative;
      text-align: center;
      line-height: 60px;
      font-size: 24px;
      background: #fff;
    }
    .lab-wall {
      background: #666;
    }
    .lab-exit {
      background: #ffd;
    }
    /* La ‚Äúpieza‚Äù del caballo se representar√° como un elemento */
    .horse {
      position: absolute;
      z-index: 2;
      width: 100%;
      height: 100%;
      text-align: center;
      line-height: 60px;
    }
    /* --- CombLock (candado) --- */
    #combination-lock {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    .dial {
      display: inline-block;
      width: 60px;
      height: 60px;
      margin: 5px;
      border: 2px solid #5e3b1b;
      border-radius: 50%;
      background: #dec79b;
      font-size: 24px;
      line-height: 60px;
      cursor: pointer;
      user-select: none;
    }
    #check-combination {
      margin-top: 10px;
    }
    /* Fragmento Final */
    .fragmento-final {
      margin: 20px auto;
      display: none;
      text-align: center;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      padding: 40px 20px;
      font-style: italic;
      font-size: 1.2em;
      font-weight: bold;
      border-radius: 10px;
    }
    #continue-button {
      text-align: center;
      margin-top: 15px;
      display: none;
    }
    footer p {
      text-align: center;
      font-size: 0.9em;
      margin-top: 20px;
    }
    @media screen and (max-width: 768px) {
      .container { max-width: 90%; }
      #labyrinth-container { grid-template-columns: repeat(5, 50px); grid-template-rows: repeat(5, 50px); }
      .lab-cell { width: 50px; height: 50px; line-height: 50px; font-size: 20px; }
      .dial { width: 50px; height: 50px; line-height: 50px; font-size: 20px; }
    }
    /* Adornos medievales */
    .container:before {
      content: "‚öîÔ∏è";
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 32px;
      color: #5e3b1b;
    }
    .container:after {
      content: "üõ°Ô∏è";
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 32px;
      color: #5e3b1b;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè∞ Castillo de Gonzalo</h1>
      <div class="music-control">
        <button class="action-btn music-btn">
          <span class="music-icon">üéµ</span> Pausar M√∫sica
        </button>
      </div>
    </header>
    
    <!-- Verificaci√≥n de Ubicaci√≥n -->
    <section id="content">
      <div class="stop-icon">üè∞</div>
      <div id="location-check">
        <h2>Verifica tu ubicaci√≥n</h2>
        <p>Dir√≠gete al castillo y ac√©rcate a la torre del homenaje para continuar.</p>
        <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
        <p>O escribe el nombre:</p>
        <input type="text" id="location-input" placeholder="Ej: Castillo" />
        <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
        <p id="location-status"></p>
        <img id="direction-arrow" src="images/flecha.png" class="arrow-icon" style="display:none;" alt="Flecha de direcci√≥n" />
      </div>
      
      <!-- Contenido principal (tras verificaci√≥n) -->
      <div id="game-content" style="display:none;">
        <!-- Carrusel principal -->
        <div class="carousel">
          <div class="carousel-slides" id="main-carousel">
            <div class="slide active">
              <img src="images/castillo-entrada.jpg" alt="Entrada del Castillo" />
              <p class="carousel-info">
                <strong>Entrada:</strong> Puerta de entrada del castillo, convertido en palacio por el conde de Miranda en el siglo XV. Est√° construido sobre una fortificaci√≥n del siglo XIII.<br>
                <em>En 1834 se instal√≥ un cementerio dentro de sus muros.</em><br>
                <a href="https://www.miteco.gob.es/..." target="_blank">M√°s info</a>
              </p>
            </div>
            <div class="slide">
              <img src="images/castillo-torre.jpg" alt="Torre del Homenaje" />
              <p class="carousel-info">
                <strong>Torre del Homenaje:</strong> Originalmente hab√≠a dos torres unidas por dependencias. Un rayo las redujo a comienzos del siglo XX, dejando restos de almenas.<br>
                <em>En 1949 se declar√≥ Bien de Inter√©s Cultural.</em><br>
                <a href="https://sanmartindelcastanar.es/castillo-de-la-biosfera/" target="_blank">M√°s info</a>
              </p>
            </div>
            <div class="slide">
              <img src="images/castillo-vista.jpg" alt="Vista desde el Castillo" />
              <p class="carousel-info">
                <strong>Vista:</strong> Desde este mirador se domina todo el valle. Los muros acogen el cementerio municipal desde 1834.<br>
                <em>La renovaci√≥n se realiz√≥ en 2010 para transformar el castillo en un Centro de Interpretaci√≥n de la Biosfera.</em><br>
                <a href="https://turismosierradefrancia.es/..." target="_blank">M√°s info</a>
              </p>
            </div>
          </div>
          <button class="carousel-btn prev-slide">&larr;</button>
          <button class="carousel-btn next-slide">&rarr;</button>
        </div>
        
        <!-- Retos Visuales -->
        <div class="visual-challenge">
          <h2>Reto Visual</h2>
          <p>1. ¬øQu√© marc√≥ la torre del homenaje?</p>
          <div id="visual-opciones-1">
            <button class="action-btn" onclick="checkVisualAnswer('Incendio','Rayo',1)">Incendio</button>
            <button class="action-btn" onclick="checkVisualAnswer('Rayo','Rayo',1)">Rayo</button>
            <button class="action-btn" onclick="checkVisualAnswer('Terremoto','Rayo',1)">Terremoto</button>
          </div>
          <p id="visual-resultado-1"></p>
          <p>2. ¬øQu√© destaca en la entrada fortificada?</p>
          <div id="visual-opciones-2">
            <button class="action-btn" onclick="checkVisualAnswer('Arcos','Muralla',2)">Arcos</button>
            <button class="action-btn" onclick="checkVisualAnswer('Muralla','Muralla',2)">Muralla</button>
            <button class="action-btn" onclick="checkVisualAnswer('Torreones','Muralla',2)">Torreones</button>
          </div>
          <p id="visual-resultado-2"></p>
        </div>
        
        <!-- Quiz Hist√≥rico -->
        <div class="quiz">
          <h2>Quiz Hist√≥rico</h2>
          <p>1. ¬øEn qu√© siglo naci√≥ este castillo?</p>
          <div id="quiz-opciones-1">
            <button class="action-btn" onclick="checkAnswer('XII','XIII',1)">XII</button>
            <button class="action-btn" onclick="checkAnswer('XIII','XIII',1)">XIII</button>
            <button class="action-btn" onclick="checkAnswer('XIV','XIII',1)">XIV</button>
          </div>
          <p id="quiz-resultado-1"></p>
          <p>2. ¬øQu√© funci√≥n tuvo el castillo desde el siglo XIX?</p>
          <div id="quiz-opciones-2">
            <button class="action-btn" onclick="checkAnswer('Discoteca','Cementerio',2)">Discoteca</button>
            <button class="action-btn" onclick="checkAnswer('Cementerio','Cementerio',2)">Cementerio</button>
            <button class="action-btn" onclick="checkAnswer('Museo','Cementerio',2)">Museo</button>
          </div>
          <p id="quiz-resultado-2"></p>
          <p>3. ¬øQu√© se instal√≥ en el castillo en el siglo XXI?</p>
          <div id="quiz-opciones-3">
            <button class="action-btn" onclick="checkAnswer('Museo','Centro de Interpretaci√≥n',3)">Museo</button>
            <button class="action-btn" onclick="checkAnswer('Centro de Interpretaci√≥n','Centro de Interpretaci√≥n',3)">Centro de Interpretaci√≥n</button>
            <button class="action-btn" onclick="checkAnswer('Biblioteca','Centro de Interpretaci√≥n',3)">Biblioteca</button>
          </div>
          <p id="quiz-resultado-3"></p>
        </div>
        
        <!-- Reto del Castillo: Laberinto, luego Carrusel y, por √∫ltimo, Reto del Cofre -->
        <div id="castle-challenge" style="display: none;">
          <!-- Laberinto -->
          <div id="labyrinth-section">
            <!-- Contenedor de laberinto (grid 5x5) -->
            <div id="labyrinth-container"></div>
            <p id="labyrinth-status"></p>
            <div id="direction-buttons">
              <button class="direction-btn" onclick="chooseDirection('N')">Norte</button>
              <button class="direction-btn" onclick="chooseDirection('S')">Sur</button>
              <button class="direction-btn" onclick="chooseDirection('E')">Este</button>
              <button class="direction-btn" onclick="chooseDirection('O')">Oeste</button>
            </div>
          </div>
          <!-- Una vez resuelto el laberinto, se muestra el candado (combination lock) -->
          <div id="combination-lock" style="display:none;">
            <h2>Candado</h2>
            <p>Gira los diales para formar la combinaci√≥n correcta.</p>
            <div id="dials">
              <div class="dial" data-digit="0">0</div>
              <div class="dial" data-digit="0">0</div>
              <div class="dial" data-digit="0">0</div>
              <div class="dial" data-digit="0">0</div>
            </div>
            <button class="action-btn" id="check-combination" onclick="checkCombination()">Comprobar Combinaci√≥n</button>
            <p id="combination-status"></p>
          </div>
          <!-- Reto del Cofre tradicional (alternativa o complemento) -->
          <div id="chest-challenge" style="display:none;">
            <div class="content-box">
              <h2>Reto del Cofre</h2>
              <p>Ingresa la clave num√©rica para abrir el cofre antiguo.</p>
              <p id="chest-hint" style="font-weight:bold; color:#fff;"></p>
              <input type="text" id="chest-key" placeholder="Ingrese la clave" />
              <br>
              <button class="action-btn" onclick="checkChestKey()">Abrir Cofre</button>
              <p id="chest-status" style="color:#fff;"></p>
            </div>
          </div>
        </div>
        
        <!-- Fragmento Final -->
        <div class="fragmento-final" id="fragmento-final">
          <p>
            <strong>Fragmento del Mensaje:</strong>
            <span id="message-piece" style="font-size:1.4em; display:none;">Oculto</span>
          </p>
          <p><strong>QR en el pueblo:</strong> CASTILLO-1834</p>
          <p><strong>Dato Curioso:</strong> Aqu√≠ se han hallado monedas y cer√°micas del siglo XIII.</p>
        </div>
        
        <div id="continue-button" style="text-align:center; margin-top:15px; display:none;">
          <button class="action-btn" onclick="location.href='felicitaciones.html?stop=castillo'">
            Continuar b√∫squeda
          </button>
        </div>
      </div>
    </section>
    
    <!-- Audios -->
    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
    <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
    <audio id="coins-sound" src="sounds/coins.mp3" preload="auto"></audio>
    <audio id="cheers-sound" src="sounds/cheers.mp3" preload="auto"></audio>
    <audio id="background-music" src="sounds/musica-medieval.mp3" preload="auto" loop></audio>
    
    <footer>
      <p>¬© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a></p>
    </footer>
    
    <script>
      /*----------------------------------------*/
      /* 1. VERIFICACI√ìN DE UBICACI√ìN           */
      /*----------------------------------------*/
      const targetLat = 40.123456,
            targetLon = -3.123456,
            thresholdDistance = 50;
      
      function checkLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(geoSuccess, locationError);
        } else {
          document.getElementById("location-status").textContent = "Tu navegador no soporta geolocalizaci√≥n.";
        }
      }
      
      function geoSuccess(position) {
        const lat = position.coords.latitude,
              lon = position.coords.longitude,
              distance = calculateDistance(lat, lon, targetLat, targetLon);
        if (distance <= thresholdDistance) {
          unlockStop();
        } else {
          document.getElementById("location-status").textContent = "No est√°s lo suficientemente cerca del Castillo.";
        }
      }
      
      function locationError(err) {
        document.getElementById("location-status").textContent = "Error al obtener tu ubicaci√≥n: " + err.message;
      }
      
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3,
              toRad = x => x * Math.PI / 180,
              œÜ1 = toRad(lat1),
              œÜ2 = toRad(lat2),
              ŒîœÜ = toRad(lat2 - lat1),
              ŒîŒª = toRad(lon2 - lon1),
              a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2,
              c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }
      
      function checkLocationManual() {
        const input = document.getElementById("location-input").value.trim().toLowerCase();
        if (input === "castillo" || input === "castillo de gonzalo") {
          unlockStop();
        } else {
          document.getElementById("location-status").textContent = "Nombre incorrecto. Int√©ntalo nuevamente.";
        }
      }
      
      function unlockStop() {
        document.getElementById("location-check").style.display = "none";
        document.getElementById("game-content").style.display = "block";
        // Inicia el carrusel principal
        initMainCarousel();
        playSound("background-music");
      }
      
      /*----------------------------------------*/
      /* 2. CARRUSEL PRINCIPAL                  */
      /*----------------------------------------*/
      function initMainCarousel() {
        let currentSlide = 0;
        const slides = document.querySelectorAll('#main-carousel .slide');
        const totalSlides = slides.length;
        const prevButton = document.querySelector('.prev-slide');
        const nextButton = document.querySelector('.next-slide');
        const carouselContainer = document.querySelector('#main-carousel');
        // Ajusta el ancho total
        carouselContainer.style.width = (totalSlides * 100) + '%';
        
        function updateCarousel() {
          carouselContainer.style.transform = 'translateX(' + (-currentSlide * 100) + '%)';
        }
        
        prevButton.addEventListener('click', function() {
          currentSlide = (currentSlide > 0) ? currentSlide - 1 : totalSlides - 1;
          updateCarousel();
        });
        
        nextButton.addEventListener('click', function() {
          currentSlide = (currentSlide < totalSlides - 1) ? currentSlide + 1 : 0;
          updateCarousel();
        });
      }
      
      /*----------------------------------------*/
      /* 3. RETOS VISUALES Y QUIZ              */
      /*----------------------------------------*/
      let quiz1Correct = false, quiz2Correct = false, quiz3Correct = false;
      
      function checkVisualAnswer(selected, correct, n) {
        const result = document.getElementById('visual-resultado-' + n);
        if (selected === correct) {
          result.textContent = "¬°Correcto!";
          playSound("success-sound");
        } else {
          result.textContent = "Respuesta incorrecta...";
          playSound("error-sound");
        }
      }
      
      function checkAnswer(selected, correct, n) {
        const result = document.getElementById('quiz-resultado-' + n);
        if (selected === correct) {
          result.textContent = "¬°Correcto!";
          playSound("success-sound");
          if (n === 1) quiz1Correct = true;
          if (n === 2) quiz2Correct = true;
          if (n === 3) quiz3Correct = true;
        } else {
          result.textContent = "Incorrecto. Vuelve a intentarlo.";
          playSound("error-sound");
          if (n === 1) quiz1Correct = false;
          if (n === 2) quiz2Correct = false;
          if (n === 3) quiz3Correct = false;
        }
        if (quiz1Correct && quiz2Correct && quiz3Correct) {
          document.querySelector('.quiz').style.display = "none";
          document.getElementById("castle-challenge").style.display = "block";
          // Inicia el minijuego del Castillo (laberinto, candado)
          generateChestKey(); // se genera la clave para el candado (por si se usa el reto del cofre alternativo)
          enableLaberintoSwipe();
          // Generamos el laberinto visual
          generateLabyrinth();
        }
      }
      
      /*----------------------------------------*/
      /* 4. MINIJUEGO DEL CASTILLO: LABERINTO y CANDADO */
      /*----------------------------------------*/
      // --- Laberinto visual ---
      // Definimos una matriz de 5x5 (0 = camino, 1 = pared)
      const labyrinthMatrix = [
        [0,0,1,0,0],
        [1,0,1,0,1],
        [1,0,0,0,1],
        [1,1,1,0,0],
        [0,0,0,0,0]
      ];
      const LAB_ROWS = 5, LAB_COLS = 5;
      let horsePosition = { row: 0, col: 0 };
      let horseEl;
      
      function generateLabyrinth() {
        const container = document.getElementById("labyrinth-container");
        container.innerHTML = "";
        for (let r = 0; r < LAB_ROWS; r++) {
          for (let c = 0; c < LAB_COLS; c++) {
            const cell = document.createElement("div");
            cell.classList.add("lab-cell");
            // Si la matriz marca pared, agregamos clase
            if (labyrinthMatrix[r][c] === 1) cell.classList.add("lab-wall");
            // Si es la celda de salida (por ejemplo, abajo a la derecha), se marca como exit
            if (r === LAB_ROWS - 1 && c === LAB_COLS - 1) cell.classList.add("lab-exit");
            cell.dataset.row = r;
            cell.dataset.col = c;
            container.appendChild(cell);
          }
        }
        // Colocamos el caballo en la celda de entrada (0,0)
        horsePosition = { row: 0, col: 0 };
        horseEl = document.createElement("div");
        horseEl.classList.add("horse");
        // Seleccionamos aleatoriamente un emoji de caballo
        const horseEmojis = ["üêé", "üèá", "üê¥"];
        horseEl.textContent = horseEmojis[Math.floor(Math.random() * horseEmojis.length)];
        // Insertamos el caballo en la celda correspondiente
        updateHorsePosition();
      }
      
      function updateHorsePosition() {
        // Buscar la celda que corresponde a horsePosition
        const cells = document.querySelectorAll("#labyrinth-container .lab-cell");
        cells.forEach(cell => {
          if (parseInt(cell.dataset.row) === horsePosition.row && parseInt(cell.dataset.col) === horsePosition.col) {
            cell.appendChild(horseEl);
          }
        });
        // Si el caballo ha llegado a la salida, resolvemos el laberinto
        if (horsePosition.row === LAB_ROWS - 1 && horsePosition.col === LAB_COLS - 1) {
          // Laberinto resuelto: ocultamos la secci√≥n y mostramos el candado
          document.getElementById("labyrinth-status").textContent = "¬°Has llegado al cofre!";
          setTimeout(() => {
            document.getElementById("labyrinth-section").style.display = "none";
            document.getElementById("combination-lock").style.display = "block";
          }, 1000);
        }
      }
      
      function moveHorse(direction) {
        const newPos = { row: horsePosition.row, col: horsePosition.col };
        if (direction === "N") newPos.row--;
        if (direction === "S") newPos.row++;
        if (direction === "E") newPos.col++;
        if (direction === "O") newPos.col--;
        // Verificamos que est√© dentro de la matriz y que la celda sea camino (0)
        if (newPos.row >= 0 && newPos.row < LAB_ROWS && newPos.col >= 0 && newPos.col < LAB_COLS) {
          if (labyrinthMatrix[newPos.row][newPos.col] === 0) {
            horsePosition = newPos;
            updateHorsePosition();
            document.getElementById("labyrinth-status").textContent = "Camino: (" + horsePosition.row + "," + horsePosition.col + ")";
          } else {
            document.getElementById("labyrinth-status").textContent = "¬°No puedes ir por esa ruta!";
          }
        }
      }
      
      // Funci√≥n para manejar botones y gestos del laberinto
      function chooseDirection(dir) {
        moveHorse(dir);
      }
      
      function enableLaberintoSwipe() {
        const labyrinth = document.getElementById("labyrinth-section");
        let touchstartX = 0, touchstartY = 0, touchendX = 0, touchendY = 0;
        const minSwipeDistance = 30;
        labyrinth.addEventListener('touchstart', (e) => {
          touchstartX = e.changedTouches[0].screenX;
          touchstartY = e.changedTouches[0].screenY;
        }, false);
        labyrinth.addEventListener('touchend', (e) => {
          touchendX = e.changedTouches[0].screenX;
          touchendY = e.changedTouches[0].screenY;
          const diffX = touchendX - touchstartX;
          const diffY = touchendY - touchstartY;
          if (Math.abs(diffX) > Math.abs(diffY)) {
            if (Math.abs(diffX) > minSwipeDistance) {
              diffX > 0 ? chooseDirection("E") : chooseDirection("O");
            }
          } else {
            if (Math.abs(diffY) > minSwipeDistance) {
              diffY > 0 ? chooseDirection("S") : chooseDirection("N");
            }
          }
        }, false);
      }
      
      // --- Candado (Combination Lock) ---
      let secretCombination = "";
      function generateCombinationLock() {
        // Generamos una combinaci√≥n de 4 d√≠gitos aleatorios
        secretCombination = "";
        for (let i = 0; i < 4; i++) {
          secretCombination += Math.floor(Math.random() * 10);
        }
        // (La pista puede ser mostrada aqu√≠ si se desea, pero en este ejemplo se deja en blanco)
        console.log("Combinaci√≥n secreta:", secretCombination);
      }
      
      function initCombinationLock() {
        // Se muestra el panel de candado y se genera la combinaci√≥n secreta.
        generateCombinationLock();
        // Para cada dial, se asigna el valor inicial 0 (ya lo tiene en el HTML)
        const dials = document.querySelectorAll(".dial");
        dials.forEach(d => {
          d.setAttribute("data-digit", "0");
          d.textContent = "0";
          d.addEventListener("click", () => {
            // Al hacer click, incrementa el d√≠gito (mod 10)
            let current = parseInt(d.getAttribute("data-digit"));
            current = (current + 1) % 10;
            d.setAttribute("data-digit", current);
            d.textContent = current;
          });
        });
      }
      
      function checkCombination() {
        // Se recogen los d√≠gitos de los 4 diales
        const dials = document.querySelectorAll(".dial");
        let userCombination = "";
        dials.forEach(d => {
          userCombination += d.getAttribute("data-digit");
        });
        if (userCombination === secretCombination) {
          document.getElementById("combination-status").textContent = "¬°Candado desbloqueado!";
          completeCastleChallenge();
        } else {
          document.getElementById("combination-status").textContent = "Combinaci√≥n incorrecta. Int√©ntalo de nuevo.";
        }
      }
      
      /*----------------------------------------*/
      /* 5. Reto del Cofre (alternativo)         */
      /*----------------------------------------*/
      // Se mantiene la funci√≥n para el reto del cofre tradicional (opcional)
      let currentChestKey = "";
      function generateChestKey() {
        const keys = [
          { date: "1834", clue: "la fecha en que se instal√≥ un cementerio dentro de los muros del castillo." },
          { date: "1949", clue: "la fecha en que se declar√≥ Bien de Inter√©s Cultural." },
          { date: "2010", clue: "la fecha en que se realiz√≥ la renovaci√≥n para transformar el castillo en un Centro de Interpretaci√≥n de la Biosfera." }
        ];
        const randomIndex = Math.floor(Math.random() * keys.length);
        currentChestKey = keys[randomIndex].date;
        document.getElementById("chest-hint").textContent = "Pista: La clave corresponde a " + keys[randomIndex].clue;
      }
      
      function checkChestKey() {
        const key = document.getElementById("chest-key").value.trim();
        if (key === currentChestKey) {
          document.getElementById("chest-status").textContent = "¬°Cofre abierto! Has descifrado el enigma.";
          completeCastleChallenge();
        } else {
          document.getElementById("chest-status").textContent = "Clave incorrecta. Vuelve a intentarlo.";
        }
      }
      
      function completeCastleChallenge() {
        document.getElementById("castle-challenge").style.display = "none";
        unlockFinalFragment();
      }
      
      /*----------------------------------------*/
      /* 6. Fragmento Final / Continuar         */
      /*----------------------------------------*/
      let challengeCompleted = false;
      function unlockFinalFragment() {
        if (!challengeCompleted) {
          challengeCompleted = true;
          document.getElementById("fragmento-final").style.display = "block";
          document.getElementById("continue-button").style.display = "block";
          updateChronicle();
          updateRanking();
          playSound("cheers-sound");
        }
      }
      
      function updateChronicle() {
        localStorage.setItem("cronica_castillo", document.getElementById("message-piece").textContent);
      }
      
      function updateRanking() {
        let ranking = JSON.parse(localStorage.getItem("ranking")) || [];
        ranking.push({ stop: "castillo", score: 100 });
        localStorage.setItem("ranking", JSON.stringify(ranking));
      }
      
      /*----------------------------------------*/
      /* 7. SONIDOS                             */
      /*----------------------------------------*/
      function playSound(id) {
        const sound = document.getElementById(id);
        if (sound) sound.play();
      }
      
      /*----------------------------------------*/
      /* 8. BOT√ìN DE M√öSICA                      */
      /*----------------------------------------*/
      document.addEventListener('DOMContentLoaded', () => {
        const musicBtn = document.querySelector('.music-btn');
        const backgroundMusic = document.getElementById('background-music');
        musicBtn.addEventListener('click', () => {
          if (backgroundMusic.paused) {
            backgroundMusic.play();
            musicBtn.innerHTML = '<span class="music-icon">üéµ</span> Pausar M√∫sica';
          } else {
            backgroundMusic.pause();
            musicBtn.innerHTML = '<span class="music-icon">üîá</span> Reproducir M√∫sica';
          }
        });
      });
      
      /*----------------------------------------*/
      /* 9. LOCALSTORAGE                        */
      /*----------------------------------------*/
      localStorage.setItem("castillo-completed", "true");
      
      // Para iniciar el juego, el desbloqueo de la ubicaci√≥n mostrar√° el contenido.
    </script>
  </div>
</body>
</html>
