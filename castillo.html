<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè∞ El Castillo de Gonzalo</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg">
  <style>
    /* --- Estilos Globales --- */
    body {
      font-family: Arial, sans-serif;
      background: url('images/fondo-castillo.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container {
      max-width: 960px;
      margin: auto;
      background: rgba(255,248,228,0.95);
      border: 3px double #5e3b1b;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      position: relative;
    }
    header h1 {
      text-align: center;
    }
    .action-btn {
      display: inline-block;
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      background: #dec79b;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .music-control {
      text-align: center;
      margin-bottom: 10px;
    }
    /* --- Verificaci√≥n de Ubicaci√≥n --- */
    #location-check {
      text-align: center;
      margin-bottom: 30px;
    }
    #location-check input {
      padding: 8px;
      font-size: 16px;
      width: 200px;
      margin: 10px;
      border: 1px solid #5e3b1b;
      border-radius: 4px;
    }
    #location-status {
      margin-top: 10px;
      font-size: 1.1em;
      color: red;
    }
    #direction-arrow {
      width: 50px;
      margin-top: 10px;
    }
    /* --- Carrusel Principal --- */
    .carousel {
      position: relative;
      overflow: hidden;
      margin-bottom: 20px;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
    }
    .carousel-slides {
      display: flex;
      transition: transform 0.5s ease;
      width: 300%; /* 3 diapositivas */
    }
    .slide {
      flex: 0 0 100%;
      box-sizing: border-box;
      text-align: center;
      padding: 10px;
    }
    .slide img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #6e3b1b;
    }
    .carousel-info {
      margin-top: 10px;
      line-height: 1.4;
    }
    .carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.7);
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
    }
    .prev-slide { left: 10px; }
    .next-slide { right: 10px; }
    /* --- Secciones de Retos y Quiz --- */
    .visual-challenge,
    .quiz {
      margin: 20px 0;
      text-align: center;
    }
    .hint-btn {
      margin: 5px;
      padding: 5px 10px;
      font-size: 14px;
      background: #f0e68c;
      border: 1px solid #5e3b1b;
      border-radius: 5px;
      cursor: pointer;
    }
    /* --- Minijuego del Candado (Combination Lock) --- */
    #combination-lock {
      display: none;
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      background: #fff;
    }
    #combination-lock h2 { margin-bottom: 10px; }
    #dials {
      margin-bottom: 10px;
    }
    .dial {
      display: inline-block;
      width: 60px;
      height: 60px;
      margin: 5px;
      border: 2px solid #5e3b1b;
      border-radius: 50%;
      background: #dec79b;
      font-size: 24px;
      line-height: 60px;
      cursor: pointer;
      user-select: none;
    }
    #check-combination {
      margin-top: 10px;
    }
    /* --- Fragmento Final --- */
    .fragmento-final {
      margin: 20px auto;
      display: none;
      text-align: center;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      padding: 40px 20px;
      font-style: italic;
      font-size: 1.2em;
      font-weight: bold;
      border-radius: 10px;
    }
    #continue-button {
      text-align: center;
      margin-top: 15px;
      display: none;
    }
    footer p {
      text-align: center;
      font-size: 0.9em;
      margin-top: 20px;
    }
    @media screen and (max-width: 768px) {
      .container { max-width: 90%; }
      .dial { width: 50px; height: 50px; line-height: 50px; font-size: 20px; }
    }
    /* --- Adornos Medievales --- */
    .container:before {
      content: "‚öîÔ∏è";
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 32px;
      color: #5e3b1b;
    }
    .container:after {
      content: "üõ°Ô∏è";
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 32px;
      color: #5e3b1b;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè∞ El Castillo de Gonzalo</h1>
      <div class="music-control">
        <button class="action-btn music-btn" onclick="toggleMusic()">
          <span class="music-icon">üéµ</span> Pausar M√∫sica
        </button>
      </div>
      <div class="stop-selector">
        <!-- Botones para navegar entre paradas, por ejemplo -->
        <button class="action-btn" onclick="window.location.href='castillo.html'">Castillo</button>
        <button class="action-btn" onclick="window.location.href='plaza.html'">Plaza</button>
        <button class="action-btn" onclick="window.location.href='iglesia.html'">Iglesia</button>
        <button class="action-btn" onclick="window.location.href='fuente.html'">Fuente y Portal√≥n</button>
        <!-- etc. -->
      </div>
    </header>

    <section id="content">
      <div class="stop-icon">üè∞</div>
      <!-- Verificaci√≥n de Ubicaci√≥n -->
      <div id="location-check">
        <h2>Verifica tu ubicaci√≥n</h2>
        <p>Ac√©rcate a la puerta principal del Castillo de San Mart√≠n para iniciar la b√∫squeda del mensaje.</p>
        <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
        <p>O ingresa el nombre:</p>
        <input type="text" id="location-input" placeholder="Ej: Castillo">
        <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
        <p id="location-status"></p>
        <canvas id="sonar-radar" width="200" height="200"></canvas>
      </div>

      <!-- Contenido del Juego (se muestra tras la verificaci√≥n) -->
      <div id="game-content" style="display: none;">
        <div class="content-wrapper">
          <!-- Carrusel -->
          <div class="carousel">
            <div class="carousel-slides" id="main-carousel">
              <div class="slide active" data-slide="0">
                <img src="images/castillo-entrada.jpg" alt="Entrada del Castillo">
                <p class="carousel-info">
                  <strong>Entrada Fortificada:</strong> Construida en el siglo XIII como defensa en la Reconquista. En el siglo XV el castillo fue remodelado en palacio por el Conde de Miranda. Tambi√©n sirvi√≥ como c√°rcel en el siglo XVIII. <span class="hidden-detail" onclick="revealHint('Explora el castillo a su alrededor y entra hasta la parte m√°s alta, desde all√≠ se ven algunos paredones.')">¬°Busca aqu√≠!</span>
                </p>
              </div>
              <div class="slide" data-slide="1">
                <img src="images/castillo-torre.jpg" alt="Torre del Homenaje">
                <p class="carousel-info">
                  <strong>Torre del Homenaje:</strong> Da√±ada por un rayo en el siglo XX y restaurada para contar su historia, ofrece una de las mejores vistas de toda la Sierra de Francia.
                </p>
              </div>
              <div class="slide" data-slide="2">
                <img src="images/castillo-vista.jpg" alt="Vista Panor√°mica">
                <p class="carousel-info">
                  <strong>Vista Panor√°mica:</strong> Hoy, el Centro de Interpretaci√≥n ofrece vistas a las sierras de B√©jar y Francia desde la torre. Desde 1834 alberga el cementerio municipal.
                </p>
              </div>
            </div>
            <button class="carousel-btn prev-slide">‚Üê</button>
            <button class="carousel-btn next-slide">‚Üí</button>
          </div>

          <!-- Retos Visuales -->
          <div class="visual-challenge">
            <h2>Retos Visuales: Afina tus sentidos</h2>
            <p>1. ¬øQu√© marc√≥ la torre del homenaje?</p>
            <div id="visual-opciones-1">
              <button class="action-btn" onclick="checkVisualAnswer('Incendio', 'Rayo', 1)">Incendio</button>
              <button class="action-btn" onclick="checkVisualAnswer('Rayo', 'Rayo', 1)">Rayo</button>
              <button class="action-btn" onclick="checkVisualAnswer('Terremoto', 'Rayo', 1)">Terremoto</button>
            </div>
            <p id="visual-resultado-1"></p>
            <button class="hint-btn" onclick="showHint('Un rel√°mpago del siglo XX dej√≥ su huella.')">Pista</button>

            <p>2. ¬øQu√© destaca en la entrada fortificada?</p>
            <div id="visual-opciones-2">
              <button class="action-btn" onclick="checkVisualAnswer('Arcos', 'Muralla', 2)">Arcos</button>
              <button class="action-btn" onclick="checkVisualAnswer('Muralla', 'Muralla', 2)">Muralla</button>
              <button class="action-btn" onclick="checkVisualAnswer('Torreones', 'Muralla', 2)">Torreones</button>
            </div>
            <p id="visual-resultado-2"></p>
            <button class="hint-btn" onclick="showHint('Es lo que rodea la entrada.')">Pista</button>
          </div>
        </div>

        <!-- Quiz Hist√≥rico -->
        <div class="quiz">
          <h2>Quiz: Descubre el mensaje</h2>
          <p>1. ¬øEn qu√© siglo naci√≥ este castillo?</p>
          <div id="quiz-opciones-1">
            <button class="action-btn" onclick="checkAnswer('XII', 'XIII', 1)">XII</button>
            <button class="action-btn" onclick="checkAnswer('XIII', 'XIII', 1)">XIII</button>
            <button class="action-btn" onclick="checkAnswer('XIV', 'XIII', 1)">XIV</button>
          </div>
          <p id="quiz-resultado-1"></p>
          <button class="hint-btn" onclick="showHint('Fue durante la Reconquista.')">Pista</button>

          <p>2. ¬øQu√© alberga el recinto desde 1834?</p>
          <div id="quiz-opciones-2">
            <button class="action-btn" onclick="checkAnswer('Discoteca', 'Cementerio', 2)">Discoteca</button>
            <button class="action-btn" onclick="checkAnswer('Cementerio', 'Cementerio', 2)">Cementerio</button>
            <button class="action-btn" onclick="checkAnswer('Parque infantil', 'Cementerio', 2)">Parque infantil</button>
          </div>
          <p id="quiz-resultado-2"></p>
          <button class="hint-btn" onclick="showHint('Un descanso muy largo, se puede decir eterno.')">Pista</button>

          <p>3. ¬øQu√© ofrece hoy el castillo?</p>
          <div id="quiz-opciones-3">
            <button class="action-btn" onclick="checkAnswer('Museo', 'Centro de Interpretaci√≥n', 3)">Museo</button>
            <button class="action-btn" onclick="checkAnswer('Centro de Interpretaci√≥n', 'Centro de Interpretaci√≥n', 3)">Centro de Interpretaci√≥n</button>
            <button class="action-btn" onclick="checkAnswer('Biblioteca', 'Centro de Interpretaci√≥n', 3)">Biblioteca</button>
          </div>
          <p id="quiz-resultado-3"></p>
          <button class="hint-btn" onclick="showHint('¬øDe verdad necesitas una pista? Tiene que ver con la biosfera.')">Pista</button>
        </div>

        <!-- Minijuego: Candado para el Cofre -->
        <div id="combination-lock">
          <h2>Candado del Cofre</h2>
          <p>Gira los diales para formar la combinaci√≥n correcta.</p>
          <div id="dials">
            <div class="dial" data-digit="0">0</div>
            <div class="dial" data-digit="0">0</div>
            <div class="dial" data-digit="0">0</div>
            <div class="dial" data-digit="0">0</div>
          </div>
          <button class="action-btn" id="check-combination" onclick="checkCombination()">Comprobar Combinaci√≥n</button>
          <p id="combination-status"></p>
        </div>

        <!-- Fragmento Final -->
        <div class="fragmento-final" id="fragmento-final">
          <p>
            <strong>Fragmento del Mensaje:</strong>
            <span id="message-piece" style="display: none;">"El secreto"</span>
          </p>
          <p><strong>QR en el pueblo:</strong> CASTILLO-1523 (cerca de la entrada).</p>
          <p><strong>Dato Curioso:</strong> Cer√°micas y monedas del siglo XIII halladas aqu√≠ inspiraron a Gonzalo.</p>
        </div>

        <div id="continue-button" style="display: none;">
          <button class="action-btn" onclick="window.location.href='felicitaciones.html?stop=castillo'">Continuar b√∫squeda</button>
        </div>
      </div>
    </section>

    <!-- Audios -->
    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
    <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
    <audio id="coins-sound" src="sounds/coins.mp3" preload="auto"></audio>
    <audio id="ambient-sound" src="sounds/musica-medieval-2.mp3" preload="auto" loop></audio>
    <audio id="sonar-ping" src="sounds/sonar-ping.mp3" preload="auto"></audio>
  </div>

  <footer>
    <p>¬© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a></p>
  </footer>

  <script>
    /* --- Funciones de verificaci√≥n de ubicaci√≥n --- */
    const targetLat = 40.123456,
          targetLon = -3.123456,
          thresholdDistance = 50;
    function checkLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(geoSuccess, locationError);
      } else {
        document.getElementById("location-status").textContent = "Tu navegador no soporta geolocalizaci√≥n.";
      }
    }
    function geoSuccess(position) {
      const lat = position.coords.latitude,
            lon = position.coords.longitude,
            distance = calculateDistance(lat, lon, targetLat, targetLon);
      if (distance <= thresholdDistance) {
        unlockStop();
      } else {
        document.getElementById("location-status").textContent = "No est√°s lo suficientemente cerca del Castillo.";
      }
    }
    function locationError(err) {
      document.getElementById("location-status").textContent = "Error al obtener tu ubicaci√≥n: " + err.message;
    }
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3,
            toRad = x => x * Math.PI / 180,
            œÜ1 = toRad(lat1),
            œÜ2 = toRad(lat2),
            ŒîœÜ = toRad(lat2 - lat1),
            ŒîŒª = toRad(lon2 - lon1),
            a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2,
            c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    function checkLocationManual() {
      const input = document.getElementById("location-input").value.trim().toLowerCase();
      if (input === "castillo" || input === "castillo de gonzalo") {
        unlockStop();
      } else {
        document.getElementById("location-status").textContent = "Nombre incorrecto. Int√©ntalo nuevamente.";
      }
    }
    function unlockStop() {
      document.getElementById("location-check").style.display = "none";
      document.getElementById("game-content").style.display = "block";
      initMainCarousel();
      playSound("ambient-sound");
    }
    
    /* --- Carrusel Principal --- */
    function initMainCarousel() {
      let currentSlide = 0;
      const slides = document.querySelectorAll('#main-carousel .slide');
      const totalSlides = slides.length;
      const prevButton = document.querySelector('.prev-slide');
      const nextButton = document.querySelector('.next-slide');
      const carouselContainer = document.querySelector('#main-carousel');
      // Ajusta el ancho total
      carouselContainer.style.width = (totalSlides * 100) + '%';
      function updateCarousel() {
        carouselContainer.style.transform = 'translateX(' + (-currentSlide * 100) + '%)';
      }
      prevButton.addEventListener('click', function() {
        currentSlide = (currentSlide > 0) ? currentSlide - 1 : totalSlides - 1;
        updateCarousel();
      });
      nextButton.addEventListener('click', function() {
        currentSlide = (currentSlide < totalSlides - 1) ? currentSlide + 1 : 0;
        updateCarousel();
      });
    }
    
    /* --- Retos Visuales y Quiz --- */
    let quiz1Correct = false, quiz2Correct = false, quiz3Correct = false;
    function checkVisualAnswer(selected, correct, n) {
      const result = document.getElementById('visual-resultado-' + n);
      if (selected === correct) {
        result.textContent = "¬°Correcto!";
        playSound("success-sound");
      } else {
        result.textContent = "Respuesta incorrecta...";
        playSound("error-sound");
      }
    }
    function checkAnswer(selected, correct, n) {
      const result = document.getElementById('quiz-resultado-' + n);
      if (selected === correct) {
        result.textContent = "¬°Correcto!";
        playSound("success-sound");
        if (n === 1) quiz1Correct = true;
        if (n === 2) quiz2Correct = true;
        if (n === 3) quiz3Correct = true;
      } else {
        result.textContent = "Incorrecto. Vuelve a intentarlo.";
        playSound("error-sound");
        if (n === 1) quiz1Correct = false;
        if (n === 2) quiz2Correct = false;
        if (n === 3) quiz3Correct = false;
      }
      if (quiz1Correct && quiz2Correct && quiz3Correct) {
        // Ocultar el quiz y mostrar el minijuego del candado (candado visible)
        document.querySelector('.quiz').style.display = "none";
        initCombinationLock();
      }
    }
    
    /* --- Minijuego: Candado (Combination Lock) --- */
    function initCombinationLock() {
      document.getElementById("combination-lock").style.display = "block";
      const dials = document.querySelectorAll(".dial");
      dials.forEach(dial => {
        dial.setAttribute("data-digit", "0");
        dial.textContent = "0";
        dial.addEventListener("click", () => {
          let digit = parseInt(dial.getAttribute("data-digit"));
          digit = (digit + 1) % 10;
          dial.setAttribute("data-digit", digit);
          dial.textContent = digit;
        });
      });
      generateSecretCombination();
    }
    
    let secretCombination = "";
    function generateSecretCombination() {
      const keys = ["1834", "1949", "2010"];
      secretCombination = keys[Math.floor(Math.random() * keys.length)];
      // Mostrar la pista en la consola (puedes opcionalmente revelar la pista en pantalla)
      console.log("Combinaci√≥n secreta:", secretCombination);
      // En este ejemplo, dejamos la pista en la secci√≥n de 'combination-lock'
      // O puedes agregar algo como: document.getElementById("combination-hint").textContent = "Pista: Busca la fecha oculta en las im√°genes del carrusel.";
      // Aqu√≠ a√±adiremos la pista a trav√©s de una funci√≥n a la que se puede llamar "showPista"
      showPista("La clave es la fecha que marca un cambio importante en la historia del castillo. ¬°B√∫scala en las im√°genes!");
    }
    
    function showPista(text) {
      // Puedes usar una alerta o agregar un elemento en pantalla para mostrar la pista
      alert("Pista: " + text);
    }
    
    function checkCombination() {
      const dials = document.querySelectorAll(".dial");
      let userCombination = "";
      dials.forEach(dial => {
        userCombination += dial.getAttribute("data-digit");
      });
      if (userCombination === secretCombination) {
        document.getElementById("combination-status").textContent = "¬°Candado desbloqueado!";
        unlockFinalFragment();
      } else {
        document.getElementById("combination-status").textContent = "Combinaci√≥n incorrecta. Int√©ntalo de nuevo.";
      }
    }
    
    /* --- Fragmento Final / Continuar --- */
    let challengeCompleted = false;
    function unlockFinalFragment() {
      if (!challengeCompleted) {
        challengeCompleted = true;
        document.getElementById("combination-lock").style.display = "none";
        document.getElementById("fragmento-final").style.display = "block";
        document.getElementById("continue-button").style.display = "block";
        updateChronicle();
        updateRanking();
        playSound("success-sound");
      }
    }
    
    function updateChronicle() {
      localStorage.setItem("cronica_castillo", "Fragmento: El secreto");
    }
    
    function updateRanking() {
      let ranking = JSON.parse(localStorage.getItem("ranking")) || [];
      ranking.push({ stop: "castillo", score: 100 });
      localStorage.setItem("ranking", JSON.stringify(ranking));
    }
    
    /* --- Bot√≥n de M√∫sica --- */
    function toggleMusic() {
      const backgroundMusic = document.getElementById('ambient-sound');
      const musicBtn = document.querySelector('.music-btn');
      if (backgroundMusic.paused) {
        backgroundMusic.play();
        musicBtn.innerHTML = '<span class="music-icon">üéµ</span> Pausar M√∫sica';
      } else {
        backgroundMusic.pause();
        musicBtn.innerHTML = '<span class="music-icon">üîá</span> Reproducir M√∫sica';
      }
    }
    
    /* --- Funci√≥n para reproducir sonidos --- */
    function playSound(id) {
      const sound = document.getElementById(id);
      if (sound) sound.play();
    }
    
    /* --- LOCALSTORAGE --- */
    localStorage.setItem("castillo-completed", "true");
  </script>
  
  <!-- Fin del minijuego: Panel del candado se coloca aqu√≠ (fuera de la estructura principal para mayor visibilidad) -->
  
  <script>
    // Se carga el script principal (si tu proyecto lo requiere, en este ejemplo todo est√° en l√≠nea)
  </script>
</body>
</html>
