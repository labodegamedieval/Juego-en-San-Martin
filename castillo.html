<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üè∞ Castillo de Gonzalo</title>
  <link rel="stylesheet" href="styles/style.css" />
  <link rel="icon" type="image/x-icon" href="images/escudo-borrado.ico" />
  <style>
    /* Estilos Globales */
    body {
      font-family: Arial, sans-serif;
      background: url('images/fondo-castillo.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      color: #333;
      touch-action: manipulation;
    }
    .container {
      max-width: 960px;
      margin: auto;
      background: rgba(255, 248, 228, 0.95);
      border: 3px double #5e3b1b;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
      position: relative;
    }
    header h1 {
      text-align: center;
    }
    .action-btn {
      display: inline-block;
      margin: 8px;
      padding: 12px 24px;
      font-size: 16px;
      background: #dec79b;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      transition: background 0.3s ease;
      min-width: 48px;
      min-height: 48px;
      touch-action: manipulation;
      z-index: 10;
    }
    .action-btn:hover {
      background: #d1b88a;
    }
    .action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .music-control {
      text-align: center;
      margin-bottom: 15px;
    }

    /* Verificaci√≥n de Ubicaci√≥n */
    #location-check {
      text-align: center;
      margin-bottom: 30px;
    }
    #location-check input {
      padding: 10px;
      font-size: 16px;
      width: 220px;
      margin: 12px;
      border: 1px solid #5e3b1b;
      border-radius: 4px;
    }
    #location-status {
      margin-top: 12px;
      font-size: 1.1em;
      color: red;
      min-height: 24px;
    }
    #sonar-radar {
      margin-top: 12px;
    }

    /* Contenido del Juego */
    #game-content {
      display: none;
      aria-hidden: true;
    }

    /* Carrusel */
    .carousel-container {
      position: relative;
      overflow: hidden;
      width: 100%;
      margin-bottom: 20px;
      border-radius: 10px;
      border: 2px solid #5e3b1b;
    }
    .carousel-slides {
      display: flex;
      transition: transform 0.5s ease;
    }
    .carousel-slide {
      min-width: 100%;
      box-sizing: border-box;
      text-align: center;
    }
    .carousel-slide img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      display: block;
      border-radius: 10px;
      border: 2px solid #6b3e2e;
    }
    .carousel-slide p {
      font-family: "Georgia", serif;
      font-size: 16px;
      color: #2e2e2e;
      line-height: 1.6;
      margin: 15px auto;
      max-width: 800px;
    }
    .carousel-slide a {
      color: #5e3b1b;
      text-decoration: underline;
    }
    .carousel-slide a:hover {
      color: #a65c3a;
    }
    .carousel-prev, .carousel-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.7);
      border: none;
      font-size: 28px;
      cursor: pointer;
      padding: 12px;
      border-radius: 50%;
      transition: background 0.3s ease;
      min-width: 48px;
      min-height: 48px;
      touch-action: manipulation;
      z-index: 20;
    }
    .carousel-prev:hover, .carousel-next:hover {
      background: rgba(255, 255, 255, 0.9);
    }
    .carousel-prev { left: 12px; }
    .carousel-next { right: 12px; }

    /* Retos Visuales y Quiz */
    .visual-challenge, .quiz {
      margin: 30px 0;
      text-align: center;
    }
    .visual-challenge p, .quiz p {
      margin: 15px 0;
      min-height: 24px;
      font-size: 16px;
    }
    .visual-challenge div, .quiz div {
      margin: 15px 0;
    }
    .hint-btn {
      margin: 8px;
      padding: 8px 12px;
      font-size: 14px;
      background: #f0e68c;
      border: 1px solid #5e3b1b;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
      min-width: 48px;
      min-height: 48px;
      touch-action: manipulation;
      z-index: 10;
    }
    .hint-btn:hover {
      background: #e8de7e;
    }
    #visual-resultado-1, #visual-resultado-2, #quiz-resultado-1, #quiz-resultado-2, #quiz-resultado-3 {
      min-height: 24px;
      margin-top: 15px;
      font-size: 14px;
    }

    /* Minijuego: Candado del Cofre */
    #combination-lock {
      display: none;
      text-align: center;
      margin-top: 30px;
      padding: 15px;
      border-radius: 10px;
      position: relative;
    }
    #combination-lock h2 {
      margin-bottom: 15px;
    }
    .cofre-container {
      position: relative;
      display: inline-block;
      margin: 0 auto;
      max-width: 600px;
      width: 100%;
    }
    .cofre-img {
      width: 100%;
      height: auto;
      display: block;
      z-index: 1;
    }
    #dials {
      position: absolute;
      top: 35%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 15;
    }
    .dial {
      width: 48px;
      height: 48px;
      margin: 0;
      border: 2px solid #5e3b1b;
      border-radius: 50%;
      background: #dec79b;
      font-size: 24px;
      line-height: 48px;
      cursor: pointer;
      user-select: none;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      text-align: center;
      touch-action: manipulation;
      z-index: 15;
      transition: transform 0.2s ease;
    }
    .dial:active {
      transform: rotate(10deg);
    }
    #check-combination, #combination-status {
      margin-top: 80px;
      z-index: 10;
      position: relative;
    }
    #combination-status {
      min-height: 24px;
      font-size: 14px;
    }
    #check-combination {
      margin-bottom: 15px;
    }

    /* Pista para el Candado (Pergamino) */
    #pista-lock {
      display: none;
      margin-top: 15px;
      padding: 15px;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      text-align: center;
      z-index: 10;
      position: relative;
    }
    #pista-lock p {
      font-size: 16px;
      color: #000;
      margin: 10px 0;
      min-height: 24px;
    }
    #pista-lock button {
      margin-top: 12px;
      padding: 8px 12px;
      font-size: 14px;
      background: #dec79b;
      border: 1px solid #5e3b1b;
      border-radius: 5px;
      cursor: pointer;
      min-width: 48px;
      min-height: 48px;
      touch-action: manipulation;
    }

    /* Fragmento Final */
    #fragmento-final {
      margin: 30px auto;
      display: none;
      text-align: center;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      padding: 40px 20px;
      font-style: italic;
      font-size: 1.2em;
      font-weight: bold;
      border-radius: 10px;
    }
    #fragmento-final p {
      margin: 15px 0;
    }
    #continue-button {
      text-align: center;
      margin-top: 20px;
      display: none;
    }
    footer p {
      text-align: center;
      font-size: 0.9em;
      margin-top: 25px;
    }

    /* Media Queries */
    @media screen and (max-width: 768px) {
      .container {
        max-width: 90%;
      }
      .action-btn {
        padding: 10px 20px;
        font-size: 14px;
        min-width: 48px;
        min-height: 48px;
      }
      .dial {
        width: 44px;
        height: 44px;
        line-height: 44px;
        font-size: 20px;
      }
      .carousel-slide img {
        height: 200px;
      }
      .carousel-prev, .carousel-next {
        font-size: 24px;
        padding: 10px;
        min-width: 48px;
        min-height: 48px;
      }
      #dials {
        top: 30%;
        gap: 10px;
      }
      #location-check input {
        width: 200px;
        padding: 8px;
      }
      .visual-challenge p, .quiz p {
        font-size: 14px;
        margin: 12px 0;
      }
      .visual-challenge div, .quiz div {
        margin: 12px 0;
      }
      #visual-resultado-1, #visual-resultado-2, #quiz-resultado-1, #quiz-resultado-2, #quiz-resultado-3 {
        font-size: 13px;
        margin-top: 12px;
      }
      .carousel-slide p {
        font-size: 14px;
        margin: 12px auto;
      }
      #check-combination, #combination-status {
        margin-top: 60px;
      }
    }

    /* Adornos Medievales */
    .container:before {
      content: "‚öîÔ∏è";
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 32px;
      color: #5e3b1b;
      z-index: 5;
    }
    .container:after {
      content: "üõ°Ô∏è";
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 32px;
      color: #5e3b1b;
      z-index: 5;
    }
  </style>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-GE0YB9PL8Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-GE0YB9PL8Q');
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè∞ Castillo de Gonzalo</h1>
      <div class="music-control">
        <button class="action-btn music-btn" aria-label="Controlar m√∫sica">
          <span class="music-icon">üîá</span> Reproducir M√∫sica
        </button>
      </div>
    </header>

    <section id="content">
      <div class="stop-icon">üè∞</div>
      <!-- Verificaci√≥n de Ubicaci√≥n -->
      <div id="location-check">
        <h2>Verifica tu ubicaci√≥n</h2>
        <p>Ac√©rcate a la puerta principal del Castillo de San Mart√≠n para iniciar la b√∫squeda del mensaje.</p>
        <button class="action-btn" aria-label="Verificar ubicaci√≥n con GPS">Verificar GPS</button>
        <p>O ingresa el nombre:</p>
        <input type="text" id="location-input" placeholder="Ej: Castillo" aria-label="Ingresar nombre de ubicaci√≥n" />
        <button class="action-btn" aria-label="Verificar ubicaci√≥n manualmente">Verificar Manual</button>
        <p id="location-status"></p>
        <canvas id="sonar-radar" width="200" height="200" aria-label="Radar de localizaci√≥n"></canvas>
      </div>

      <!-- Contenido del Juego (tras verificaci√≥n) -->
      <div id="game-content">
        <div class="content-wrapper">
          <!-- Carrusel con tres im√°genes, texto descriptivo y contexto hist√≥rico -->
          <div class="carousel-container">
            <div class="carousel-slides">
              <!-- Slide 1 -->
              <div class="carousel-slide">
                <img src="images/castillo-entrada.jpg" alt="Entrada fortificada del Castillo de San Mart√≠n" />
                <p>
                  <strong>Entrada Fortificada:</strong> Construida en el siglo XIII, sirvi√≥ de defensa en la Reconquista y fue remodelada en el siglo XV. <br>
                  <em>1834:</em> Se traslad√≥ el cementerio local dentro de los muros del castillo. <br>
                  <a href="https://sanmartindelcasta√±ar.es/castillo-de-la-biosfera/" target="_blank" rel="noopener noreferrer">M√°s informaci√≥n</a>
                </p>
              </div>
              <!-- Slide 2 -->
              <div class="carousel-slide">
                <img src="images/castillo-torre.jpg" alt="Torre del Homenaje del Castillo de San Mart√≠n" style="object-fit: contain; height: auto; max-height: 300px;" />
                <p>
                  <strong>Torre del Homenaje:</strong> Da√±ada por un rayo a principios del siglo XX, fue restaurada y ofrece vistas espectaculares. <br>
                  <em>1949:</em> Declarada Bien de Inter√©s Cultural. <br>
                  <a href="https://www.turismocastillayleon.com/es/patrimonio-cultura/castillo-san-martin-castanar" target="_blank" rel="noopener noreferrer">M√°s informaci√≥n</a>
                </p>
              </div>
              <!-- Slide 3 -->
              <div class="carousel-slide">
                <img src="images/castillo-vista.jpg" alt="Vista panor√°mica desde el Castillo de San Mart√≠n" />
                <p>
                  <strong>Vista Panor√°mica:</strong> Desde aqu√≠ se observan las sierras de B√©jar y Francia, impregnadas de historia. <br>
                  <em>2010:</em> Reformada para albergar el Centro de Interpretaci√≥n de la Biosfera de las Sierras de Francia y B√©jar. <br>
                  <a href="https://www.castillosdeespa√±a.es/es/content/san-martin-del-castanar/" target="_blank" rel="noopener noreferrer">M√°s informaci√≥n</a>
                </p>
              </div>
            </div>
            <button class="carousel-prev" aria-label="Diapositiva anterior">‚ùÆ</button>
            <button class="carousel-next" aria-label="Diapositiva siguiente">‚ùØ</button>
          </div>

          <!-- Retos Visuales -->
          <div class="visual-challenge">
            <h2>Retos Visuales: Afina tus sentidos</h2>
            <p id="visual-pregunta-1">1. ¬øQu√© destaca en la fachada principal del castillo?</p>
            <div id="visual-opciones-1">
              <button class="action-btn" aria-label="Seleccionar Escudos como respuesta">Escudos</button>
              <button class="action-btn" aria-label="Seleccionar Muralla como respuesta">Muralla</button>
              <button class="action-btn" aria-label="Seleccionar Columnas como respuesta">Columnas</button>
            </div>
            <p id="visual-resultado-1"></p>

            <p id="visual-pregunta-2">2. ¬øCu√°ntas torres ten√≠a originalmente el castillo?</p>
            <div id="visual-opciones-2">
              <button class="action-btn" aria-label="Seleccionar 1 torre como respuesta">1</button>
              <button class="action-btn" aria-label="Seleccionar 2 torres como respuesta">2</button>
              <button class="action-btn" aria-label="Seleccionar 3 torres como respuesta">3</button>
            </div>
            <p id="visual-resultado-2"></p>
          </div>
        </div>

        <!-- Quiz Hist√≥rico -->
        <div class="quiz">
          <h2>Quiz: Descubre el mensaje</h2>
          <p id="quiz-pregunta-1">1. ¬øEn qu√© siglo se funda esta fortificaci√≥n?</p>
          <div id="quiz-opciones-1">
            <button class="action-btn" aria-label="Seleccionar siglo XII como respuesta">XII</button>
            <button class="action-btn" aria-label="Seleccionar siglo XIII como respuesta">XIII</button>
            <button class="action-btn" aria-label="Seleccionar siglo XIV como respuesta">XIV</button>
          </div>
          <p id="quiz-resultado-1"></p>

          <p id="quiz-pregunta-2">2. ¬øQu√© alberga el castillo desde el siglo XIX?</p>
          <div id="quiz-opciones-2">
            <button class="action-btn" aria-label="Seleccionar Discoteca como respuesta">Discoteca</button>
            <button class="action-btn" aria-label="Seleccionar Cementerio municipal como respuesta">Cementerio municipal</button>
            <button class="action-btn" aria-label="Seleccionar Museo como respuesta">Museo</button>
          </div>
          <p id="quiz-resultado-2"></p>

          <p id="quiz-pregunta-3">3. ¬øQu√© funci√≥n tiene actualmente el castillo?</p>
          <div id="quiz-opciones-3">
            <button class="action-btn" aria-label="Seleccionar Museo como respuesta">Museo</button>
            <button class="action-btn" aria-label="Seleccionar Centro de Interpretaci√≥n de la Biosfera como respuesta">Centro de Interpretaci√≥n de la Biosfera</button>
            <button class="action-btn" aria-label="Seleccionar Biblioteca como respuesta">Biblioteca</button>
          </div>
          <p id="quiz-resultado-3"></p>
        </div>

        <!-- Minijuego: Candado del Cofre -->
        <div id="combination-lock">
          <h2>Candado del Cofre</h2>
          <div class="cofre-container">
            <img src="images/baul.png" alt="Cofre antiguo con candado" class="cofre-img" />
            <div id="dials">
              <div class="dial" data-digit="0" role="button" aria-label="Girar dial 1">0</div>
              <div class="dial" data-digit="0" role="button" aria-label="Girar dial 2">0</div>
              <div class="dial" data-digit="0" role="button" aria-label="Girar dial 3">0</div>
              <div class="dial" data-digit="0" role="button" aria-label="Girar dial 4">0</div>
            </div>
          </div>
          <button class="action-btn" id="check-combination" aria-label="Comprobar combinaci√≥n del candado">Comprobar Combinaci√≥n</button>
          <p id="combination-status"></p>
          <button class="hint-btn" aria-label="Mostrar u ocultar pista para el candado">Pista para el Candado</button>
          <div id="pista-lock">
            <p id="pista-texto"></p>
            <button class="action-btn" aria-label="Cerrar pista del candado">Cerrar Pista</button>
          </div>
        </div>

        <!-- Fragmento Final -->
        <div class="fragmento-final" id="fragmento-final">
          <p>
            <strong>Fragmento del Mensaje: Oculto </strong>
            <span id="message-piece" style="display: none;">"El secreto del castillo"</span>
          </p>
          <p><strong>QR en el pueblo:</strong> CASTILLO (busca en la entrada principal).</p>
          <p><strong>Dato Curioso:</strong> Cer√°micas y monedas del siglo XIII halladas aqu√≠ inspiraron a Gonzalo.</p>
        </div>

        <div id="continue-button">
          <button class="action-btn" aria-label="Continuar con la b√∫squeda">Continuar b√∫squeda</button>
        </div>
      </div>
    </section>

    <!-- Audios -->
    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
    <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
    <audio id="coins-sound" src="sounds/coins.mp3" preload="auto"></audio>
    <audio id="ambient-sound" src="sounds/musica-medieval.mp3" preload="auto" loop></audio>
    <audio id="sonar-ping" src="sounds/sonar-ping.mp3" preload="auto"></audio>
  </div>

  <footer>
    <p>¬© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank" rel="noopener noreferrer">Reserva tu visita</a></p>
  </footer>

  <script defer>
    // --- VERIFICACI√ìN DE UBICACI√ìN ---
    const targetLat = 40.520512;
    const targetLon = -6.063541;
    const thresholdDistance = 10;

    function checkLocation(event) {
      if (event) event.preventDefault();
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(geoSuccess, locationError);
      } else {
        document.getElementById("location-status").textContent =
          "Tu navegador no soporta geolocalizaci√≥n.";
      }
    }

    function geoSuccess(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const distance = calculateDistance(lat, lon, targetLat, targetLon);
      if (distance <= thresholdDistance) {
        unlockStop();
      } else {
        document.getElementById("location-status").textContent =
          `Est√°s a ${Math.round(distance)} metros de la parada. Ac√©rcate un poco m√°s.`;
      }
    }

    function locationError(err) {
      document.getElementById("location-status").textContent =
        "Error al obtener tu ubicaci√≥n: " + err.message;
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = (x) => x * Math.PI / 180;
      const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
      const ŒîœÜ = toRad(lat2 - lat1), ŒîŒª = toRad(lon2 - lon1);
      const a = Math.sin(ŒîœÜ / 2) ** 2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function checkLocationManual(event) {
      if (event) event.preventDefault();
      const input = document.getElementById("location-input").value.trim().toLowerCase();
      if (input === "castillo") {
        unlockStop();
      } else {
        document.getElementById("location-status").textContent =
          "Nombre incorrecto. Int√©ntalo nuevamente.";
      }
    }

    function unlockStop() {
      document.getElementById("location-check").style.display = "none";
      document.getElementById("game-content").style.display = "block";
      document.getElementById("game-content").setAttribute("aria-hidden", "false");
      initCarousel();
      initGameButtons();
      aplicarIdiomaCastillo();
    }

    // --- CARRUSEL ---
    function initCarousel() {
      const carouselContainer = document.querySelector('.carousel-slides');
      const slides = document.querySelectorAll('.carousel-slide');
      const prevBtn = document.querySelector('.carousel-prev');
      const nextBtn = document.querySelector('.carousel-next');
      if (!carouselContainer || !slides.length || !prevBtn || !nextBtn) {
        console.error("Error: Elementos del carrusel no encontrados");
        return;
      }

      let currentSlide = 0;
      const totalSlides = slides.length;

      function updateCarousel() {
        carouselContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
      }

      function handleCarouselNavigation(event) {
        if (event) event.preventDefault();
        if (event.target === prevBtn) {
          currentSlide = (currentSlide === 0) ? totalSlides - 1 : currentSlide - 1;
        } else if (event.target === nextBtn) {
          currentSlide = (currentSlide === totalSlides - 1) ? 0 : currentSlide + 1;
        }
        updateCarousel();
      }

      prevBtn.addEventListener('click', handleCarouselNavigation);
      prevBtn.addEventListener('touchstart', handleCarouselNavigation);
      nextBtn.addEventListener('click', handleCarouselNavigation);
      nextBtn.addEventListener('touchstart', handleCarouselNavigation);
    }

    // --- INICIALIZAR BOTONES DEL JUEGO ---
    function initGameButtons() {
      // Botones de verificaci√≥n de ubicaci√≥n
      const gpsBtn = document.querySelector('#location-check button[aria-label="Verificar ubicaci√≥n con GPS"]');
      const manualBtn = document.querySelector('#location-check button[aria-label="Verificar ubicaci√≥n manualmente"]');
      if (gpsBtn) {
        gpsBtn.addEventListener('click', (e) => handleButtonClick(e, checkLocation));
        gpsBtn.addEventListener('touchstart', (e) => handleButtonClick(e, checkLocation));
      }
      if (manualBtn) {
        manualBtn.addEventListener('click', (e) => handleButtonClick(e, checkLocationManual));
        manualBtn.addEventListener('touchstart', (e) => handleButtonClick(e, checkLocationManual));
      }

      // Bot√≥n de m√∫sica
      const musicBtn = document.querySelector('.music-btn');
      if (musicBtn) {
        musicBtn.addEventListener('click', (e) => handleButtonClick(e, toggleMusic));
        musicBtn.addEventListener('touchstart', (e) => handleButtonClick(e, toggleMusic));
      }

      // Botones de retos visuales
      document.querySelectorAll('#visual-opciones-1 button').forEach(btn => {
        btn.addEventListener('click', (e) => handleButtonClick(e, () => checkVisualAnswer(btn.textContent, 'Muralla', 1)));
        btn.addEventListener('touchstart', (e) => handleButtonClick(e, () => checkVisualAnswer(btn.textContent, 'Muralla', 1)));
      });
      document.querySelectorAll('#visual-opciones-2 button').forEach(btn => {
        btn.addEventListener('click', (e) => handleButtonClick(e, () => checkVisualAnswer(btn.textContent, '2', 2)));
        btn.addEventListener('touchstart', (e) => handleButtonClick(e, () => checkVisualAnswer(btn.textContent, '2', 2)));
      });

      // Botones de quiz
      document.querySelectorAll('#quiz-opciones-1 button').forEach(btn => {
        btn.addEventListener('click', (e) => handleButtonClick(e, () => checkAnswer(btn.textContent, 'XIII', 1)));
        btn.addEventListener('touchstart', (e) => handleButtonClick(e, () => checkAnswer(btn.textContent, 'XIII', 1)));
      });
      document.querySelectorAll('#quiz-opciones-2 button').forEach(btn => {
        btn.addEventListener('click', (e) => handleButtonClick(e, () => checkAnswer(btn.textContent, 'Cementerio municipal', 2)));
        btn.addEventListener('touchstart', (e) => handleButtonClick(e, () => checkAnswer(btn.textContent, 'Cementerio municipal', 2)));
      });
      document.querySelectorAll('#quiz-opciones-3 button').forEach(btn => {
        btn.addEventListener('click', (e) => handleButtonClick(e, () => checkAnswer(btn.textContent, 'Centro de Interpretaci√≥n de la Biosfera', 3)));
        btn.addEventListener('touchstart', (e) => handleButtonClick(e, () => checkAnswer(btn.textContent, 'Centro de Interpretaci√≥n de la Biosfera', 3)));
      });

      // Bot√≥n de comprobar combinaci√≥n
      const checkCombinationBtn = document.getElementById('check-combination');
      if (checkCombinationBtn) {
        checkCombinationBtn.addEventListener('click', (e) => handleButtonClick(e, checkCombination));
        checkCombinationBtn.addEventListener('touchstart', (e) => handleButtonClick(e, checkCombination));
      }

      // Bot√≥n de pista
      const hintBtn = document.querySelector('#combination-lock .hint-btn');
      if (hintBtn) {
        hintBtn.addEventListener('click', (e) => handleButtonClick(e, togglePistaLock));
        hintBtn.addEventListener('touchstart', (e) => handleButtonClick(e, togglePistaLock));
      }

      // Bot√≥n de cerrar pista
      const closeHintBtn = document.querySelector('#pista-lock button');
      if (closeHintBtn) {
        closeHintBtn.addEventListener('click', (e) => handleButtonClick(e, togglePistaLock));
        closeHintBtn.addEventListener('touchstart', (e) => handleButtonClick(e, togglePistaLock));
      }

      // Bot√≥n de continuar
      const continueBtn = document.querySelector('#continue-button button');
      if (continueBtn) {
        continueBtn.addEventListener('click', (e) => handleButtonClick(e, () => window.location.href = 'felicitaciones.html?stop=castillo'));
        continueBtn.addEventListener('touchstart', (e) => handleButtonClick(e, () => window.location.href = 'felicitaciones.html?stop=castillo'));
      }
    }

    function handleButtonClick(event, callback) {
      if (!event || !callback) return;
      event.preventDefault();
      const btn = event.target;
      btn.disabled = true;
      setTimeout(() => {
        callback();
        btn.disabled = false;
      }, 300);
    }

    // --- RETOS VISUALES Y QUIZ ---
    let quiz1Correct = false, quiz2Correct = false, quiz3Correct = false;
    function checkVisualAnswer(selected, correct, n) {
      const result = document.getElementById('visual-resultado-' + n);
      if (result) {
        if (selected === correct) {
          result.textContent = "¬°Correcto!";
          playSound("success-sound");
        } else {
          result.textContent = "Respuesta incorrecta...";
          playSound("error-sound");
        }
      }
    }

    function checkAnswer(selected, correct, n) {
      const result = document.getElementById('quiz-resultado-' + n);
      if (result) {
        if (selected === correct) {
          result.textContent = "¬°Correcto!";
          playSound("success-sound");
          if (n === 1) quiz1Correct = true;
          if (n === 2) quiz2Correct = true;
          if (n === 3) quiz3Correct = true;
        } else {
          result.textContent = "Incorrecto. Vuelve a intentarlo.";
          playSound("error-sound");
          if (n === 1) quiz1Correct = false;
          if (n === 2) quiz2Correct = false;
          if (n === 3) quiz3Correct = false;
        }
        if (quiz1Correct && quiz2Correct && quiz3Correct) {
          document.querySelector('.quiz').style.display = "none";
          initCombinationLock();
        }
      }
    }

    // --- MINIJUEGO: CANDADO DEL COFRE ---
    function initCombinationLock() {
      const combinationLock = document.getElementById("combination-lock");
      const dials = document.querySelectorAll(".dial");
      if (!combinationLock || !dials.length) {
        console.error("Error: Elementos del candado no encontrados");
        return;
      }
      combinationLock.style.display = "block";
      dials.forEach(dial => {
        dial.setAttribute("data-digit", "0");
        dial.textContent = "0";
        let lastTouchTime = 0;
        function handleDialInteraction(event) {
          if (!event) return;
          event.preventDefault();
          const now = Date.now();
          if (now - lastTouchTime < 300) return; // Debounce
          lastTouchTime = now;
          let current = parseInt(dial.getAttribute("data-digit"));
          if (event.type === 'touchstart' && event.touches && event.touches[0]) {
            const startY = event.touches[0].clientY;
            function handleTouchMove(e) {
              if (!e.touches || !e.touches[0]) return;
              const moveY = e.touches[0].clientY;
              const deltaY = startY - moveY;
              if (deltaY > 10) {
                current = (current + 1) % 10;
                dial.setAttribute("data-digit", current);
                dial.textContent = current;
                playSound("coins-sound");
              } else if (deltaY < -10) {
                current = (current - 1 + 10) % 10;
                dial.setAttribute("data-digit", current);
                dial.textContent = current;
                playSound("coins-sound");
              }
            }
            function handleTouchEnd() {
              document.removeEventListener('touchmove', handleTouchMove);
              document.removeEventListener('touchend', handleTouchEnd);
            }
            document.addEventListener('touchmove', handleTouchMove);
            document.addEventListener('touchend', handleTouchEnd);
          } else {
            current = (current + 1) % 10;
            dial.setAttribute("data-digit", current);
            dial.textContent = current;
            playSound("coins-sound");
          }
        }
        dial.addEventListener("click", handleDialInteraction);
        dial.addEventListener("touchstart", handleDialInteraction);
      });
      generateSecretCombination();
      aplicarIdiomaCastillo(); // Actualizar texto de la pista
    }

    let secretCombination = "";
    function generateSecretCombination() {
      const keys = ["1834", "1949", "2010"];
      secretCombination = keys[Math.floor(Math.random() * keys.length)];
      console.log("Combinaci√≥n secreta:", secretCombination);
    }

    function togglePistaLock(event) {
      if (!event) return;
      event.preventDefault();
      const pistaDiv = document.getElementById("pista-lock");
      if (pistaDiv) {
        const isHidden = pistaDiv.style.display !== "block";
        pistaDiv.style.display = isHidden ? "block" : "none";
        console.log("Pista lock toggled:", isHidden ? "shown" : "hidden");
      } else {
        console.error("Error: #pista-lock no encontrado");
      }
    }

    function checkCombination(event) {
      if (!event) return;
      event.preventDefault();
      const dials = document.querySelectorAll(".dial");
      const combinationStatus = document.getElementById("combination-status");
      if (!dials.length || !combinationStatus) {
        console.error("Error: Elementos del candado no encontrados");
        return;
      }
      let userCombination = "";
      dials.forEach(dial => {
        userCombination += dial.getAttribute("data-digit");
      });
      if (userCombination === secretCombination) {
        combinationStatus.textContent = "¬°Candado desbloqueado!";
        playSound("success-sound");
        unlockFinalFragment();
      } else {
        combinationStatus.textContent = "Combinaci√≥n incorrecta. Int√©ntalo de nuevo.";
        playSound("error-sound");
      }
    }

    // --- FRAGMENTO FINAL / CONTINUAR ---
    function unlockFinalFragment() {
      const combinationLock = document.getElementById("combination-lock");
      const fragmentoFinal = document.getElementById("fragmento-final");
      const continueButton = document.getElementById("continue-button");
      if (combinationLock && fragmentoFinal && continueButton) {
        combinationLock.style.display = "none";
        fragmentoFinal.style.display = "block";
        continueButton.style.display = "block";
        updateChronicle();
        updateRanking();
        playSound("success-sound");
      } else {
        console.error("Error: Elementos del fragmento final no encontrados");
      }
    }

    function updateChronicle() {
      if (typeof localStorage !== 'undefined') {
        const messagePiece = document.getElementById("message-piece");
        if (messagePiece) {
          localStorage.setItem("cronica_castillo", messagePiece.textContent);
        }
      }
    }

    function updateRanking() {
      if (typeof localStorage !== 'undefined') {
        let ranking = JSON.parse(localStorage.getItem("ranking")) || [];
        ranking.push({ stop: "castillo", score: 100 });
        localStorage.setItem("ranking", JSON.stringify(ranking));
      }
    }

    // --- SONIDOS ---
    function playSound(id) {
      const sound = document.getElementById(id);
      if (sound) sound.play().catch(err => console.log("Error al reproducir sonido:", err));
    }

    // --- BOT√ìN DE M√öSICA ---
    function toggleMusic(event) {
      if (!event) return;
      event.preventDefault();
      const backgroundMusic = document.getElementById('ambient-sound');
      const musicBtn = document.querySelector('.music-btn');
      if (backgroundMusic && musicBtn) {
        if (backgroundMusic.paused) {
          backgroundMusic.play().catch(err => console.log("Error al reproducir m√∫sica:", err));
          musicBtn.innerHTML = '<span class="music-icon">üéµ</span> Pausar M√∫sica';
        } else {
          backgroundMusic.pause();
          musicBtn.innerHTML = '<span class="music-icon">üîá</span> Reproducir M√∫sica';
        }
      }
    }

    // --- LOCALSTORAGE ---
    if (typeof localStorage !== 'undefined') {
      localStorage.setItem("castillo-completed", "true");
    }

    // --- INICIALIZACI√ìN ---
    document.addEventListener("DOMContentLoaded", () => {
      initGameButtons();
      aplicarIdiomaCastillo();
    });
  </script>
  <script defer>
    const textosCastillo = {
      es: {
        titulo: "üè∞ Castillo de Gonzalo",
        verifica: "Verifica tu ubicaci√≥n",
        indicacion: "Ac√©rcate a la puerta principal del Castillo de San Mart√≠n para iniciar la b√∫squeda del mensaje.",
        verificarGPS: "Verificar GPS",
        oEscribe: "O ingresa el nombre:",
        verificarManual: "Verificar Manual",
        retoTitulo: "Retos Visuales: Afina tus sentidos",
        reto1: "1. ¬øQu√© destaca en la fachada principal del castillo?",
        reto2: "2. ¬øCu√°ntas torres ten√≠a originalmente el castillo?",
        quizTitulo: "Quiz: Descubre el mensaje",
        quiz1: "1. ¬øEn qu√© siglo se funda esta fortificaci√≥n?",
        quiz2: "2. ¬øQu√© alberga el castillo desde el siglo XIX?",
        quiz3: "3. ¬øQu√© funci√≥n tiene actualmente el castillo?",
        opciones: {
          escudos: "Escudos", muralla: "Muralla", columnas: "Columnas",
          uno: "1", dos: "2", tres: "3",
          XII: "XII", XIII: "XIII", XIV: "XIV",
          discoteca: "Discoteca", cementerio: "Cementerio municipal", museo: "Museo",
          centro: "Centro de Interpretaci√≥n de la Biosfera", biblioteca: "Biblioteca"
        },
        candado: "Candado del Cofre",
        comprobar: "Comprobar Combinaci√≥n",
        pistaCandado: "La clave corresponde a una fecha que marc√≥ un hito en la historia del castillo. ¬°B√∫scala en las im√°genes!",
        cerrarPista: "Cerrar Pista",
        continuar: "Continuar b√∫squeda",
        fragmento: "Fragmento del Mensaje: Oculto",
        qr: "QR en el pueblo: CASTILLO (busca en la entrada principal).",
        datoCurioso: "Dato Curioso: Cer√°micas y monedas del siglo XIII halladas aqu√≠ inspiraron a Gonzalo."
      },
      en: {
        titulo: "üè∞ Gonzalo's Castle",
        verifica: "Verify your location",
        indicacion: "Approach the castle gate to begin your quest.",
        verificarGPS: "Verify GPS",
        oEscribe: "Or enter the name:",
        verificarManual: "Verify Manually",
        retoTitulo: "Visual Challenges: Sharpen your senses",
        reto1: "1. What stands out on the castle‚Äôs main fa√ßade?",
        reto2: "2. How many towers did the castle originally have?",
        quizTitulo: "Quiz: Discover the message",
        quiz1: "1. In which century was this fortress built?",
        quiz2: "2. What has the castle housed since the 19th century?",
        quiz3: "3. What is the castle's function today?",
        opciones: {
          escudos: "Coats of arms", muralla: "Wall", columnas: "Columns",
          uno: "1", dos: "2", tres: "3",
          XII: "12th", XIII: "13th", XIV: "14th",
          discoteca: "Nightclub", cementerio: "Municipal Cemetery", museo: "Museum",
          centro: "Biosphere Interpretation Center", biblioteca: "Library"
        },
        candado: "Treasure Chest Lock",
        comprobar: "Check Combination",
        pistaCandado: "The code corresponds to a date that marked a milestone in the castle‚Äôs history. Look for it in the images!",
        cerrarPista: "Close Hint",
        continuar: "Continue exploration",
        fragmento: "Message Fragment: Hidden",
        qr: "QR in town: CASTILLO (near the entrance).",
        datoCurioso: "Fun Fact: XIII-century ceramics and coins found here inspired Gonzalo."
      },
      fr: {
        titulo: "üè∞ Ch√¢teau de Gonzalo",
        verifica: "V√©rifiez votre position",
        indicacion: "Approchez-vous de la porte principale du ch√¢teau pour commencer la qu√™te.",
        verificarGPS: "V√©rifier GPS",
        oEscribe: "Ou entrez le nom :",
        verificarManual: "V√©rifier manuellement",
        retoTitulo: "D√©fis visuels : Aiguisez vos sens",
        reto1: "1. Qu'est-ce qui se distingue sur la fa√ßade principale du ch√¢teau ?",
        reto2: "2. Combien de tours le ch√¢teau avait-il √† l'origine ?",
        quizTitulo: "Quiz : D√©couvrez le message",
        quiz1: "1. En quel si√®cle cette forteresse a-t-elle √©t√© fond√©e ?",
        quiz2: "2. Que le ch√¢teau abrite-t-il depuis le XIXe si√®cle ?",
        quiz3: "3. Quelle est la fonction actuelle du ch√¢teau ?",
        opciones: {
          escudos: "Blasons", muralla: "Mur", columnas: "Colonnes",
          uno: "1", dos: "2", tres: "3",
          XII: "XIIe", XIII: "XIIIe", XIV: "XIVe",
          discoteca: "Discoth√®que", cementerio: "Cimeti√®re municipal", museo: "Mus√©e",
          centro: "Centre d'interpr√©tation de la biosph√®re", biblioteca: "Biblioth√®que"
        },
        candado: "Cadenas du Coffre",
        comprobar: "V√©rifier la combinaison",
        pistaCandado: "Le code correspond √† une date importante dans l‚Äôhistoire du ch√¢teau. Cherchez-la dans les images !",
        cerrarPista: "Fermer la piste",
        continuar: "Continuer l‚Äôexploration",
        fragmento: "Fragment du message : Cach√©",
        qr: "QR dans le village : CASTILLO (pr√®s de l'entr√©e).",
        datoCurioso: "Le saviez-vous ? Des c√©ramiques et pi√®ces du XIIIe si√®cle ont inspir√© Gonzalo."
      },
      de: {
        titulo: "üè∞ Gonzalos Burg",
        verifica: "Standort √ºberpr√ºfen",
        indicacion: "Gehe zum Burgtor, um die Suche zu starten.",
        verificarGPS: "GPS √ºberpr√ºfen",
        oEscribe: "Oder gib den Namen ein:",
        verificarManual: "Manuell √ºberpr√ºfen",
        retoTitulo: "Visuelle R√§tsel: Sch√§rfe deine Sinne",
        reto1: "1. Was f√§llt an der Hauptfassade der Burg auf?",
        reto2: "2. Wie viele T√ºrme hatte die Burg urspr√ºnglich?",
        quizTitulo: "Quiz: Entdecke die Nachricht",
        quiz1: "1. In welchem Jahrhundert wurde die Festung gegr√ºndet?",
        quiz2: "2. Was beherbergt die Burg seit dem 19. Jahrhundert?",
        quiz3: "3. Was ist heute die Funktion der Burg?",
        opciones: {
          escudos: "Wappen", muralla: "Mauer", columnas: "S√§ulen",
          uno: "1", dos: "2", tres: "3",
          XII: "12.", XIII: "13.", XIV: "14.",
          discoteca: "Diskothek", cementerio: "Gemeindefriedhof", museo: "Museum",
          centro: "Biosph√§ren-Informationszentrum", biblioteca: "Bibliothek"
        },
        candado: "Schloss der Truhe",
        comprobar: "Kombination pr√ºfen",
        pistaCandado: "Der Code entspricht einem bedeutenden Datum in der Geschichte der Burg. Schau in die Bilder!",
        cerrarPista: "Hinweis schlie√üen",
        continuar: "Weiterforschen",
        fragmento: "Nachrichtenfragment: Versteckt",
        qr: "QR im Dorf: CASTILLO (nahe dem Eingang).",
        datoCurioso: "Wissenswertes: Im 13. Jh. gefundene Keramik und M√ºnzen inspirierten Gonzalo."
      }
    };

    function aplicarIdiomaCastillo() {
      const idioma = localStorage.getItem("idioma") || "es";
      const t = textosCastillo[idioma];

      // T√≠tulos y textos generales (siempre visibles)
      const headerTitle = document.querySelector("header h1");
      if (headerTitle) document.title = headerTitle.innerText = t.titulo;
      const locationCheck = document.querySelector("#location-check");
      if (locationCheck) {
        locationCheck.querySelector("h2").innerText = t.verifica;
        locationCheck.querySelector("p").innerText = t.indicacion;
        const gpsBtn = locationCheck.querySelector("button[aria-label='Verificar ubicaci√≥n con GPS']");
        if (gpsBtn) gpsBtn.innerText = t.verificarGPS;
        locationCheck.querySelector("p:nth-of-type(2)").innerText = t.oEscribe;
        const manualBtn = locationCheck.querySelector("button[aria-label='Verificar ubicaci√≥n manualmente']");
        if (manualBtn) manualBtn.innerText = t.verificarManual;
      }

      // Solo actualizar textos del juego si #game-content est√° visible
      if (document.getElementById("game-content").style.display === "block") {
        // Retos visuales
        const reto = document.querySelector(".visual-challenge");
        if (reto) {
          reto.querySelector("h2").innerText = t.retoTitulo;
          reto.querySelector("#visual-pregunta-1").innerText = t.reto1;
          reto.querySelector("#visual-pregunta-2").innerText = t.reto2;
          const botonesVisuales = reto.querySelectorAll("#visual-opciones-1 button, #visual-opciones-2 button");
          if (botonesVisuales.length >= 6) {
            botonesVisuales[0].innerText = t.opciones.escudos;
            botonesVisuales[1].innerText = t.opciones.muralla;
            botonesVisuales[2].innerText = t.opciones.columnas;
            botonesVisuales[3].innerText = t.opciones.uno;
            botonesVisuales[4].innerText = t.opciones.dos;
            botonesVisuales[5].innerText = t.opciones.tres;
          }
        }

        // Quiz
        const quiz = document.querySelector(".quiz");
        if (quiz) {
          quiz.querySelector("h2").innerText = t.quizTitulo;
          quiz.querySelector("#quiz-pregunta-1").innerText = t.quiz1;
          quiz.querySelector("#quiz-pregunta-2").innerText = t.quiz2;
          quiz.querySelector("#quiz-pregunta-3").innerText = t.quiz3;
          const botonesQuiz = quiz.querySelectorAll("#quiz-opciones-1 button, #quiz-opciones-2 button, #quiz-opciones-3 button");
          if (botonesQuiz.length >= 9) {
            botonesQuiz[0].innerText = t.opciones.XII;
            botonesQuiz[1].innerText = t.opciones.XIII;
            botonesQuiz[2].innerText = t.opciones.XIV;
            botonesQuiz[3].innerText = t.opciones.discoteca;
            botonesQuiz[4].innerText = t.opciones.cementerio;
            botonesQuiz[5].innerText = t.opciones.museo;
            botonesQuiz[6].innerText = t.opciones.museo;
            botonesQuiz[7].innerText = t.opciones.centro;
            botonesQuiz[8].innerText = t.opciones.biblioteca;
          }
        }

        // Candado
        const combinationLock = document.querySelector("#combination-lock");
        if (combinationLock) {
          combinationLock.querySelector("h2").innerText = t.candado;
          const checkBtn = document.getElementById("check-combination");
          if (checkBtn) checkBtn.innerText = t.comprobar;
          const pistaTexto = document.getElementById("pista-texto");
          if (pistaTexto) pistaTexto.innerText = t.pistaCandado;
          const closePistaBtn = document.querySelector("#pista-lock button");
          if (closePistaBtn) closePistaBtn.innerText = t.cerrarPista;
        }

        // Fragmento final
        const fragmento = document.getElementById("fragmento-final");
        if (fragmento) {
          fragmento.querySelector("p strong").innerText = t.fragmento;
          const fragmentoPs = fragmento.querySelectorAll("p");
          if (fragmentoPs.length >= 3) {
            fragmentoPs[1].innerText = t.qr;
            fragmentoPs[2].innerText = t.datoCurioso;
          }
        }

        const continueBtn = document.querySelector("#continue-button button");
        if (continueBtn) continueBtn.innerText = t.continuar;
      }
    }
  </script>
</body>
</html>
