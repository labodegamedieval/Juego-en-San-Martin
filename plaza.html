<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🏟️ Plaza de Toros</title>
  <link rel="icon" href="favicon.ico" />
  <style>
    body {
      background: url('images/pergamino.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: Georgia, serif;
      color: #3b241b;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: rgba(255, 248, 228, 0.96);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      text-align: center;
    }

    h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.2em;
      margin-bottom: 20px;
      font-style: italic;
      color: #5e3b1b;
    }

    .carousel {
      margin-bottom: 30px;
    }

    .carousel img {
      width: 100%;
      border-radius: 10px;
      border: 2px solid #6b3e2e;
    }

    .carousel p {
      text-align: center;
      font-style: italic;
      margin-top: 10px;
    }

    .caseta {
      border: 6px double #8b5e3c;
      background-color: rgba(255, 248, 228, 0.5);
      padding: 20px;
      border-radius: 16px;
      margin-top: 20px;
      backdrop-filter: blur(3px);
    }

    canvas {
      border: 3px solid #5e3b1b;
      border-radius: 12px;
      display: block;
      margin: 0 auto;
      background-color: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(2px);
    }

    #score-display, #game-instruction {
      text-align: center;
      font-size: 18px;
      margin-top: 10px;
    }

    #fragmento {
      display: none;
      margin: 20px auto;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: contain;
      padding: 40px;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      border: 2px solid #6b3e2e;
      border-radius: 12px;
    }

    .action-btn {
      display: none;
      margin: 30px auto 20px;
      padding: 12px 20px;
      font-size: 18px;
      background-color: #d6b88a;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🏟️ Plaza de Toros</h1>
    <p class="subtitle">🎪 ¡Bienvenido a la caseta de puntería! Demuestra tu habilidad y revela el secreto oculto entre aplausos y capeas.</p>

    <div class="carousel">
      <img src="images/plaza-tradicion.jpg" alt="Capeas en la plaza" />
      <p>Las capeas del 11 de agosto, símbolo de identidad local. Esta plaza de toros es una de las más antiguas de España, construida en el siglo XVII aprovechando el patio de armas del castillo. Conserva gradas originales de piedra y se sigue utilizando durante las fiestas patronales.</p>
      <p><strong>Curiosidad:</strong> Algunos vecinos afirman que Gonzalo fue visto por última vez entre los burladeros antes de su desaparición misteriosa en una noche de capeas.</p>
      <p><a href="https://sanmartindelcastanar.es/plaza-de-toros/" target="_blank">🔗 Más información sobre la Plaza de Toros</a></p>
    </div>

    <div class="caseta">
      <p id="game-instruction">🎯 Acierta a la <strong>copa</strong>, el <strong>escudo</strong> y el <strong>racimo de uvas</strong> para ganar.</p>
      <canvas id="gameCanvas" width="600" height="300"></canvas>
      <div id="score-display">Puntuación: 0 / 3</div>
      <div id="fragmento">📜 Fragmento revelado: "…y en la arena retumbó el secreto."</div>
      <button id="continue-button" class="action-btn" onclick="location.href='felicitaciones.html?stop=plaza'">Continuar la aventura</button>
    </div>
  </div>

  <audio id="hit-sound" src="sounds/cheers.mp3" preload="auto"></audio>
  <audio id="miss-sound" src="sounds/error.mp3" preload="auto"></audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const scoreDisplay = document.getElementById("score-display");
    const fragmento = document.getElementById("fragmento");
    const btn = document.getElementById("continue-button");
    const hitSound = document.getElementById("hit-sound");
    const missSound = document.getElementById("miss-sound");

    const objetivos = ["🍷", "🛡️", "🍇", "🐂", "⚔️", "🎭"];
    const objetivosClave = new Set(["🍷", "🛡️", "🍇"]);
    const aciertos = new Set();
    const blancos = [];

    const filas = [60, 140, 220];
    const velocidad = 1.5;

    for (let y of filas) {
      for (let i = 0; i < 6; i++) {
        blancos.push({
          x: -Math.random() * 600,
          y,
          icono: objetivos[Math.floor(Math.random() * objetivos.length)],
          roto: false,
          alpha: 1
        });
      }
    }

    function dibujar() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      blancos.forEach(b => {
        if (!b.roto) {
          ctx.globalAlpha = 1;
          ctx.font = "32px serif";
          ctx.fillText(b.icono, b.x, b.y);
        } else if (b.alpha > 0) {
          ctx.globalAlpha = b.alpha;
          ctx.font = "32px serif";
          ctx.fillText(b.icono, b.x, b.y);
          b.alpha -= 0.02;
        }
        b.x += velocidad;
        if (b.x > canvas.width + 40) {
          b.x = -Math.random() * 600;
          b.icono = objetivos[Math.floor(Math.random() * objetivos.length)];
          b.roto = false;
          b.alpha = 1;
        }
      });
      ctx.globalAlpha = 1;
      requestAnimationFrame(dibujar);
    }

    function disparar(event) {
      const rect = canvas.getBoundingClientRect();
      const x = (event.clientX || event.touches?.[0]?.clientX || 0) - rect.left;
      const y = (event.clientY || event.touches?.[0]?.clientY || 0) - rect.top;

      let acertado = false;

      blancos.forEach(b => {
        if (!b.roto && x > b.x - 20 && x < b.x + 20 && y > b.y - 30 && y < b.y) {
          if (objetivosClave.has(b.icono)) {
            aciertos.add(b.icono);
            b.roto = true;
            acertado = true;
          }
        }
      });

      try {
        if (acertado) hitSound.play();
        else missSound.play();
      } catch (e) {
        console.warn("Audio error:", e);
      }

      scoreDisplay.textContent = `Puntuación: ${aciertos.size} / 3`;

      if (aciertos.size === 3) {
        fragmento.style.display = "block";
        btn.style.display = "block";
        localStorage.setItem("plaza-completed", "true");
      }
    }

    canvas.addEventListener("click", disparar);
    canvas.addEventListener("touchstart", disparar);

    dibujar();
  </script>
</body>
</html>
