<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‚õ™ Iglesia de San Mart√≠n</title>
  <link rel="stylesheet" href="styles/style.css"/>
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg"/>
  <style>
    .organ-container {
      display: flex;
      justify-content: center;
      position: relative;
      margin: 20px auto;
      height: 160px;
    }

    .key {
      width: 40px;
      height: 160px;
      background: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      position: relative;
      z-index: 1;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
      padding-top: 135px;
    }

    .key.active {
      background: #ffe58a;
    }

    .black-key {
      width: 25px;
      height: 100px;
      background: #111;
      position: absolute;
      z-index: 2;
      top: 0;
      border-radius: 4px;
      color: #fff;
      text-align: center;
      font-size: 10px;
      padding-top: 80px;
    }

    .key span {
      position: absolute;
      bottom: 6px;
      left: 0;
      right: 0;
    }

    .pista {
      margin-top: 15px;
      font-style: italic;
      color: #444;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>‚õ™ Iglesia de San Mart√≠n</h1>
      <div class="music-control">
        <button class="music-btn"><span class="music-icon">üéµ</span> M√∫sica</button>
      </div>
    </header>

    <section id="content">
      <div class="stop-icon">‚õ™</div>

      <div id="location-check">
        <h2>Verifica tu ubicaci√≥n</h2>
        <p>Col√≥cate frente a la puerta g√≥tico-mud√©jar de la iglesia.</p>
        <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
        <p>O escribe el nombre:</p>
        <input type="text" id="location-input" placeholder="Ej: Iglesia" />
        <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
        <p id="location-status"></p>
        <img id="direction-arrow" src="images/flecha.png" class="arrow-icon" style="display: none;" />
      </div>

      <div id="game-content" style="display: none;">
        <div class="carousel">
          <div class="slide active">
            <img src="images/retablo.jpg" alt="Interior de la Iglesia" />
            <p><strong>Interior:</strong> Retablos barrocos, capilla del Evangelio y arcos g√≥tico-mud√©jar √∫nicos. Si la iglesia est√° cerrada, te va a interesar este link. <a href="https://www.salamancamudejar.com/ruta-sur/" target="_blank">M√°s info</a></p>
          </div>
          <div class="slide">
            <img src="images/iglesia.jpg" alt="Exterior de la Iglesia" />
            <p><strong>Fachada:</strong> Entrada en piedra y ladrillo con campanario de cinco campanas.</p>
          </div>
          <button class="carousel-btn prev-slide">‚Üê</button>
          <button class="carousel-btn next-slide">‚Üí</button>
        </div>

        <h2>üéº Reto del √ìrgano</h2>
        <p>üéπ Toca las teclas del antiguo √≥rgano siguiendo la secuencia secreta.<br><span class="pista">Pista: Domingo de fiesta, hoy ta√±en al alba las campanas. Fanfarrias en la puerta de la iglesia. Resucitan las notas del √≥rgano. Solitaria es la melod√≠a</span></p>

        <div class="organ-container" id="organ-container">
          <!-- Teclas blancas -->
          <div class="key" data-note="do"><span>DO</span></div>
          <div class="key" data-note="re"><span>RE</span></div>
          <div class="key" data-note="mi"><span>MI</span></div>
          <div class="key" data-note="fa"><span>FA</span></div>
          <div class="key" data-note="sol"><span>SOL</span></div>
          <div class="key" data-note="la"><span>LA</span></div>
          <div class="key" data-note="si"><span>SI</span></div>
          <!-- Teclas negras posicionadas din√°micamente con JS -->
        </div>

        <p id="vitraux-feedback" class="pista"></p>

        <div class="fragmento-final" id="fragmento-final" style="display: none;">
          <p><strong>Fragmento del Mensaje:</strong> <span id="message-piece">la fe del pueblo gu√≠a las almas...</span></p>
          <p><strong>QR en el pueblo:</strong> IGLESIA-1300</p>
          <p><strong>Dato Curioso:</strong> Se conserva una estela funeraria romana a la izquierda del portal. Sugerencia: si la fortuna os acompa√±a y la panader√≠a est√° abierta podr√©is adquirir sus famosas perronillas... a lo mejor os dan alguna pista.</p>
        </div>

        <div id="continue-button" style="display: none;">
          <button class="action-btn" onclick="location.href='felicitaciones.html?stop=iglesia'">Continuar aventura</button>
        </div>
      </div>
    </section>

    <!-- Audio -->
    <audio id="organ-do" src="sounds/organ-do.mp3" preload="auto"></audio>
    <audio id="organ-re" src="sounds/organ-re.mp3" preload="auto"></audio>
    <audio id="organ-mi" src="sounds/organ-mi.mp3" preload="auto"></audio>
    <audio id="organ-fa" src="sounds/organ-fa.mp3" preload="auto"></audio>
    <audio id="organ-sol" src="sounds/organ-sol.mp3" preload="auto"></audio>
    <audio id="organ-la" src="sounds/organ-la.mp3" preload="auto"></audio>
    <audio id="organ-si" src="sounds/organ-si.mp3" preload="auto"></audio>
    <audio id="organ-full" src="sounds/organ-full.mp3" preload="auto"></audio>
    <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
    <audio id="background-music" src="sounds/musica-medieval.mp3" preload="auto" loop></audio>

    <footer>
      <p>¬© 2025 La Bodega Medieval |
        <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita </a>
      </p>
    </footer>

    <script>
      const secuenciaCorrecta = ["do", "fa", "re", "sol"];
      let entradaUsuario = [];

      document.querySelectorAll('.key').forEach(key => {
        key.addEventListener('click', () => {
          const nota = key.dataset.note;
          entradaUsuario.push(nota);

          const sonidoOriginal = document.getElementById(`organ-${nota}`);
          if (sonidoOriginal) {
            const clone = sonidoOriginal.cloneNode();
            clone.play().catch(e => console.log(e));
          }

          key.classList.add('active');
          setTimeout(() => key.classList.remove('active'), 300);

          if (entradaUsuario.length === secuenciaCorrecta.length) {
            if (JSON.stringify(entradaUsuario) === JSON.stringify(secuenciaCorrecta)) {
              document.getElementById("vitraux-feedback").textContent = "üé∂ ¬°Has reproducido la melod√≠a sagrada!";
              document.getElementById("fragmento-final").style.display = "block";
              document.getElementById("continue-button").style.display = "block";
              localStorage.setItem("iglesia-completed", "true");
              document.getElementById("organ-full").play();
            } else {
              document.getElementById("vitraux-feedback").textContent = "‚ùå Esa no era la secuencia. Vuelve a intentarlo.";
              document.getElementById("error-sound").play();
            }
            entradaUsuario = [];
          }
        });
      });

      // Agregar teclas negras sobre las blancas
      const container = document.getElementById("organ-container");
      const blackPositions = [1, 2, 4, 5, 6]; // entre DO-RE, RE-MI, FA-SOL, SOL-LA, LA-SI
      const blackLabels = ["DO#", "RE#", "FA#", "SOL#", "LA#"];
      blackPositions.forEach((pos, i) => {
        const blackKey = document.createElement("div");
        blackKey.className = "black-key";
        blackKey.style.left = `${(pos * 44) - 12}px`;
        blackKey.innerText = blackLabels[i];
        container.appendChild(blackKey);
      });

      function checkLocation() {
        navigator.geolocation.getCurrentPosition(position => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const iglesiaLat = 40.521341;
          const iglesiaLon = -6.063827;
          const distance = Math.sqrt(Math.pow(lat - iglesiaLat, 2) + Math.pow(lon - iglesiaLon, 2));
          if (distance < 0.002) {
            document.getElementById('location-status').textContent = '‚úÖ Ubicaci√≥n confirmada.';
            document.getElementById('game-content').style.display = 'block';
            document.getElementById('location-check').style.display = 'none';
          } else {
            document.getElementById('location-status').textContent = '‚ùå No est√°s cerca de la iglesia.';
          }
        }, () => {
          document.getElementById('location-status').textContent = '‚ö†Ô∏è No se pudo obtener tu ubicaci√≥n.';
        });
      }

      function checkLocationManual() {
        const input = document.getElementById('location-input').value.trim().toLowerCase();
        if (input === 'iglesia') {
          document.getElementById('location-status').textContent = '‚úÖ Acceso concedido por verificaci√≥n manual.';
          document.getElementById('game-content').style.display = 'block';
          document.getElementById('location-check').style.display = 'none';
        } else {
          document.getElementById('location-status').textContent = '‚ùå Nombre incorrecto.';
        }
      }
    </script>
  </div>
</body>
</html>
