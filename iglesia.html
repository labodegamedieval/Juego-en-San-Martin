<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‚õ™ Iglesia de San Mart√≠n</title>
  <link rel="stylesheet" href="styles/style.css" />
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg" />
  <style>
    .organ-wrapper {
      position: relative;
      display: flex;
      justify-content: center;
      margin: 20px auto;
      height: 180px;
    }
    .white-key {
      width: 40px;
      height: 180px;
      background: white;
      border: 1px solid #444;
      z-index: 1;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
      line-height: 160px;
      cursor: pointer;
      position: relative;
    }
    .white-key.active {
      background: #ffe58a;
    }
    .black-key {
      width: 25px;
      height: 100px;
      background: black;
      color: white;
      text-align: center;
      line-height: 100px;
      font-size: 10px;
      position: absolute;
      top: 0;
      z-index: 2;
      border-radius: 4px;
      cursor: pointer;
    }
    .black-key.active {
      background: #ffbf00;
    }
    .fragmento-final, .pista-container {
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      border: 2px solid #6b3e2e;
      border-radius: 12px;
      padding: 30px;
      margin: 20px auto;
      max-width: 600px;
      text-align: center;
    }
    .pista-container {
      display: none;
      font-style: italic;
      line-height: 1.6;
    }
    .carousel img {
      width: 100%;
      border-radius: 10px;
      border: 2px solid #6b3e2e;
    }
    .carousel p {
      text-align: center;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>‚õ™ Iglesia de San Mart√≠n</h1>
      <div class="music-control">
        <button class="music-btn"><span class="music-icon">üéµ</span> M√∫sica</button>
      </div>
    </header>

    <section id="content">
      <div id="location-check">
        <h2>Verifica tu ubicaci√≥n</h2>
        <p>Col√≥cate frente a la puerta g√≥tico-mud√©jar de la iglesia.</p>
        <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
        <p>O escribe el nombre:</p>
        <input type="text" id="location-input" placeholder="Ej: Iglesia" />
        <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
        <p id="location-status"></p>
      </div>

      <div id="game-content" style="display: none;">
        <div class="carousel">
          <div class="slide">
            <img src="images/retablo.jpg" alt="Interior de la Iglesia" />
            <p><strong>Interior:</strong> Retablos barrocos, capilla del Evangelio y arcos g√≥tico-mud√©jar √∫nicos. Si est√° cerrada: <a href="https://www.salamancamudejar.com/ruta-sur/" target="_blank">+ info</a></p>
          </div>
          <div class="slide">
            <img src="images/iglesia.jpg" alt="Exterior de la Iglesia" />
            <p><strong>Fachada:</strong> Entrada de piedra y ladrillo con campanario de cinco campanas.</p>
          </div>
        </div>

        <h2>üéº Reto del √ìrgano</h2>
        <p>üéπ Toca las teclas del √≥rgano siguiendo la secuencia secreta.</p>
        <button class="action-btn" onclick="document.getElementById('pista').style.display='block'">üó≥Ô∏è Ver pista</button>

        <div class="organ-wrapper">
          <div class="white-key" data-note="do">DO</div>
          <div class="black-key" style="left: 28px;" data-note="do#">DO#</div>
          <div class="white-key" data-note="re">RE</div>
          <div class="black-key" style="left: 68px;" data-note="re#">RE#</div>
          <div class="white-key" data-note="mi">MI</div>
          <div class="white-key" data-note="fa">FA</div>
          <div class="black-key" style="left: 148px;" data-note="fa#">FA#</div>
          <div class="white-key" data-note="sol">SOL</div>
          <div class="black-key" style="left: 188px;" data-note="sol#">SOL#</div>
          <div class="white-key" data-note="la">LA</div>
          <div class="black-key" style="left: 228px;" data-note="la#">LA#</div>
          <div class="white-key" data-note="si">SI</div>
        </div>

        <div id="pista" class="pista-container">
          <p>Domingo de misterio en el pueblo</p>
          <p>las campanas ta√±en al alba.</p>
          <p>Fanfarrias en la puerta de la iglesia</p>
          <p>con el √≥rgano afinado.</p>
          <p>Resurgen los enigmas del pasado.</p>
          <p>Solitaria la melod√≠a de Gonzalo.</p>
        </div>

        <div class="fragmento-final" id="fragmento-final" style="display: none;">
          <p><strong>Fragmento del Mensaje:</strong><br>Y en la penumbra de la nave, la fe reson√≥.</p>
          <p><strong>QR:</strong> IGLESIA-1300</p>
        </div>

        <div id="continue-button" style="display: none; text-align: center; margin-top: 20px;">
          <button class="action-btn" onclick="location.href='felicitaciones.html?stop=iglesia'">Continuar aventura</button>
        </div>
      </div>
    </section>

    <!-- Audios -->
    <audio id="organ-full" src="sounds/organ-full.mp3" preload="auto"></audio>
    <script>
      const secuenciaCorrecta = ["do", "fa", "re", "sol"];
      let entradaUsuario = [];
      
      document.querySelectorAll('.white-key, .black-key').forEach(key => {
        key.addEventListener('click', () => {
          const nota = key.dataset.note;
          entradaUsuario.push(nota);

          const audio = new Audio(`sounds/organ-${nota}.mp3`);
          audio.play();

          key.classList.add('active');
          setTimeout(() => key.classList.remove('active'), 300);

          if (entradaUsuario.length === secuenciaCorrecta.length) {
            if (JSON.stringify(entradaUsuario) === JSON.stringify(secuenciaCorrecta)) {
              document.getElementById("fragmento-final").style.display = "block";
              document.getElementById("continue-button").style.display = "block";
              localStorage.setItem("iglesia-completed", "true");
              document.getElementById("organ-full").play();
            }
            entradaUsuario = [];
          }
        });
      });

      function checkLocation() {
        navigator.geolocation.getCurrentPosition(position => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const iglesiaLat = 40.521341;
          const iglesiaLon = -6.063827;
          const distance = Math.sqrt(Math.pow(lat - iglesiaLat, 2) + Math.pow(lon - iglesiaLon, 2));
          if (distance < 0.002) {
            document.getElementById('location-status').textContent = '‚úÖ Ubicaci√≥n confirmada.';
            document.getElementById('game-content').style.display = 'block';
            document.getElementById('location-check').style.display = 'none';
          } else {
            document.getElementById('location-status').textContent = '‚ùå No est√°s cerca de la iglesia.';
          }
        });
      }

      function checkLocationManual() {
        const input = document.getElementById('location-input').value.trim().toLowerCase();
        if (input === 'iglesia') {
          document.getElementById('location-status').textContent = '‚úÖ Acceso concedido por verificaci√≥n manual.';
          document.getElementById('game-content').style.display = 'block';
          document.getElementById('location-check').style.display = 'none';
        } else {
          document.getElementById('location-status').textContent = '‚ùå Nombre incorrecto.';
        }
      }
    </script>

    <footer>
      <p>¬© 2025 La Bodega Medieval | <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a></p>
    </footer>
  </div>
</body>
</html>
