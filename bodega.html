<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üç∑ La Bodega Medieval</title>
  <link rel="stylesheet" href="styles/style.css"/>
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg"/>
  <style>
    /* ============================
         Estilos Globales y Layout
       ============================ */
    body {
      font-family: Arial, sans-serif;
      background: url('images/fondo-bodega.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container {
      max-width: 960px;
      margin: auto;
      background: rgba(255,248,228,0.95);
      border: 3px double #5e3b1b;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      position: relative;
    }
    header h1 { text-align: center; }
    .action-btn {
      display: inline-block;
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      background: #dec79b;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .music-control { text-align: center; margin-bottom: 10px; }

    /* ============================
         Verificaci√≥n de Ubicaci√≥n 
       ============================ */
    #location-check {
      text-align: center;
      margin-bottom: 30px;
    }
    #location-check input {
      padding: 8px;
      font-size: 16px;
      width: 200px;
      margin: 10px;
      border: 1px solid #5e3b1b;
      border-radius: 4px;
    }
    #location-status { margin-top: 10px; font-size: 1.1em; color: red; }
    #direction-arrow { width: 50px; margin-top: 10px; }

    /* ============================
                 Carrusel
       ============================ */
    .carousel {
      position: relative;
      overflow: hidden;
      width: 100%;
      margin-bottom: 20px;
      border-radius: 10px;
      border: 2px solid #5e3b1b;
    }
    .carousel .slide {
      display: none;
      text-align: center;
    }
    .carousel .slide.active { display: block; }
    .carousel img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #6e3e2e;
    }
    .carousel .slide p {
      font-family: Georgia, serif;
      font-size: 16px;
      color: #2e2e2e;
      line-height: 1.5;
      margin: 10px auto;
      max-width: 800px;
    }
    .carousel .slide a {
      color: #5e3b1b;
      text-decoration: underline;
    }
    .carousel .slide a:hover { color: #a65c3a; }
    .carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.7);
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
    }
    .prev-slide { left: 10px; }
    .next-slide { right: 10px; }

    /* ============================
         Minijuego 1: Puzzle Arrastrable (Drag & Drop)
       ============================ */
    /* Separamos el √°rea destino y el contenedor de piezas */
    #puzzle-section {
      display: none;
      width: 400px;
      margin: 20px auto;
    }
    /* √Årea destino: cuadr√≠cula 4x4 */
    #puzzle-target {
      width: 400px;
      height: 400px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 2px;
      border: 2px dashed #aaa;
      position: relative;
    }
    .target-cell {
      border: 1px dashed #ddd;
      width: 100px;
      height: 100px;
      box-sizing: border-box;
    }
    /* Contenedor de piezas: se muestran esparcidas en un √°rea independiente */
    #pieces-container {
      width: 400px;
      height: 200px;
      position: relative;
      border: 2px solid #ccc;
      margin-top: 10px;
    }
    .puzzle-piece {
      width: 100px;
      height: 100px;
      background-image: url('images/bodega-barriles.jpeg');
      background-size: 400px 400px;
      cursor: grab;
      position: absolute;
      transition: left 0.3s ease, top 0.3s ease;
      pointer-events: auto;
    }
    .puzzle-piece.placed {
      cursor: default;
    }

    /* ============================
         Minijuegos: Quiz y Cata
       ============================ */
    #bodega-quiz, #final-game, #final-button {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    #bodega-quiz p, #final-game p {
      font-family: Georgia, serif;
      font-size: 18px;
      margin: 15px 0 8px;
    }
    #cata-options { margin: 20px 0; }
    
    /* ============================
         Footer y Adornos
       ============================ */
    footer p {
      text-align: center;
      font-size: 0.9em;
      margin-top: 20px;
    }
    .container:before {
      content: "üçá";
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 32px;
      color: #5e3b1b;
    }
    .container:after {
      content: "üç∑";
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 32px;
      color: #5e3b1b;
    }
    @media screen and (max-width: 768px) {
      .container { max-width: 90%; }
      .carousel img { height: 200px; }
      .carousel-btn { font-size: 20px; padding: 6px; }
      #puzzle-section { width: 300px; }
      #puzzle-target, #pieces-container { width: 300px; }
      #puzzle-target { height: 300px; }
      #pieces-container { height: 150px; }
      .target-cell { width: 75px; height: 75px; }
      .puzzle-piece { width: 75px; height: 75px; background-size: 300px 300px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üç∑ La Bodega Medieval</h1>
      <div class="music-control">
        <button class="action-btn music-btn" onclick="toggleMusic()">
          <span class="music-icon">üéµ</span> M√∫sica
        </button>
      </div>
    </header>

    <section id="content">
      <div class="stop-icon">üç∑</div>
      <!-- Verificaci√≥n de Ubicaci√≥n -->
      <div id="location-check">
        <h2>Verifica tu ubicaci√≥n</h2>
        <p>Ac√©rcate al escudo tallado sobre la puerta de la bodega para continuar.</p>
        <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
        <p>O escribe el nombre:</p>
        <input type="text" id="location-input" placeholder="Ej: Bodega" />
        <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
        <p id="location-status"></p>
        <img id="direction-arrow" src="images/flecha.png" class="arrow-icon" style="display: none;" />
      </div>

      <!-- Contenido del Juego: Se muestra tras verificaci√≥n -->
      <div id="game-content" style="display: none;">
        <!-- Carrusel con tres im√°genes -->
        <div class="carousel">
          <div class="slide active">
            <img src="images/bodega-barriles.jpeg" alt="Interior bodega" />
            <p>
              <strong>Interior:</strong> Conserva barricas antiguas y utensilios tradicionales. 
              <a href="https://es.wikipedia.org/wiki/Barrica" target="_blank">M√°s informaci√≥n</a>
            </p>
          </div>
          <div class="slide">
            <img src="images/bodega-cueva.jpeg" alt="Entrada bodega" />
            <p>
              <strong>Entrada:</strong> Sus muros ocultan secretos y leyendas de hace siglos. 
              <a href="https://www.labodegamedieval.es" target="_blank">M√°s informaci√≥n</a>
            </p>
          </div>
          <div class="slide">
            <img src="images/bodega-escudo.jpeg" alt="Escudo Borrado" />
            <p>
              <strong>Escudo:</strong> El escudo tallado guarda el legado de la familia de Gonzalo de la Sierra. 
              <a href="https://es.wikipedia.org/wiki/Escudo_de_armas" target="_blank">M√°s informaci√≥n</a>
            </p>
          </div>
          <button class="carousel-btn prev-slide" onclick="prevSlide()">‚Üê</button>
          <button class="carousel-btn next-slide" onclick="nextSlide()">‚Üí</button>
        </div>

        <!-- Minijuego 1: Puzzle Arrastrable -->
        <div style="text-align:center; margin-bottom:20px;">
          <button class="action-btn" onclick="startPuzzleGame()">Iniciar Puzzle</button>
        </div>
        <!-- Secci√≥n del Puzzle: √Årea destino y contenedor de piezas -->
        <div id="puzzle-section">
          <div id="puzzle-target"></div>
          <div id="pieces-container"></div>
          <p id="puzzle-status" style="text-align:center; font-family:Georgia, serif; font-size:18px;"></p>
        </div>

        <!-- Minijuego 2: Quiz de la Bodega -->
        <div id="bodega-quiz">
          <h2>üìù Quiz de la Bodega</h2>
          <p>1. ¬øCu√°ntas barricas hist√≥ricas se conservan en la bodega?</p>
          <button class="action-btn" onclick="checkQuizAnswer(1, '15')">15</button>
          <button class="action-btn" onclick="checkQuizAnswer(1, '10')">10</button>
          <button class="action-btn" onclick="checkQuizAnswer(1, '20')">20</button>
          <p id="quiz-result-1"></p>

          <p>2. ¬øCu√°l es la uva emblem√°tica utilizada en nuestros vinos?</p>
          <button class="action-btn" onclick="checkQuizAnswer(2, 'Tempranillo')">Tempranillo</button>
          <button class="action-btn" onclick="checkQuizAnswer(2, 'Cabernet Sauvignon')">Cabernet Sauvignon</button>
          <button class="action-btn" onclick="checkQuizAnswer(2, 'Garnacha')">Garnacha</button>
          <p id="quiz-result-2"></p>

          <p>3. ¬øEn qu√© regi√≥n se encuentra la bodega?</p>
          <button class="action-btn" onclick="checkQuizAnswer(3, 'La Rioja')">La Rioja</button>
          <button class="action-btn" onclick="checkQuizAnswer(3, 'Ribera del Duero')">Ribera del Duero</button>
          <button class="action-btn" onclick="checkQuizAnswer(3, 'Priorat')">Priorat</button>
          <p id="quiz-result-3"></p>
        </div>

        <!-- Minijuego Final: La Cata del Vino -->
        <div id="final-game">
          <h2>üç∑ Desaf√≠o Final: La Cata del Vino</h2>
          <p>Elige el maridaje perfecto que realza nuestro vino emblem√°tico.</p>
          <div id="cata-options">
            <button class="action-btn" onclick="checkCata('queso')">Queso curado</button>
            <button class="action-btn" onclick="checkCata('chorizo')">Chorizo ib√©rico</button>
            <button class="action-btn" onclick="checkCata('aceitunas')">Aceitunas</button>
          </div>
          <p id="cata-status"></p>
        </div>

        <!-- Bot√≥n Final -->
        <div id="final-button" style="display: none; text-align: center;">
          <button class="action-btn" onclick="finishGame()">¬°Finalizar la b√∫squeda!</button>
        </div>
      </div>
    </section>

    <footer>
      <p>¬© 2025 La Bodega Medieval | 
         <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a>
      </p>
    </footer>

    <!-- Audios -->
    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
    <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
    <audio id="coins-sound" src="sounds/coins.mp3" preload="auto"></audio>
    <audio id="background-music" src="sounds/musica-medieval.mp3" preload="auto" loop></audio>
  </div>

  <script>
    /* ============================
         Funciones de Ubicaci√≥n y Audio
       ============================ */
    function checkLocation() {
      // Simulamos √©xito inmediato para la demostraci√≥n
      document.getElementById("location-check").style.display = "none";
      document.getElementById("game-content").style.display = "block";
      playSound("background-music");
    }
    function checkLocationManual() {
      const input = document.getElementById("location-input").value.trim().toLowerCase();
      if(input === "bodega") { checkLocation(); }
      else {
        document.getElementById("location-status").textContent = "Nombre incorrecto. Int√©ntalo de nuevo.";
      }
    }
    function playSound(id) {
      const s = document.getElementById(id);
      if(s) s.play();
    }
    function toggleMusic() {
      const bg = document.getElementById('background-music');
      const btn = document.querySelector('.music-btn');
      if(bg.paused) {
        bg.play();
        btn.innerHTML = '<span class="music-icon">üéµ</span> Pausar M√∫sica';
      } else {
        bg.pause();
        btn.innerHTML = '<span class="music-icon">üîá</span> Reproducir M√∫sica';
      }
    }
    function finishGame() {
      updateRanking();
      window.location.href = "final.html?stop=bodega";
    }
    function updateRanking() {
      let ranking = JSON.parse(localStorage.getItem("ranking")) || [];
      ranking.push({ stop: "bodega", score: 100 });
      localStorage.setItem("ranking", JSON.stringify(ranking));
    }

    /* ============================
         Carrusel B√°sico
       ============================ */
    let currentSlide = 0;
    function showSlide(index) {
      const slides = document.querySelectorAll(".carousel .slide");
      if(index >= slides.length) { currentSlide = 0; }
      if(index < 0) { currentSlide = slides.length - 1; }
      slides.forEach((s, i) => { s.classList.toggle("active", i === currentSlide); });
    }
    function nextSlide() {
      currentSlide++;
      showSlide(currentSlide);
    }
    function prevSlide() {
      currentSlide--;
      showSlide(currentSlide);
    }

    /* ============================
         Minijuego 1: Puzzle Arrastrable (Drag & Drop)
       ============================ */
    function startPuzzleGame() {
      document.getElementById("puzzle-section").style.display = "block";
      document.getElementById("puzzle-status").textContent = "";
      initDragDropPuzzle();
    }
    function initDragDropPuzzle() {
      const gridSize = 4;
      const puzzleDimension = 400; // Dimensiones del √°rea destino
      const pieceSize = puzzleDimension / gridSize; // 100px por pieza

      // Limpiar √°rea destino y contenedor de piezas
      const puzzleTarget = document.getElementById("puzzle-target");
      puzzleTarget.innerHTML = "";
      const piecesContainer = document.getElementById("pieces-container");
      piecesContainer.innerHTML = "";

      // Crear la cuadr√≠cula destino (target zone)
      for (let i = 0; i < gridSize * gridSize; i++) {
         const cell = document.createElement("div");
         cell.classList.add("target-cell");
         cell.dataset.index = i;
         cell.addEventListener("dragover", function(e) {
            e.preventDefault();
         });
         cell.addEventListener("drop", function(e) {
            e.preventDefault();
            const pieceId = e.dataTransfer.getData("text/plain");
            const piece = document.querySelector(`.puzzle-piece[data-id='${pieceId}']`);
            if (!piece) return;
            // Calcular la posici√≥n de la celda relativa al contenedor destino
            const cellRect = this.getBoundingClientRect();
            const targetRect = puzzleTarget.getBoundingClientRect();
            const left = cellRect.left - targetRect.left;
            const top = cellRect.top - targetRect.top;
            piece.style.left = left + "px";
            piece.style.top = top + "px";
            piece.dataset.current = this.dataset.index;
            if(piece.dataset.id === this.dataset.index) {
               piece.classList.add("placed");
               piece.draggable = false;
            } else {
               piece.classList.remove("placed");
               piece.draggable = true;
            }
            checkPuzzleSolved();
         });
         puzzleTarget.appendChild(cell);
      }

      // Crear las piezas en el contenedor de piezas (mostrar esparcidas)
      const containerWidth = piecesContainer.clientWidth;
      const containerHeight = piecesContainer.clientHeight;
      for(let i = 0; i < gridSize * gridSize; i++){
         const piece = document.createElement("div");
         piece.classList.add("puzzle-piece");
         piece.dataset.id = i;
         const col = i % gridSize;
         const row = Math.floor(i / gridSize);
         piece.style.backgroundImage = "url('images/bodega-barriles.jpeg')";
         piece.style.backgroundSize = puzzleDimension + "px " + puzzleDimension + "px";
         piece.style.backgroundPosition = `-${col * pieceSize}px -${row * pieceSize}px`;
         // Ubicar la pieza en posici√≥n aleatoria dentro del contenedor de piezas
         const randomX = Math.floor(Math.random() * (containerWidth - pieceSize));
         const randomY = Math.floor(Math.random() * (containerHeight - pieceSize));
         piece.style.position = "absolute";
         piece.style.left = randomX + "px";
         piece.style.top = randomY + "px";
         piece.draggable = true;
         piece.addEventListener("dragstart", function(e) {
             e.dataTransfer.setData("text/plain", this.dataset.id);
             this.style.zIndex = 1000;
         });
         piece.addEventListener("dragend", function(e) {
             this.style.zIndex = "";
         });
         // Agregar manejo de eventos t√°ctiles para m√≥viles
         piece.addEventListener("touchstart", onTouchStart, false);
         piece.addEventListener("touchmove", onTouchMove, false);
         piece.addEventListener("touchend", onTouchEnd, false);
         piecesContainer.appendChild(piece);
      }
    }
    
    // Variables globales para el manejo t√°ctil
    let currentPiece = null;
    let touchOffsetX = 0;
    let touchOffsetY = 0;

    function onTouchStart(e) {
      e.preventDefault();
      currentPiece = this;
      const touch = e.touches[0];
      const rect = currentPiece.getBoundingClientRect();
      touchOffsetX = touch.clientX - rect.left;
      touchOffsetY = touch.clientY - rect.top;
      currentPiece.style.zIndex = 1000;
    }
    function onTouchMove(e) {
      e.preventDefault();
      if (!currentPiece) return;
      const touch = e.touches[0];
      // Obtener el rect√°ngulo del contenedor puzzle-section para posici√≥n relativa
      const containerRect = document.getElementById("puzzle-section").getBoundingClientRect();
      let newLeft = touch.clientX - containerRect.left - touchOffsetX;
      let newTop = touch.clientY - containerRect.top - touchOffsetY;
      currentPiece.style.left = newLeft + "px";
      currentPiece.style.top = newTop + "px";
    }
    function onTouchEnd(e) {
      e.preventDefault();
      if (!currentPiece) return;
      currentPiece.style.zIndex = "";
      // Al finalizar el toque, simular drop: determinar en qu√© celda se solt√≥ la pieza
      const containerRect = document.getElementById("puzzle-target").getBoundingClientRect();
      // Usamos la posici√≥n final de la pieza
      const pieceRect = currentPiece.getBoundingClientRect();
      const dropX = pieceRect.left + pieceRect.width / 2 - containerRect.left;
      const dropY = pieceRect.top + pieceRect.height / 2 - containerRect.top;
      const pieceSize = containerRect.width / 4; // asumiendo cuadr√≠cula 4x4
      const col = Math.floor(dropX / pieceSize);
      const row = Math.floor(dropY / pieceSize);
      const targetIndex = row * 4 + col;
      // Posicionar la pieza en la celda destino
      currentPiece.style.left = (col * pieceSize) + "px";
      currentPiece.style.top = (row * pieceSize) + "px";
      currentPiece.dataset.current = targetIndex;
      if(currentPiece.dataset.id === String(targetIndex)) {
         currentPiece.classList.add("placed");
         currentPiece.draggable = false;
      } else {
         currentPiece.classList.remove("placed");
         currentPiece.draggable = true;
      }
      checkPuzzleSolved();
      currentPiece = null;
    }
    
    function checkPuzzleSolved() {
      const pieces = document.querySelectorAll(".puzzle-piece");
      let solved = true;
      pieces.forEach(piece => {
         if(piece.dataset.current !== piece.dataset.id) {
            solved = false;
         }
      });
      if (solved) {
         document.getElementById("puzzle-status").textContent = "¬°Puzzle resuelto!";
         setTimeout(() => {
           document.getElementById("puzzle-section").style.display = "none";
           document.getElementById("bodega-quiz").style.display = "block";
         }, 1500);
      }
    }

    /* ============================
         Minijuego 2: Quiz de la Bodega
       ============================ */
    let quizAnswers = {1: "15", 2: "Tempranillo", 3: "La Rioja"};
    let quizCorrect = {1: false, 2: false, 3: false};
    function checkQuizAnswer(question, answer) {
      const resultElem = document.getElementById("quiz-result-" + question);
      if(quizAnswers[question] === answer) {
        quizCorrect[question] = true;
        resultElem.textContent = "¬°Correcto!";
        playSound("success-sound");
      } else {
        quizCorrect[question] = false;
        resultElem.textContent = "Incorrecto, intenta nuevamente.";
        playSound("error-sound");
      }
      if(quizCorrect[1] && quizCorrect[2] && quizCorrect[3]) {
        document.getElementById("bodega-quiz").style.display = "none";
        document.getElementById("final-game").style.display = "block";
      }
    }

    /* ============================
         Minijuego Final: La Cata del Vino
       ============================ */
    function checkCata(selection) {
      if(selection === "queso") {
        document.getElementById("cata-status").textContent = "¬°Excelente! El queso curado realza perfectamente nuestro vino.";
        playSound("success-sound");
        document.getElementById("final-game").style.display = "none";
        document.getElementById("final-button").style.display = "block";
      } else if(selection === "chorizo") {
        document.getElementById("cata-status").textContent = "El chorizo ib√©rico es intenso, pero no acompa√±a idealmente el vino.";
        playSound("error-sound");
      } else {
        document.getElementById("cata-status").textContent = "Esa opci√≥n no resalta el vino, intenta de nuevo.";
        playSound("error-sound");
      }
    }
  </script>
</body>
</html>
