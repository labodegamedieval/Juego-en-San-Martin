<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🙏 Ermita del Socorro</title>
  <link rel="stylesheet" href="styles/style.css"/>
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg"/>
  <style>
    /* Estilos generales (similares a otras paradas) */
    body {
      font-family: 'Georgia', serif;
      background: url('images/pergamino.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 960px;
      margin: auto;
      background: rgba(255,248,228,0.95);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    /* Sección de desbloqueo */
    #location-check {
      text-align: center;
      margin-bottom: 30px;
    }
    #location-check h2 { margin-bottom: 10px; }
    #location-check p { margin: 10px 0; }
    #location-input {
      padding: 8px;
      font-size: 16px;
      width: 200px;
      margin: 10px;
    }
    #location-status {
      margin-top: 10px;
      font-size: 1.1em;
      color: red;
    }
    #direction-arrow {
      width: 50px;
      margin-top: 10px;
    }
    /* Carrusel */
    .carousel-container {
      position: relative;
      overflow: hidden;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 10px;
    }
    .carousel-slides {
      display: flex;
      transition: transform 0.5s ease;
    }
    .carousel-slide {
      min-width: 100%;
      box-sizing: border-box;
      text-align: center;
    }
    .carousel-slide img {
      width: 100%;
      height: 300px; /* Tamaño fijo para todas las imágenes */
      object-fit: cover;
      display: block;
      border-radius: 10px;
      border: 2px solid #6b3e2e;
    }
    .carousel-slide p {
      font-style: italic;
      margin-top: 10px;
    }
    .carousel-prev,
    .carousel-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.7);
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
    }
    .carousel-prev { left: 10px; }
    .carousel-next { right: 10px; }
    h2 { margin-top: 10px; }
    /* Sección Reto Pacman */
    #pacman-game-section {
      background-color: black;
      padding: 20px;
      margin: 30px auto;
      max-width: 600px;
      border: 2px dashed #5e3b1b;
      border-radius: 10px;
      text-align: center;
    }
    /* Estilos propios del juego Pacman (aplicados solo dentro de #pacman-game-section) */
    #pacman-game-section #shim {
      font-family: 'Permanent Marker', cursive;
      position: absolute;
      visibility: hidden;
    }
    #pacman-game-section h1 {
      font-family: 'Permanent Marker', cursive;
      text-align: center;
      color: yellow;
    }
    #pacman-game-section a {
      text-decoration: none;
      color: #0000FF;
    }
    #pacman-game-section #pacman {
      height: 470px;
      width: 382px;
      border-radius: 5px;
      margin: 20px auto;
    }
    /* Fragmento y Pista (similares a otras paradas) */
    .fragmento-final {
      margin: 20px auto;
      display: none;
      max-width: 600px;
      text-align: center;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      padding: 40px 20px;
      font-style: italic;
      font-size: 1.4em;
      font-weight: bold;
      border: none;
      border-radius: 10px;
    }
    .pista-box {
      margin: 30px auto;
      display: none;
      max-width: 600px;
      text-align: center;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      padding: 80px 40px;
      border-radius: 10px;
      font-style: italic;
      font-size: 1.1em;
      line-height: 1.8;
      font-weight: bold;
    }
    .action-btn {
      display: block;
      margin: 15px auto;
      padding: 10px 20px;
      font-size: 16px;
      background: #dec79b;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      cursor: pointer;
    }
    @media screen and (max-width: 768px) {
      .pista-box, .fragmento-final, #pacman-game-section {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sección de desbloqueo -->
    <div id="location-check">
      <h2>Verifica tu ubicación</h2>
      <p>Acércate a la puerta de la ermita para continuar.</p>
      <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
      <p>O escribe el nombre:</p>
      <input type="text" id="location-input" placeholder="Ej: Ermita" />
      <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
      <p id="location-status"></p>
      <img id="direction-arrow" src="images/flecha.png" class="arrow-icon" style="display: none;" alt="Flecha de dirección" />
    </div>
    
    <!-- Contenido oculto hasta el desbloqueo -->
    <div id="game-content" style="display: none;">
      <!-- Carrusel integrado -->
      <div class="carousel-container">
        <div class="carousel-slides">
          <div class="carousel-slide">
            <img src="images/ermita-exterior.jpg" alt="Ermita" />
            <p><strong>Exterior:</strong> Ermita del siglo XV junto al río Canderuelo, lugar de recogimiento.</p>
          </div>
          <div class="carousel-slide">
            <img src="images/ermita-puerta.jpg" alt="Puerta" />
            <p><strong>Entrada:</strong> En honor a San Sebastián y la Virgen del Socorro. <a href="http://www.sanmartindelcastañar.es/" target="_blank">Más info</a></p>
          </div>
        </div>
        <button class="carousel-prev">&#10094;</button>
        <button class="carousel-next">&#10095;</button>
      </div>

      <!-- Nuevo reto: Juego HTML5 Pacman -->
      <div id="pacman-game-section">
        <div id="shim">shim for font face</div>
        <h1>HTML5 Pacman</h1>
        <p><a href="https://github.com/daleharvey/pacman" target="_blank">Credits: https://github.com/daleharvey/pacman</a></p>
        <div id="pacman"></div>
        <!-- Botón para finalizar el reto, se supone que el jugador ha completado la prueba (puedes integrar detección interna) -->
        <button class="action-btn" onclick="completeStop()">He completado el reto de Pacman</button>
      </div>

      <!-- Fragmento final (se muestra al completar el reto y/o el juego) -->
      <div class="fragmento-final" id="fragmento-final">
        <p><strong>Fragmento del Mensaje:</strong><br>
          <span id="message-piece" style="font-size:1.4em">sin</span>
        </p>
        <p><strong>QR en el pueblo:</strong> ERMITA-1500</p>
        <p><strong>Dato Curioso:</strong> En tiempos antiguos, los vecinos subían con velas encendidas a pedir protección.</p>
      </div>

      <div id="continue-button" style="display: none; text-align: center;">
        <button class="action-btn" onclick="location.href='felicitaciones.html?stop=ermita'">Continuar búsqueda</button>
      </div>
    </div>
  </div>

  <!-- Audios -->
  <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
  <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
  <audio id="cheers-sound" src="sounds/cheers.mp3" preload="auto"></audio>
  <audio id="background-music" src="sounds/musica-medieval.mp3" preload="auto" loop></audio>

  <!-- Nuestro script de la parada (desbloqueo, carrusel, ranking, crónica, etc.) -->
  <script>
    // Variables para el reto (en este caso, el juego Pacman) y finalización
    let challengeCompleted = false;
    // Función que marca la parada como completada
    function completeStop() {
      document.getElementById("feedback").textContent = "🎶 ¡Reto de Pacman completado!";
      document.getElementById("fragmento-final").style.display = "block";
      document.getElementById("continue-button").style.display = "block";
      document.getElementById("background-music").play();
      localStorage.setItem("ermita-completed", "true");
      updateChronicle();
      updateRanking();
      challengeCompleted = true;
    }

    // Actualizar la crónica guardando el fragmento descubierto ("sin")
    function updateChronicle() {
      localStorage.setItem("cronica_ermita", document.getElementById("message-piece").textContent);
      console.log("Crónica actualizada con el fragmento:", document.getElementById("message-piece").textContent);
    }

    // Actualizar el ranking con el progreso (se usa el nombre ya obtenido de index)
    function updateRanking() {
      const username = localStorage.getItem("username");
      if (!username) {
        console.error("No se encontró el nombre del usuario.");
        return;
      }
      let ranking = JSON.parse(localStorage.getItem("ranking")) || [];
      ranking.push({ stop: "ermita", fragmento: document.getElementById("message-piece").textContent, name: username });
      localStorage.setItem("ranking", JSON.stringify(ranking));
      console.log("Ranking actualizado:", ranking);
    }

    // MÉTODOS DE DESBLOQUEO POR GPS, MANUAL Y QR
    const targetLat = 40.123456;    // Reemplaza con la latitud real de la Ermita
    const targetLon = -3.123456;     // Reemplaza con la longitud real de la Ermita
    const thresholdDistance = 50;    // Distancia en metros permitida

    function checkLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(geoSuccess, locationError);
      } else {
        document.getElementById("location-status").textContent = "Tu navegador no soporta geolocalización.";
      }
    }

    function geoSuccess(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const distance = calculateDistance(lat, lon, targetLat, targetLon);
      if (distance <= thresholdDistance) {
        unlockStop();
      } else {
        document.getElementById("location-status").textContent = "No estás lo suficientemente cerca de la Ermita.";
      }
    }

    function locationError(err) {
      document.getElementById("location-status").textContent = "Error al obtener tu ubicación: " + err.message;
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = (x) => x * Math.PI / 180;
      const φ1 = toRad(lat1);
      const φ2 = toRad(lat2);
      const Δφ = toRad(lat2 - lat1);
      const Δλ = toRad(lon2 - lon1);
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function checkLocationManual() {
      const input = document.getElementById("location-input").value.trim().toLowerCase();
      if (input === "ermita" || input === "ermita del socorro") {
        unlockStop();
      } else {
        document.getElementById("location-status").textContent = "Nombre incorrecto. Inténtalo nuevamente.";
      }
    }

    function unlockStop() {
      document.getElementById("location-check").style.display = "none";
      document.getElementById("game-content").style.display = "block";
    }

    window.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      if(urlParams.get("stop") === "ermita" || urlParams.has("unlock")) {
        unlockStop();
      }
    });

    // Carrusel
    let currentSlide = 0;
    const slides = document.querySelectorAll('.carousel-slide');
    document.querySelector('.carousel-prev').addEventListener('click', () => {
      currentSlide = (currentSlide > 0) ? currentSlide - 1 : slides.length - 1;
      updateCarousel();
    });
    document.querySelector('.carousel-next').addEventListener('click', () => {
      currentSlide = (currentSlide < slides.length - 1) ? currentSlide + 1 : 0;
      updateCarousel();
    });
    function updateCarousel() {
      const carouselSlides = document.querySelector('.carousel-slides');
      carouselSlides.style.transform = 'translateX(' + (-currentSlide * 100) + '%)';
    }
  </script>

  <!-- PACMAN GAME: Integración del juego HTML5 Pacman -->
  <!-- Se usa la estructura y estilos propios del juego -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- Se asume que Modernizr está incluido o disponible -->
  <script>
    // Verifica si el navegador soporta canvas, localStorage y audio
    $(function(){
      var el = document.getElementById("pacman");
      if (Modernizr.canvas && Modernizr.localstorage && Modernizr.audio && (Modernizr.audio.ogg || Modernizr.audio.mp3)) {
        // Inicia el juego usando la URL de GitHub de PACMAN (ajusta según sea necesario)
        window.setTimeout(function () { PACMAN.init(el, "https://raw.githubusercontent.com/daleharvey/pacman/master/"); }, 0);
      } else {
        el.innerHTML = "Sorry, necesitas un navegador decente<br /><small>(Firefox 3.6+, Chrome 4+, Opera 10+ y Safari 4+)</small>";
      }
    });
  </script>
  <!-- Incluir el código completo de PACMAN (JS) a continuación o desde un archivo externo -->
  <script>
    /* Inserta aquí el código JS completo del juego Pacman, 
       que fue proporcionado (el código que gestiona el juego) 
       Por motivos de extensión se omite aquí su contenido completo.
       Asegúrate de que el objeto global PACMAN esté correctamente definido. */
  </script>
</body>
</html>
