<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>游똂 Ermita del Socorro</title>
  <link rel="stylesheet" href="styles/style.css"/>
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg"/>
  <style>
    body {
      font-family: 'Georgia', serif;
      background: url('images/pergamino.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 960px;
      margin: auto;
      background: rgba(255,248,228,0.95);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    #location-check {
      text-align: center;
      margin-bottom: 30px;
    }
    #location-check h2 { margin-bottom: 10px; }
    #location-check p { margin: 10px 0; }
    #location-input {
      padding: 8px;
      font-size: 16px;
      width: 200px;
      margin: 10px;
    }
    #location-status {
      margin-top: 10px;
      font-size: 1.1em;
      color: red;
    }
    #direction-arrow {
      width: 50px;
      margin-top: 10px;
    }
    .carousel-container {
      position: relative;
      overflow: hidden;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 10px;
    }
    .carousel-slides {
      display: flex;
      transition: transform 0.5s ease;
    }
    .carousel-slide {
      min-width: 100%;
      box-sizing: border-box;
      text-align: center;
    }
    .carousel-slide img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      display: block;
      border-radius: 10px;
      border: 2px solid #6b3e2e;
    }
    .carousel-slide p {
      font-style: italic;
      margin-top: 10px;
    }
    .carousel-prev, .carousel-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.7);
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
    }
    .carousel-prev { left: 10px; }
    .carousel-next { right: 10px; }
    h2 { margin-top: 10px; }
    #letter-soup-container {
      margin: 30px auto;
      max-width: 600px;
      text-align: center;
    }
    #letter-soup-container table {
      border-collapse: collapse;
      margin: auto;
    }
    #letter-soup-container td {
      border: 1px solid #5e3b1b;
      width: 30px;
      height: 30px;
      text-align: center;
      vertical-align: middle;
      font-size: 18px;
      cursor: pointer;
      user-select: none;
    }
    .selected {
      background-color: yellow !important;
    }
    .found {
      background-color: lightgreen !important;
    }
    #word-list {
      margin: 15px auto;
      max-width: 600px;
      text-align: left;
      font-size: 16px;
    }
    #word-list ul {
      list-style-type: none;
      padding: 0;
    }
    #word-list li {
      padding: 5px;
      border-bottom: 1px solid #ccc;
    }
    .word-found {
      text-decoration: line-through;
      color: green;
    }
    #crossword-hint {
      display: none;
      text-align: center;
      margin: 20px auto;
      max-width: 600px;
      padding: 10px;
      font-style: italic;
      font-size: 1.1em;
      color: #5e3b1b;
    }
    #crossword-hint img {
      width: 40px;
      vertical-align: middle;
      margin: 0 5px;
    }
    .fragmento-final {
      margin: 20px auto;
      display: none;
      max-width: 600px;
      text-align: center;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      padding: 40px 20px;
      font-style: italic;
      font-size: 1.4em;
      font-weight: bold;
      border: none;
      border-radius: 10px;
    }
    .pista-box {
      margin: 30px auto;
      display: none;
      max-width: 600px;
      text-align: center;
      background: url('images/pergamino.png') center center no-repeat;
      background-size: cover;
      padding: 80px 40px;
      border-radius: 10px;
      font-style: italic;
      font-size: 1.1em;
      line-height: 1.8;
      font-weight: bold;
    }
    .action-btn {
      display: block;
      margin: 15px auto;
      padding: 10px 20px;
      font-size: 16px;
      background: #dec79b;
      border: 2px solid #5e3b1b;
      border-radius: 10px;
      cursor: pointer;
    }
    @media screen and (max-width: 768px) {
      #letter-soup-container, #word-list, #crossword-hint, .pista-box, .fragmento-final {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="location-check">
      <h2>Verifica tu ubicaci칩n</h2>
      <p>Ac칠rcate a la puerta de la ermita para continuar.</p>
      <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
      <p>O escribe el nombre:</p>
      <input type="text" id="location-input" placeholder="Ej: Ermita" />
      <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
      <p id="location-status"></p>
      <img id="direction-arrow" src="images/flecha.png" class="arrow-icon" style="display: none;" alt="Flecha de direcci칩n" />
    </div>
    <div id="game-content" style="display: none;">
      <div class="carousel-container">
        <div class="carousel-slides">
          <div class="carousel-slide">
            <img src="images/ermita-exterior.jpg" alt="Ermita Exterior" />
            <p><strong>Exterior:</strong> Ermita del siglo XV junto al r칤o Canderuelo. <a href="http://www.ermitadelsocorro.es/exterior" target="_blank">M치s info</a></p>
          </div>
          <div class="carousel-slide">
            <img src="images/ermita-puerta.jpg" alt="Puerta de la Ermita" />
            <p><strong>Entrada:</strong> En honor a San Sebasti치n y la Virgen del Socorro. <a href="http://www.ermitadelsocorro.es/entrada" target="_blank">M치s info</a></p>
          </div>
          <div class="carousel-slide">
            <img src="images/ermita-interior.jpg" alt="Interior de la Ermita" />
            <p><strong>Interior:</strong> Descubre detalles hist칩ricos y ornamentales del templo. <a href="http://www.ermitadelsocorro.es/interior" target="_blank">M치s info</a></p>
          </div>
        </div>
        <button class="carousel-prev">&#10094;</button>
        <button class="carousel-next">&#10095;</button>
      </div>
      <div id="crossword-section">
        <h2>Crucigrama Romano</h2>
        <p>Resuelve el crucigrama respondiendo las siguientes pistas. Completa las 4 palabras.</p>
        <div class="clue">
          <p><span>1.</span> (Horizontal) Camino romano que conectaba ciudades y facilitaba el comercio.</p>
          <input type="text" id="answer1" class="answer-input" placeholder="Respuesta 1" />
        </div>
        <div class="clue">
          <p><span>2.</span> (Vertical) Objeto funerario romano, inscrito en bronce, que conmemoraba al difunto.</p>
          <input type="text" id="answer2" class="answer-input" placeholder="Respuesta 2" />
        </div>
        <div class="clue">
          <p><span>3.</span> (Horizontal) Peque침o templo de culto, modesto y tradicional.</p>
          <input type="text" id="answer3" class="answer-input" placeholder="Respuesta 3" />
        </div>
        <div class="clue">
          <p><span>4.</span> (Vertical) Adjetivo que describe lo relacionado con la antigua Roma.</p>
          <input type="text" id="answer4" class="answer-input" placeholder="Respuesta 4" />
        </div>
        <button class="action-btn" onclick="checkCrossword()">Comprobar crucigrama</button>
        <button class="action-btn" onclick="toggleHint()">Ver pista</button>
        <div id="crossword-hint">
          <p>Iconos: <img src="images/icono-espada.png" alt="Espada"> <img src="images/icono-coliseo.png" alt="Coliseo"> <img src="images/icono-via.png" alt="V칤a Romana"> <img src="images/icono-estela.png" alt="Estela"></p>
          <p>Consejo: Relaciona las pistas con s칤mbolos y elementos del mundo romano.</p>
        </div>
      </div>
      <div class="fragmento-final" id="fragmento-final">
        <p><strong>Fragmento del Mensaje:</strong><br>
          <span id="message-piece" style="font-size:1.4em">sin</span>
        </p>
        <p><strong>QR en el pueblo:</strong> ERMITA-1500</p>
        <p><strong>Dato Curioso:</strong> En tiempos antiguos, los vecinos sub칤an con velas encendidas a pedir protecci칩n.</p>
      </div>
      <div id="continue-button" style="display: none; text-align: center;">
        <button class="action-btn" onclick="location.href='felicitaciones.html?stop=ermita'">Continuar b칰squeda</button>
      </div>
    </div>
  </div>
  <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
  <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
  <audio id="cheers-sound" src="sounds/cheers.mp3" preload="auto"></audio>
  <audio id="background-music" src="sounds/musica-medieval.mp3" preload="auto" loop></audio>
  <script>
    let challengeCompleted = false;
    const correctAnswers = { answer1: "calzada", answer2: "estela", answer3: "ermita", answer4: "romana" };
    function toggleHint() {
      const hint = document.getElementById("crossword-hint");
      hint.style.display = (hint.style.display === "none" || hint.style.display === "") ? "block" : "none";
    }
    function checkCrossword() {
      let allCorrect = true;
      for (const key in correctAnswers) {
        const userAnswer = document.getElementById(key).value.trim().toLowerCase();
        if (userAnswer !== correctAnswers[key]) { allCorrect = false; break; }
      }
      if (allCorrect) { completeStop(); }
      else { playSound("error-sound"); alert("Alguna de las respuestas es incorrecta. Revisa tus respuestas y vuelve a intentarlo."); }
    }
    function playSound(id) {
      const sound = document.getElementById(id);
      if (sound) { sound.play(); }
    }
    function completeStop() {
      document.getElementById("fragmento-final").style.display = "block";
      document.getElementById("continue-button").style.display = "block";
      playSound("cheers-sound");
      localStorage.setItem("ermita-completed", "true");
      updateChronicle();
      updateRanking();
      challengeCompleted = true;
    }
    function updateChronicle() {
      localStorage.setItem("cronica_ermita", document.getElementById("message-piece").textContent);
      console.log("Cr칩nica actualizada con el fragmento:", document.getElementById("message-piece").textContent);
    }
    function updateRanking() {
      const username = localStorage.getItem("username");
      if (!username) { console.error("No se encontr칩 el nombre del usuario."); return; }
      let ranking = JSON.parse(localStorage.getItem("ranking")) || [];
      ranking.push({ stop: "ermita", fragmento: document.getElementById("message-piece").textContent, name: username });
      localStorage.setItem("ranking", JSON.stringify(ranking));
      console.log("Ranking actualizado:", ranking);
    }
    const targetLat = 40.123456;
    const targetLon = -3.123456;
    const thresholdDistance = 50;
    function checkLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(geoSuccess, locationError);
      } else {
        document.getElementById("location-status").textContent = "Tu navegador no soporta geolocalizaci칩n.";
      }
    }
    function geoSuccess(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const distance = calculateDistance(lat, lon, targetLat, targetLon);
      if (distance <= thresholdDistance) { unlockStop(); }
      else { document.getElementById("location-status").textContent = "No est치s lo suficientemente cerca de la Ermita."; }
    }
    function locationError(err) {
      document.getElementById("location-status").textContent = "Error al obtener tu ubicaci칩n: " + err.message;
    }
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = (x) => x * Math.PI / 180;
      const 픥1 = toRad(lat1), 픥2 = toRad(lat2);
      const 풊픥 = toRad(lat2 - lat1), 풊풭 = toRad(lon2 - lon1);
      const a = Math.sin(풊픥/2) ** 2 + Math.cos(픥1) * Math.cos(픥2) * Math.sin(풊풭/2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    function checkLocationManual() {
      const input = document.getElementById("location-input").value.trim().toLowerCase();
      if (input === "ermita" || input === "ermita del socorro") { unlockStop(); }
      else { document.getElementById("location-status").textContent = "Nombre incorrecto. Int칠ntalo nuevamente."; }
    }
    function unlockStop() {
      document.getElementById("location-check").style.display = "none";
      document.getElementById("game-content").style.display = "block";
      initLetterSoup();
    }
    window.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      if(urlParams.get("stop") === "ermita" || urlParams.has("unlock")) { unlockStop(); }
    });
    let currentSlide = 0;
    const slides = document.querySelectorAll('.carousel-slide');
    document.querySelector('.carousel-prev').addEventListener('click', () => {
      currentSlide = (currentSlide > 0) ? currentSlide - 1 : slides.length - 1;
      updateCarousel();
    });
    document.querySelector('.carousel-next').addEventListener('click', () => {
      currentSlide = (currentSlide < slides.length - 1) ? currentSlide + 1 : 0;
      updateCarousel();
    });
    function updateCarousel() {
      const carouselSlides = document.querySelector('.carousel-slides');
      carouselSlides.style.transform = 'translateX(' + (-currentSlide * 100) + '%)';
    }
    const gridRows = 12, gridCols = 12;
    let letterGrid = [];
    const targetWords = { calzada: false, estela: false, ermita: false, romana: false };
    function initLetterSoup() {
      letterGrid = new Array(gridRows);
      for (let i = 0; i < gridRows; i++) {
        letterGrid[i] = new Array(gridCols).fill('');
      }
      insertWord("calzada", 2, 2, 0, 1);
      insertWord("estela", 4, 4, 1, 0);
      insertWord("ermita", 6, 0, 1, 1);
      insertWord("romana", 10, 6, 0, 1);
      fillRandomLetters();
      drawLetterSoup();
      updateWordList();
    }
    function insertWord(word, row, col, dr, dc) {
      word = word.toLowerCase();
      for (let i = 0; i < word.length; i++) {
        if (row < gridRows && col < gridCols) {
          letterGrid[row][col] = word[i];
          row += dr;
          col += dc;
        }
      }
    }
    function fillRandomLetters() {
      const letters = "abcdefghijklmnopqrstuvwxyz";
      for (let i = 0; i < gridRows; i++) {
        for (let j = 0; j < gridCols; j++) {
          if (letterGrid[i][j] === "") {
            letterGrid[i][j] = letters.charAt(Math.floor(Math.random() * letters.length));
          }
        }
      }
    }
    function drawLetterSoup() {
      const container = document.getElementById("letter-soup-container");
      container.innerHTML = "";
      const table = document.createElement("table");
      for (let i = 0; i < gridRows; i++) {
        const tr = document.createElement("tr");
        for (let j = 0; j < gridCols; j++) {
          const td = document.createElement("td");
          td.textContent = letterGrid[i][j].toUpperCase();
          td.setAttribute("data-row", i);
          td.setAttribute("data-col", j);
          td.addEventListener("mousedown", handleMouseDown);
          td.addEventListener("mouseover", handleMouseOver);
          td.addEventListener("mouseup", handleMouseUp);
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }
      container.appendChild(table);
      document.addEventListener("mouseup", handleMouseUp);
    }
    let isMouseDown = false;
    let selectedCells = [];
    let startCell = null;
    let currentDirection = null;
    function handleMouseDown(e) {
      isMouseDown = true;
      selectedCells = [];
      const tds = document.querySelectorAll("#letter-soup-container td");
      tds.forEach(td => td.classList.remove("selected"));
      startCell = { row: parseInt(this.getAttribute("data-row")), col: parseInt(this.getAttribute("data-col")) };
      selectedCells.push(startCell);
      this.classList.add("selected");
    }
    function handleMouseOver(e) {
      if (!isMouseDown) return;
      const row = parseInt(this.getAttribute("data-row"));
      const col = parseInt(this.getAttribute("data-col"));
      const last = selectedCells[selectedCells.length - 1];
      const dRow = row - last.row;
      const dCol = col - last.col;
      if (Math.abs(dRow) <= 1 && Math.abs(dCol) <= 1 && (Math.abs(dRow) + Math.abs(dCol) !== 0)) {
        if (selectedCells.length === 1) { currentDirection = { dRow: dRow, dCol: dCol }; }
        else { if (dRow !== currentDirection.dRow || dCol !== currentDirection.dCol) return; }
        if (!selectedCells.some(cell => cell.row === row && cell.col === col)) {
          selectedCells.push({ row: row, col: col });
          this.classList.add("selected");
        }
      }
    }
    function handleMouseUp(e) {
      if (!isMouseDown) return;
      isMouseDown = false;
      let word = "";
      selectedCells.forEach(cell => { word += letterGrid[cell.row][cell.col]; });
      word = word.toLowerCase();
      for (let target in targetWords) {
        if (!targetWords[target] && (word === target || word.split("").reverse().join("") === target)) {
          targetWords[target] = true;
          markCellsAsFound(selectedCells);
          updateWordList();
          playSound("success-sound");
          break;
        }
      }
      const tds = document.querySelectorAll("#letter-soup-container td");
      tds.forEach(td => td.classList.remove("selected"));
      selectedCells = [];
      if (Object.values(targetWords).every(val => val === true)) { completeStop(); }
    }
    function markCellsAsFound(cells) {
      cells.forEach(cell => {
        const selector = `td[data-row="${cell.row}"][data-col="${cell.col}"]`;
        const td = document.querySelector(selector);
        if (td) { td.classList.add("found"); }
      });
    }
    function updateWordList() {
      const list = document.getElementById("word-list");
      for (let word in targetWords) {
        const li = document.getElementById("w-" + word);
        if (li) { if (targetWords[word]) { li.classList.add("word-found"); } else { li.classList.remove("word-found"); } }
      }
    }
    function checkAllWords() {
      if (Object.values(targetWords).every(val => val === true)) { completeStop(); }
      else { alert("A칰n faltan palabras por encontrar. 춰Sigue buscando!"); }
    }
  </script>
  <script>
    let currentSlide = 0;
    const slides = document.querySelectorAll('.carousel-slide');
    document.querySelector('.carousel-prev').addEventListener('click', () => {
      currentSlide = (currentSlide > 0) ? currentSlide - 1 : slides.length - 1;
      updateCarousel();
    });
    document.querySelector('.carousel-next').addEventListener('click', () => {
      currentSlide = (currentSlide < slides.length - 1) ? currentSlide + 1 : 0;
      updateCarousel();
    });
    function updateCarousel() {
      const carouselSlides = document.querySelector('.carousel-slides');
      carouselSlides.style.transform = 'translateX(' + (-currentSlide * 100) + '%)';
    }
  </script>
  <script>
    let challengeCompleted = false;
    function completeStop() {
      document.getElementById("fragmento-final").style.display = "block";
      document.getElementById("continue-button").style.display = "block";
      playSound("cheers-sound");
      localStorage.setItem("ermita-completed", "true");
      updateChronicle();
      updateRanking();
      challengeCompleted = true;
    }
    function updateChronicle() {
      localStorage.setItem("cronica_ermita", document.getElementById("message-piece").textContent);
      console.log("Cr칩nica actualizada con el fragmento:", document.getElementById("message-piece").textContent);
    }
    function updateRanking() {
      const username = localStorage.getItem("username");
      if (!username) { console.error("No se encontr칩 el nombre del usuario."); return; }
      let ranking = JSON.parse(localStorage.getItem("ranking")) || [];
      ranking.push({ stop: "ermita", fragmento: document.getElementById("message-piece").textContent, name: username });
      localStorage.setItem("ranking", JSON.stringify(ranking));
      console.log("Ranking actualizado:", ranking);
    }
    function playSound(id) {
      const sound = document.getElementById(id);
      if (sound) { sound.play(); }
    }
    const targetLat = 40.123456;
    const targetLon = -3.123456;
    const thresholdDistance = 50;
    function checkLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(geoSuccess, locationError);
      } else {
        document.getElementById("location-status").textContent = "Tu navegador no soporta geolocalizaci칩n.";
      }
    }
    function geoSuccess(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const distance = calculateDistance(lat, lon, targetLat, targetLon);
      if (distance <= thresholdDistance) { unlockStop(); }
      else { document.getElementById("location-status").textContent = "No est치s lo suficientemente cerca de la Ermita."; }
    }
    function locationError(err) {
      document.getElementById("location-status").textContent = "Error al obtener tu ubicaci칩n: " + err.message;
    }
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = (x) => x * Math.PI / 180;
      const 픥1 = toRad(lat1), 픥2 = toRad(lat2);
      const 풊픥 = toRad(lat2 - lat1), 풊풭 = toRad(lon2 - lon1);
      const a = Math.sin(풊픥/2) ** 2 + Math.cos(픥1) * Math.cos(픥2) * Math.sin(풊풭/2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    function checkLocationManual() {
      const input = document.getElementById("location-input").value.trim().toLowerCase();
      if (input === "ermita" || input === "ermita del socorro") { unlockStop(); }
      else { document.getElementById("location-status").textContent = "Nombre incorrecto. Int칠ntalo nuevamente."; }
    }
    function unlockStop() {
      document.getElementById("location-check").style.display = "none";
      document.getElementById("game-content").style.display = "block";
      initLetterSoup();
    }
    window.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      if(urlParams.get("stop") === "ermita" || urlParams.has("unlock")) { unlockStop(); }
    });
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script>
    $(function(){
      var el = document.getElementById("pacman");
      if(Modernizr.canvas && Modernizr.localstorage && Modernizr.audio && (Modernizr.audio.ogg || Modernizr.audio.mp3)) {
        window.setTimeout(function () { PACMAN.init(el, "https://raw.githubusercontent.com/daleharvey/pacman/master/"); }, 0);
      } else {
        el.innerHTML = "Sorry, necesitas un navegador decente<br /><small>(Firefox 3.6+, Chrome 4+, Opera 10+ y Safari 4+)</small>";
      }
    });
  </script>
</body>
</html>
