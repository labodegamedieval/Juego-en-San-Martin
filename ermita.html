<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üôè Ermita del Socorro</title>
  <link rel="stylesheet" href="styles/style.css"/>
  <link rel="icon" type="image/jpeg" href="images/escudo-borrado.jpg"/>
  <style>
    .puzzle-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 3px;
      width: 300px;
      height: 300px;
      margin: 20px auto;
    }

    .puzzle-piece {
      background-image: url('images/A_small_medieval_stone_chapel_(hermitage)_in_a_pea.png');
      background-size: 300px 300px;
      width: 100px;
      height: 100px;
      cursor: pointer;
      box-shadow: 0 0 2px rgba(0,0,0,0.3);
      border-radius: 4px;
    }

    .puzzle-piece.empty {
      background: #f8f0e3;
      cursor: default;
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üôè Ermita del Socorro</h1>
      <div class="music-control">
        <button class="music-btn"><span class="music-icon">üéµ</span> M√∫sica</button>
      </div>
    </header>

    <section id="content">
      <div class="stop-icon">üôè</div>

      <div id="location-check">
        <h2>Verifica tu ubicaci√≥n</h2>
        <p>Ac√©rcate al p√≥rtico de la ermita para continuar.</p>
        <button class="action-btn" onclick="checkLocation()">Verificar GPS</button>
        <p>O escribe el nombre:</p>
        <input type="text" id="location-input" placeholder="Ej: Ermita" />
        <button class="action-btn" onclick="checkLocationManual()">Verificar Manual</button>
        <p id="location-status"></p>
        <img id="direction-arrow" src="images/flecha.png" class="arrow-icon" style="display: none;" />
      </div>

      <div id="game-content" style="display: none;">
        <div class="carousel">
          <div class="slide active">
            <img src="images/ermita-exterior.jpg" alt="Ermita" />
            <p><strong>Exterior:</strong> Edificio de piedra del siglo XV junto al r√≠o Canderuelo.</p>
          </div>
          <div class="slide">
            <img src="images/ermita-puerta.jpg" alt="Puerta de la ermita" />
            <p><strong>Entrada:</strong> Lugar de oraci√≥n dedicado a la Virgen del Socorro. <a href="http://www.sanmartindelcastanar.es/" target="_blank">M√°s info</a></p>
          </div>
          <button class="carousel-btn prev-slide">‚Üê</button>
          <button class="carousel-btn next-slide">‚Üí</button>
        </div>

        <div class="quiz">
          <h2>üß© Puzzle de la Ermita</h2>
          <p>Ordena las piezas hasta recomponer la imagen completa.</p>
          <div class="puzzle-board" id="puzzle-board"></div>
          <p id="puzzle-feedback" style="margin-top:10px;"></p>
        </div>

        <div class="fragmento-final">
          <p><strong>Fragmento del Mensaje:</strong> <span id="message-piece" style="display:none;">sin</span></p>
          <p><strong>QR en el pueblo:</strong> ERMITA-1500</p>
          <p><strong>Dato Curioso:</strong> En √©poca de sequ√≠a, los vecinos llevaban agua bendita desde esta ermita hasta el r√≠o.</p>
        </div>

        <div id="continue-button" style="display: none;">
          <button class="action-btn" onclick="location.href='felicitaciones.html?stop=ermita'">Continuar b√∫squeda</button>
        </div>
      </div>
    </section>

    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
    <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
    <audio id="cheers-sound" src="sounds/cheers.mp3" preload="auto"></audio>
    <audio id="background-music" src="sounds/musica-medieval.mp3" preload="auto" loop></audio>

    <footer>
      <p>¬© 2025 La Bodega Medieval |
        <a href="https://www.labodegamedieval.es" target="_blank">Reserva tu visita</a>
      </p>
    </footer>

    <script src="scripts/script.js"></script>
    <script>
      const board = document.getElementById("puzzle-board");
      let tiles = [];

      function initPuzzle() {
        tiles = Array.from({ length: 8 }, (_, i) => i);
        tiles.push("empty");
        shuffle(tiles);
        renderPuzzle();
      }

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      function renderPuzzle() {
        board.innerHTML = "";
        tiles.forEach((tile, index) => {
          const div = document.createElement("div");
          div.className = tile === "empty" ? "puzzle-piece empty" : "puzzle-piece";
          if (tile !== "empty") {
            const x = tile % 3;
            const y = Math.floor(tile / 3);
            div.style.backgroundPosition = `-${x * 100}px -${y * 100}px`;
          }
          div.dataset.index = index;
          div.addEventListener("click", () => moveTile(index));
          board.appendChild(div);
        });
      }

      function moveTile(index) {
        const emptyIndex = tiles.indexOf("empty");
        const neighbors = [index - 1, index + 1, index - 3, index + 3];
        if (neighbors.includes(emptyIndex)) {
          [tiles[index], tiles[emptyIndex]] = [tiles[emptyIndex], tiles[index]];
          renderPuzzle();
          checkWin();
        }
      }

      function checkWin() {
        const solved = tiles.slice(0, 8).every((val, idx) => val === idx);
        if (solved) {
          document.getElementById("puzzle-feedback").textContent = "‚úÖ Puzzle completado correctamente.";
          document.getElementById("message-piece").style.display = "inline";
          document.getElementById("continue-button").style.display = "block";
          localStorage.setItem("ermita-completed", "true");
          playSound("cheers-sound");
        }
      }

      document.addEventListener("DOMContentLoaded", initPuzzle);
    </script>
</body>
</html>
